<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3QMGWMD9KZ"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 gtag('config', 'G-3QMGWMD9KZ');
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MT academy</title>
<meta name="description" content="Interactive mock trial practice tools, objection drills, rule explanations, and quizzes to help students and coaches sharpen courtroom skills.">
<meta name="keywords" content="mock trial, mock trial practice, mock trial resources, mock trial quizzes, high school mock trial, mock trial coaching, mock trial competition, MT academy">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://mocktrialacademy.com/">
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADvElEQVR4nMWWX2gcVRTGv3vnbrZ1Nds2TeOfjlJNs22Vxo3xwYJgHkLVRvsiZSNo17YSKk0kTfRFaYMUH2QmYKKsCgW1K1KlaoQ1EXzpSwjdNGJl4xqaNLRIG2KzNLQh2+7M8WF2ktmZmxIQdi4MDOd+c3/nnjnn3Msqv5mBQgYEig8ZJGBCsd4ddhMChmVfmivaJLplu+lcGwIGU2Aurc3LDIcCk5xr8zLD7Xey7dwH+NKGFZjgPsEtGwziPsKtX+An3EpCH+GuKig/XMC0q8AfuEIGuJ9wAQNCwEBuZCj7d+JYCo7x3Aefvb5BfbjaCZ/JjE3/qp8449TF3nl335ZIrdp3tDtxa35+AascH70Xf61WrdokciND2WhufDJL1OUU1NfXf13xypsvbNxsOTGTGZumP8+dJ5euqanpu58+/WRgemrqQE1NzT2rdSAajZ6K73liN+cwpYKurq7G7M/fjthh+/3H08Pd3d2NMi1bLdU1BAxwZQUHWltbt5nXLl+9nZu9eePKpdn7711baG5ufkSmffWtg3tr67Z+xRjT7UfX9VF7PpPJXHfOMcb0Q3u2767bvGGT4KCSxebm5hZDoVAgGAwq7e3t0eTQQPrW3PWbPcXdO+ftbxSY6NGOH7YTbuD71Fm3k+qDG6s+PrY/7k5mTwRyudxiMpkcB4C2tradV0ZH/ro988/VWCy2DQASicQfhUKh5COFzNL2Ko0qSSrJAOfkFeu6PkpECIfDwTfi+3d0dHREA4EAz+fzRn9//5hbz93t1RVVAGAED1zAhJDlwMTFyflUKjXV0tLyaGdn51OVlZUVAJBMJsdn/51ddOvd9S91APDCyYC0CtaEQms0TUsDgKqq94XD4SARobe397yiKFzqgKPJMIkDAHngVhWQVywqAuLCxMRCOp2+ZtsGBwcvLRTyaxljnqpbdqDYXiWbsiPghCsrlSED8OzLe3dpmrZUSpqmpZtfen6XZGvFNr7cXmURYCAP3EpCWcYS8PjTDZHC+vBWu25rG3Y8E4lsUeUOUMm5wSVRBeCBCzIh5OEiKDCxs/HJSENjX8R5sMgGJ+fBZK6QhOSFW7/g7t66TzVZ2/UsusJvdesEDLD2k6do8txw9pfPEykAWF9dve7tD3sO3u1IPdJxoi+fv3MHAI4fje2rr3tIdTeZL34YPnv6twujAPDYA+uqzrz/YtwNF2SAdZ78kv7XeS69K3izXQZX4LgT+gG3r2TML7ggg/EinPkBFyi9lrNywy0HSnfOygkXMPEfanF6PajmzH4AAAAASUVORK5CYII=">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml">
<meta property="og:image" content="https://mocktrialacademy.com/favicon.svg">
<meta property="og:title" content="MT academy">
<meta property="og:description" content="Interactive mock trial practice tools, objection drills, rule explanations, and quizzes to help students and coaches sharpen courtroom skills.">
<meta property="og:url" content="https://mocktrialacademy.com/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="MT academy">
<meta property="og:locale" content="en_US">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "MT academy",
  "url": "https://mocktrialacademy.com/",
  "description": "Interactive mock trial practice tools, objection drills, rule explanations, and quizzes to help students and coaches sharpen courtroom skills.",
  "keywords": ["mock trial","mock trial practice","mock trial resources","mock trial quizzes","high school mock trial","mock trial coaching","mock trial competition","MT academy"]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "url": "https://mocktrialacademy.com/",
  "name": "MT academy",
  "logo": "https://mocktrialacademy.com/favicon.svg"
}
</script>
<style>
/* Refreshed blue & white palette */
:root{--bg:linear-gradient(135deg,#0f172a 58%,#1d4ed8);--card:rgba(15,23,42,.92);--surface:#1e2a48;--muted:#cbd5f5;--text:#ffffff;--accent:#38bdf8;--secondary:#1d4ed8;--border:linear-gradient(135deg,#2563eb,#38bdf8)}

@media (prefers-color-scheme: dark){
  :root{--bg:#0b1120;--card:rgba(15,23,42,.94);--surface:#1b2540;--muted:#cbd5f5;--text:#f8fafc;--accent:#38bdf8;--secondary:#1d4ed8;--border:linear-gradient(135deg,#60a5fa,#38bdf8)}
}
*{box-sizing:border-box}body{margin:0;font-size:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;border:12px solid transparent;border-image:var(--border) 1;text-shadow:none}
.app{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;position:relative}
.title-block{flex:1}
.logo{width:calc(44px*1.25);height:calc(44px*1.25);border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#38bdf8);font-weight:700;color:#fff;border:2px solid #0f172a}
.nav-menu{position:fixed;top:0;right:0;bottom:0;width:180px;background:var(--card);border-left:1px solid rgba(148,163,184,.28);box-shadow:0 0 18px rgba(2,6,23,.45);display:flex;flex-direction:column;z-index:1000;padding:10px;transform:translateX(100%);transition:transform .3s;overflow-y:auto}
.nav-menu.open{transform:translateX(0)}
.nav-menu .tab{background:var(--surface);border:1px solid rgba(148,163,184,.28);border-radius:8px;padding:10px 12px;text-align:left;color:var(--text);cursor:pointer;margin-bottom:6px;box-shadow:0 6px 12px rgba(15,23,42,.35)}
.nav-menu .tab.active{background:var(--accent);color:#0b1120}
.tab{background:var(--surface);border:1px solid rgba(148,163,184,.35);padding:8px 12px;border-radius:6px;color:var(--text);cursor:pointer;box-shadow:0 6px 12px rgba(15,23,42,.35)}
.tab.active{background:var(--accent);color:#0b1120}
.card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 12px 28px rgba(2,6,23,.55);color:var(--text);border:1px solid rgba(148,163,184,.25)}
section.card{display:none}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start;justify-content:flex-start;flex-direction:column}
.btn{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:var(--secondary);color:var(--text);cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(15,23,42,.16)}
.btn.primary{background:var(--accent);color:#fff}.btn.secondary{background:var(--secondary);color:var(--text)}
.small{font-size:1em;color:var(--muted)}
.menu-toggle{display:flex;flex-direction:column;gap:4px;cursor:pointer;padding:8px}
.menu-toggle span{display:block;width:24px;height:3px;background:var(--text);border-radius:2px}
.controls select{font-size:1em;padding:6px 10px;background:var(--surface);border:1px solid rgba(148,163,184,.4);border-radius:8px;color:var(--text);box-shadow:0 4px 10px rgba(15,23,42,.35)}
.controls label{font-size:1em;display:flex;flex-direction:column;align-items:flex-start;gap:2px}
textarea{width:100%;min-height:120px;background:var(--surface);color:var(--text);border-radius:10px;padding:10px;border:1px solid rgba(148,163,184,.35);resize:vertical;box-shadow:0 6px 16px rgba(15,23,42,.35)}
textarea.disabled{opacity:.6;cursor:not-allowed}
.fact{background:var(--surface);padding:12px;border-radius:10px;margin:8px 0;box-shadow:0 6px 18px rgba(2,6,23,.45);border:1px solid rgba(148,163,184,.25)}
.result.ok{border-left:4px solid #16a34a;padding:8px}.result.bad{border-left:4px solid #ef4444;padding:8px}
.rule-item{border:1px solid rgba(148,163,184,.3);border-radius:12px;padding:12px;margin:6px 0;background:var(--surface);box-shadow:0 6px 16px rgba(15,23,42,.35)}
.rule-title{font-weight:600;cursor:pointer}
.badge{font-size:1em;padding:4px 10px;border-radius:999px;background:var(--accent);color:#fff;box-shadow:0 4px 10px rgba(56,189,248,.45)}
.recording-badge{display:none;align-items:center;gap:6px;background:#b91c1c;color:#fff;padding:4px 10px;border-radius:999px;font-weight:600;box-shadow:0 0 12px rgba(185,28,28,.55)}
.recording-badge.active{display:inline-flex}
.recording-badge .dot{width:10px;height:10px;border-radius:50%;background:#f87171;box-shadow:0 0 8px rgba(248,113,113,.8)}
.quiz-q{font-weight:600;margin-bottom:6px}.quiz-opt{display:block;margin:6px 0;padding:8px 10px;border:1px solid rgba(148,163,184,.35);border-radius:10px;background:var(--surface);color:var(--text);box-shadow:0 4px 12px rgba(15,23,42,.35)}
.quiz-correct{background:rgba(34,197,94,.35)}.quiz-wrong{background:rgba(239,68,68,.35)}
.tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.35);margin:0 4px 4px 0;background:rgba(37,99,235,.55)}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid rgba(148,163,184,.3);padding:8px 10px;text-align:left;color:var(--text);background:var(--surface)}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
.kv div{padding:2px 0}
.scorebar{height:8px;background:var(--surface);border-radius:999px;position:relative;margin-top:4px;overflow:hidden;border:1px solid rgba(148,163,184,.35)}
.scorebar>span{position:absolute;left:0;top:0;bottom:0;background:var(--accent);border-radius:999px}
/* Gateway modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{width:min(740px,94vw);max-height:90vh;overflow-y:auto;background:var(--card);border:1px solid rgba(148,163,184,.35);border-radius:16px;box-shadow:0 20px 42px rgba(2,6,23,.6);padding:20px;color:var(--text)}
.modal h2{margin:0 0 6px}
.modal .note{font-size:1em;color:var(--muted);margin-bottom:10px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(148,163,184,.35);background:var(--surface);color:var(--text);box-shadow:0 6px 14px rgba(15,23,42,.35)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.choice{flex:1 1 260px;border:1px solid rgba(148,163,184,.35);border-radius:14px;padding:16px;background:var(--surface);box-shadow:0 10px 28px rgba(2,6,23,.55)}
.choice h3{margin:0 0 6px}
.warn{background:#7f1d1d;color:#fee2e2;border:1px solid rgba(248,113,113,.55);padding:8px 10px;border-radius:12px;font-size:1em}
.ok{background:#166534;color:#dcfce7;border:1px solid rgba(74,222,128,.55);padding:8px 10px;border-radius:12px}
.badge-mode{font-size:0.6em;padding:2px 6px;border-radius:999px;background:var(--accent);color:#0b1120;margin-left:6px}
@media(max-width:600px){
  .header{flex-direction:column;align-items:flex-start}
  .nav-menu{width:100%}
}
.chat-entry{margin-top:8px;padding:8px;border-radius:10px;border:1px solid rgba(148,163,184,.3);background:var(--surface);box-shadow:0 4px 12px rgba(15,23,42,.35)}
.chat-entry.user{background:var(--accent);color:#0b1120}
.chat-entry.chatgpt{background:linear-gradient(135deg,var(--accent),rgba(255,255,255,.6));color:#0b1120}
.chat-entry.judge{background:var(--card)}
hr.sep{border:0;border-top:1px solid rgba(255,255,255,.2);margin:12px 0}
a.inline{color:var(--accent);text-decoration:underline}
.hidden-link{color:inherit;text-decoration:none}
.coach-hidden{display:none!important}
.title-block h1{color:#e2e8f0}
.title-block .small,.title-block p{color:rgba(226,232,240,.9)}
#howto.card{padding:0;background:transparent;border:none;box-shadow:none}
#howto .page-shell{position:relative;width:min(1100px,92vw);margin:0 auto;padding:clamp(2.5rem,6vw,4rem) clamp(1.5rem,4vw,3rem) 3rem;display:flex;flex-direction:column;gap:clamp(2rem,5vw,3rem)}
#howto .glow{position:absolute;inset:clamp(1rem,3vw,2.5rem);border-radius:28px;background:linear-gradient(135deg,rgba(56,189,248,.08),rgba(14,165,233,.03));border:1px solid rgba(148,163,184,.16);backdrop-filter:blur(22px);pointer-events:none}
#howto .hero,#howto .content,#howto .footer{position:relative;z-index:1}
#howto .hero{background:linear-gradient(135deg,rgba(56,189,248,.16),rgba(14,165,233,.08));border-radius:24px;padding:clamp(1.8rem,5vw,2.75rem);border:1px solid rgba(56,189,248,.25);box-shadow:0 25px 60px rgba(15,23,42,.4);display:flex;flex-direction:column;gap:1rem}
#howto .hero h1,#howto .hero h2{margin:0;font-size:clamp(2.2rem,5vw,3rem);letter-spacing:-.02em}
#howto .hero p{margin:0;color:var(--muted);max-width:60ch}
#howto .hero p+p{font-size:.95rem;max-width:65ch;opacity:.9}
#howto .eyebrow{font-size:.85rem;letter-spacing:.2em;text-transform:uppercase;color:#bae6fd;font-weight:600}
#howto .anchor-nav ul{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:.75rem}
#howto .anchor-nav a{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .95rem;border-radius:999px;border:1px solid rgba(56,189,248,.35);background:rgba(15,23,42,.6);color:var(--text);text-decoration:none;font-size:.95rem;transition:transform .2s ease,box-shadow .2s ease,background .2s ease}
#howto .anchor-nav a:hover,#howto .anchor-nav a:focus{transform:translateY(-2px);box-shadow:0 12px 30px rgba(56,189,248,.25);background:rgba(56,189,248,.2);outline:none}
#howto .anchor-nav a.active{background:rgba(56,189,248,.32);box-shadow:0 16px 36px rgba(14,165,233,.24);color:#f0f9ff}
#howto .section-chips{display:flex;flex-wrap:wrap;gap:.65rem;padding:.5rem 0 0}
#howto .section-chip{position:relative;display:inline-flex;align-items:center;gap:.4rem;padding:.5rem .85rem;border-radius:14px;background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.2);text-decoration:none;color:var(--muted);font-size:.85rem;transition:transform .2s ease,background .2s ease,border .2s ease}
#howto .section-chip span{display:inline-flex;align-items:center;justify-content:center;width:1.45rem;height:1.45rem;border-radius:50%;background:rgba(56,189,248,.18);color:#bae6fd;font-size:.7rem;font-weight:600}
#howto .section-chip.active{background:rgba(56,189,248,.3);border-color:rgba(56,189,248,.55);color:#f8fafc}
#howto .section-chip:hover,#howto .section-chip:focus-visible{transform:translateY(-1px);background:rgba(56,189,248,.18);border-color:rgba(56,189,248,.45);color:#f8fafc;outline:none}
#howto .content{display:grid;gap:clamp(1.5rem,4vw,2.5rem)}
#howto .content>.card{display:block;background:rgba(15,23,42,.88);border-radius:22px;padding:clamp(1.6rem,4vw,2.4rem);border:1px solid rgba(148,163,184,.18);box-shadow:0 25px 60px rgba(15,23,42,.4);position:relative;overflow:hidden}
#howto .content>.card h2{margin-top:0;font-size:clamp(1.45rem,3vw,1.85rem);letter-spacing:-.01em;display:inline-flex;align-items:center;gap:.55rem}
#howto .content>.card h2::before{content:"";width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 12px rgba(56,189,248,.6)}
#howto .content>.card::after{content:"";position:absolute;inset:0;background:radial-gradient(120% 140% at 100% 0%,rgba(56,189,248,.18),transparent 55%);opacity:0;transition:opacity .3s ease;pointer-events:none}
#howto .content>.card:hover::after,#howto .content>.card:focus-within::after{opacity:1}
#howto .content>.card p,#howto .content>.card ol{color:var(--muted)}
#howto .content>.card ol{margin:0;padding-left:1.1rem;display:grid;gap:.75rem}
#howto .content>.card li{line-height:1.6}
#howto .content>.card.highlight{background:linear-gradient(135deg,rgba(56,189,248,.14),rgba(37,99,235,.22));border:1px solid rgba(56,189,248,.45)}
#howto .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.15rem;margin-top:1.35rem}
#howto .info-tile{border-radius:18px;border:1px solid rgba(125,211,252,.35);background:rgba(8,47,73,.4);padding:1.2rem 1.35rem;display:flex;flex-direction:column;gap:.85rem;min-height:100%;transition:transform .2s ease,box-shadow .2s ease,border .2s ease}
#howto .info-tile:hover,#howto .info-tile:focus-within{transform:translateY(-4px);box-shadow:0 20px 46px rgba(14,165,233,.32);border-color:rgba(56,189,248,.55)}
#howto .info-header{display:flex;justify-content:space-between;align-items:center;gap:.75rem}
#howto .info-header strong{font-size:1.05rem;color:var(--text);letter-spacing:-.01em}
#howto .info-summary{color:rgba(226,232,240,.8);font-size:.9rem;line-height:1.5;margin:0}
#howto .info-actions{display:flex;flex-wrap:wrap;gap:.6rem}
#howto .info-link{display:inline-flex;align-items:center;gap:.35rem;padding:.45rem .85rem;border-radius:999px;text-decoration:none;font-size:.85rem;font-weight:500;transition:background .2s ease,color .2s ease}
#howto .info-link svg{width:.85rem;height:.85rem}
#howto .info-link--howto{background:rgba(56,189,248,.18);color:#e0f2fe;border:1px solid rgba(56,189,248,.4)}
#howto .info-link--howto:hover,#howto .info-link--howto:focus-visible{background:rgba(56,189,248,.3);color:#f8fafc;outline:none}
#howto .info-link--launch{background:rgba(15,23,42,.7);color:rgba(191,219,254,.9);border:1px solid rgba(148,163,184,.3)}
#howto .info-link--launch:hover,#howto .info-link--launch:focus-visible{background:rgba(15,23,42,.92);color:#f8fafc;border-color:rgba(191,219,254,.6);outline:none}
#howto .callout{border-radius:18px;border:1px dashed rgba(125,211,252,.4);background:rgba(15,118,110,.18);padding:1.1rem 1.3rem;color:#ccfbf1;font-size:.95rem;display:grid;gap:.4rem}
#howto .callout strong{color:#5eead4;text-transform:uppercase;letter-spacing:.1em;font-size:.75rem}
#howto .footer{text-align:center;color:var(--muted);font-size:.95rem}
#howto .footer a{font-weight:600}
@media(max-width:640px){#howto .page-shell{padding:1.75rem 1.1rem 2.5rem}#howto .content>.card{padding:1.5rem}#howto .info-header{flex-direction:column;align-items:flex-start}#howto .info-actions{width:100%}#howto .info-link{width:fit-content}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">MT</div>
    <div class="title-block">
        <h1 style="margin:0">MT academy
        <span id="modeBadge" class="badge-mode" title="Scoring Engine" style="display:none">Mode: ChatGPT (API key required)</span>
      </h1>
      <div class="small">Mock Trial Objection Practice</div>
      <p class="small">Interactive mock trial practice tools, objection drills, rule explanations, and quizzes to help students and coaches sharpen courtroom skills.</p>
    </div>
    <div id="menuToggle" class="menu-toggle" aria-label="Menu" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <nav id="navMenu" class="nav-menu">
    <a class="tab" href="#objections">Objections</a>
    <a class="tab" href="#video">Video Coach</a>
    <a class="tab" href="#writing">Writing</a>
    <a class="tab" href="#rules" id="rulesTab">AZ Rules</a>
    <a class="tab" href="#quiz">Rules Quiz</a>
    <a class="tab" href="#keys">API Keys</a>
    <a class="tab" href="#howto">How To Use</a>
    <a class="tab" href="#contact">Contact</a>
  </nav>

  <!-- Gateway -->
  <div id="videoGate" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="videoGateTitle">
    <div class="modal">
      <h2 id="videoGateTitle">Choose how to score your performance</h2>
      <div class="note">Use your own ChatGPT (OpenAI) account for rubric-based scoring. The legacy built-in scorer has been removed.</div>
      <div class="row">
        <div class="choice">
          <h3>Option A — Use my ChatGPT account (recommended)</h3>
          <ol class="small" style="margin-top:6px">
            <li>Visit <strong>platform.openai.com</strong> and sign in.</li>
            <li>Open <strong>Billing</strong> → <strong>Add payment method</strong> and deposit funds.</li>
            <li>Go to <strong>API keys</strong> → <strong>Create new secret key</strong>.</li>
            <li>Paste the key below. It is stored only in your browser (LocalStorage).</li>
            <li>Select a model. “gpt-4o” is recommended.</li>
          </ol>
          <div class="ok" style="margin:8px 0">We never ask for your password. API key stays on this device.</div>
          <label class="small">OpenAI API Key
            <input id="openaiKey" class="input" type="password" placeholder="sk-...">
          </label>
          <div class="row" style="margin-top:8px">
            <label class="small" style="flex:1">Model
              <select id="openaiModel" class="input">
                <option value="gpt-4o">gpt-4o</option>
              </select>
            </label>
            <label class="small" style="flex:1">Max tokens
              <input id="openaiMaxTokens" class="input" type="number" value="600" min="200" max="2000">
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnUseChatGPT" class="btn primary">Use ChatGPT Scoring</button>
            <button id="btnForgetKey" class="btn secondary" title="Delete saved key">Remove saved key</button>
          </div>
        </div>
        <div class="choice">
          <h3>Option B — Built-in scoring (retired)</h3>
          <p class="small">The on-device heuristic scorer has been removed. Add your ChatGPT API key to receive rubric-based scores.</p>
          <div class="warn" style="margin:8px 0">Without an API key, transcripts will not be scored.</div>
          <button id="btnUseBuiltin" class="btn secondary" disabled title="Built-in scoring is no longer available">Built-in scoring unavailable</button>
        </div>
        <div class="choice">
          <h3>Movement Analysis</h3>
          <p class="small">Use the same ChatGPT key to unlock video-based movement coaching. No extra setup needed.</p>
          <p class="small">ChatGPT’s multimodal models review your recording plus the transcript to highlight gesture, stance, and eye contact adjustments.</p>
          <div class="ok" style="margin:8px 0">Requires the ChatGPT key from Option A.</div>
        </div>
      </div>
      <hr class="sep">
      <div class="row" style="justify-content:flex-end">
        <button id="btnCloseGate" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Objections -->
  <section id="objections" class="card">
    <h2>Objections Drill</h2>
    <div class="controls small">
      <label>Filter: <select id="objFilter"><option value="all">All</option><option>Hearsay</option><option>611 Control</option><option>Foundation</option><option>Opinion/Experts</option><option>Character/404</option><option>Relevance/403</option><option>Policy Exclusions</option></select></label>
      <label>Difficulty: <select id="objDiff"><option value="both">Both</option><option value="core">Core</option><option value="advanced">Advanced</option></select></label>
      <button id="btnResetStats" class="btn secondary">Reset Stats</button>
      <span>Mastery: <span id="objStats">N/A</span></span>
    </div>
    <div class="fact" id="objFact"></div>
    <div class="small" id="objQ"></div>
    <div class="controls" style="margin-top:8px">
      <select id="objSelect" aria-label="Choose objection"></select>
      <button id="btnNewObj" class="btn primary">New Drill</button>
      <button id="btnCheckObj" class="btn secondary">Check</button>
    </div>
    <div class="controls" style="margin-top:8px">
      <label>GPT Difficulty:
        <select id="objGPTDiff">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="difficult">Difficult</option>
        </select>
      </label>
      <label>Role:
        <select id="objGPTRole">
          <option value="chatgpt">ChatGPT objects</option>
          <option value="user">I object</option>
        </select>
      </label>
      <button id="btnGPTNew" class="btn primary">GPT Prompt</button>
      <button id="btnObjChangeEngine" class="btn secondary" title="Add or change API key">API Key</button>
    </div>
    <div class="small" style="margin-top:8px">Press <strong>ChatGPT Argue</strong> to show argument actions.</div>
    <button id="btnGPTArgue" class="btn primary" style="width:100%;margin-top:4px">ChatGPT Argue</button>
    <div id="objGPTChat" class="small" hidden style="margin-top:8px;white-space:pre-wrap;max-height:400px;overflow-y:auto"></div>
    <div id="objGPTControls" class="controls" hidden style="margin-top:8px">
      <input id="objGPTInput" type="text" style="flex:1">
      <button id="btnGPTRecord" class="btn secondary">Record</button>
      <button id="btnGPTStopRecord" class="btn secondary" disabled>Stop</button>
      <button id="btnGPTSend" class="btn secondary">Send</button>
      <button id="btnGPTRule" class="btn secondary" hidden>Rule on Argument</button>
    </div>
      <div id="objResult" class="result" hidden style="margin-top:8px">
      <div><strong>Ruling:</strong> <span id="objRuling"></span></div>
      <div><strong>Rule:</strong> <span id="objRule"></span></div>
      <div><strong>Why:</strong> <span id="objWhy"></span></div>
    </div>
    <div id="objJudgeFollowupWrap" class="controls small" hidden style="margin-top:8px;flex-direction:column;gap:6px">
      <textarea id="objJudgeFollowup" placeholder="Ask the judge a follow-up question about your score (Enter to send, Shift+Enter for newline)" style="width:100%;min-height:64px" disabled></textarea>
      <div id="objJudgeFollowupStatus" class="small"></div>
    </div>
  </section>

  <!-- Video Coach -->
  <section id="video" class="card">
    <h2>Video Coach (Transcribe & Type-Specific Rubric)</h2>
    <div class="small" id="videoModeBanner"></div>
    <div class="controls small">
      <label>Type: <select id="videoType"><option value="opening">Opening</option><option value="closing">Closing</option><option value="direct">Direct</option><option value="cross">Cross</option></select></label>
      <button id="btnVideoStart" class="btn primary">Start Recording</button>
      <button id="btnFlipCamera" class="btn secondary" title="Switch between front and rear camera">Flip Camera</button>
      <button id="btnStopRecording" class="btn secondary">Stop</button>
      <button id="btnPlayRecording" class="btn secondary">Play</button>
      <span>Timer: <span id="videoTimer">00:00</span></span>
    </div>
    <div class="row" style="align-items:center;gap:8px">
      <span id="recordingBadge" class="recording-badge" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span>Recording</span>
      </span>
      <span id="mediaStatus" class="small" aria-live="polite"></span>
    </div>
    <div id="videoStatus" class="small" style="margin-top:4px;color:#9aa4b2"></div>
    <video id="videoPreview" autoplay playsinline muted style="width:100%;background:#000;border-radius:6px"></video>
    <textarea id="videoTranscript" placeholder="Transcript will appear here"></textarea>
    <div class="controls">
      <button id="btnScoreVideo" class="btn secondary">Re-score</button>
      <button id="btnShowVoice" class="btn secondary">Show Voice</button>
      <button id="btnAnalyzeMovement" class="btn secondary">Movement (ChatGPT)</button>
      <button id="btnChangeEngine" class="btn secondary" title="Switch scoring engine or update API key">API Key / Engine</button>
      <button id="btnTestChatGPT" class="btn secondary" title="Send a tiny test to ChatGPT">Test ChatGPT</button>
    </div>
    <div class="warn" style="margin-top:8px">ChatGPT receives strict guardrails to keep the weighted category math exact. If a score ever flags a mismatch, press <strong>Re-score</strong>; the guardrail will keep flagging the result until the rubric totals and categories align.</div>
    <div id="videoFeedback" class="small"></div>
    <div id="videoFollowupWrap" class="controls small" style="margin-top:8px;flex-direction:column;gap:6px;display:none">
      <textarea id="videoFollowup" placeholder="Ask the judge a follow-up question about this score (Enter to send, Shift+Enter for newline)" style="width:100%;min-height:64px" disabled></textarea>
      <div id="videoFollowupStatus" class="small"></div>
    </div>
    <div id="videoFollowupReplies" class="small" style="margin-top:8px;white-space:pre-wrap"></div>
    <div id="movementFeedback" class="small" style="margin-top:8px"></div>
  </section>

  <!-- Writing -->
  <section id="writing" class="card">
    <h2>Writing New Materials (ChatGPT)</h2>
    <div class="controls small">
      <label>Type:
        <select id="writeType">
          <option value="opening">Opening</option>
          <option value="closing">Closing</option>
          <option value="direct">Direct</option>
          <option value="cross">Cross</option>
        </select>
      </label>
    </div>
    <textarea id="gptWriteInput" placeholder="Paste draft or notes here"></textarea>
    <textarea id="gptWriteGoal" placeholder="Describe what you're trying to write or improve"></textarea>
    <div class="controls">
      <button id="btnGPTWrite" class="btn secondary">Ask ChatGPT to Draft</button>
      <button id="btnWriteChangeEngine" class="btn secondary" title="Add or change API key">API Key / Engine</button>
    </div>
    <textarea id="gptWriteOutput" placeholder="ChatGPT output will appear here"></textarea>
    <div class="small" style="margin-top:4px">Use the box below to clarify your request or ask follow-up questions about this draft.</div>
    <textarea id="gptWriteFollowup" class="small" placeholder="Ask ChatGPT a follow-up about this draft (Enter to send, Shift+Enter for newline)" disabled></textarea>
    <div id="gptWriteStatus" class="small" style="margin-top:4px"></div>
    <div id="writeExemplar" class="small" style="margin-top:8px"></div>
  </section>

  <!-- Rules -->
  <section id="rules" class="card">
    <h2 id="rulesHeading">AZ HS Mock Trial Rules of Evidence — Explorer</h2>
    <div class="controls small">
      <input id="rulesSearch" placeholder="Search by number or topic (e.g., 403, hearsay)" style="width:320px;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,.08);background:#061122;color:#e6eef6">
      <button id="btnClearSearch" class="btn secondary">Clear</button>
      <a class="btn secondary" target="_blank" href="https://lawforkids.org/programs/mock-trial/document-center/tournament-documents/1612-az-rules-converted-from-nhsmtc-rules-august-2023/file">Official PDF</a>
    </div>
    <div class="small" style="margin-top:8px">Click a rule to view its full text word for word.</div>
    <div id="rulesList" class="small" style="margin-top:8px"></div>
  </section>

  <!-- Rules Quiz -->
  <section id="quiz" class="card">
    <h2>Rules Quiz</h2>
    <div class="controls small">
      <label>Rules: <select id="quizScope"><option value="all">All</option><option value="hearsay">Hearsay</option><option value="character">Character Evidence</option><option value="witness">Witness Testimony</option></select></label>
      <label>Questions: <select id="quizCount"><option>5</option><option>10</option><option>15</option></select></label>
      <label>Difficulty: <select id="quizDifficulty"><option value="1">Standard</option><option value="2">Hard (subsections)</option></select></label>
      <button id="btnStartQuiz" class="btn primary">Start Quiz</button>
      <button id="btnNextQ" class="btn secondary" disabled>Next</button>
      <span>Score: <span id="quizScore">0</span>/<span id="quizTotal">0</span> • Best: <span id="quizBest">0</span></span>
    </div>
    <div id="quizBody" style="margin-top:8px"></div>
    <div id="quizExplain" class="small" style="margin-top:8px"></div>
  </section>
  <!-- API Keys -->
  <section id="keys" class="card">
    <h2>API Keys / Engine</h2>
    <p class="small">Use your own API accounts for AI features. Keys are stored only in this browser.</p>
    <div class="row">
      <div class="choice">
        <h3>ChatGPT Scoring</h3>
        <ol class="small" style="margin-top:6px">
          <li>Visit <strong>platform.openai.com</strong> and sign in.</li>
          <li>Open <strong>Billing</strong> → <strong>Add payment method</strong> and deposit funds.</li>
          <li>Go to <strong>API keys</strong> → <strong>Create new secret key</strong>.</li>
          <li>Paste the key below and choose a model.</li>
        </ol>
        <label class="small">OpenAI API Key
          <input id="keyPageOpenAI" class="input" type="password" placeholder="sk-...">
        </label>
        <div class="row" style="margin-top:8px">
          <label class="small" style="flex:1">Model
            <select id="keyPageOpenAIModel" class="input">
              <option value="gpt-4o">gpt-4o</option>
            </select>
          </label>
          <label class="small" style="flex:1">Max tokens
            <input id="keyPageOpenAIMaxTokens" class="input" type="number" value="600" min="200" max="2000">
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveOpenAI" class="btn primary">Save ChatGPT Key</button>
          <button id="removeOpenAI" class="btn secondary">Remove</button>
        </div>
      </div>
      <div class="choice">
        <h3>Movement Analysis (ChatGPT)</h3>
        <p class="small">No extra key needed. The same OpenAI key powers transcript scoring and the new video-based movement feedback.</p>
        <p class="small">For best results keep recordings under an hour and ensure the camera captures full-body posture.</p>
      </div>
    </div>
  </section>
  <!-- How To -->
  <section id="howto" class="card howto-host">
    <div class="page-shell">
      <div class="glow" aria-hidden="true"></div>
      <header class="hero">
        <span class="eyebrow">MT academy Playbook</span>
        <h2 style="margin:0">How to Use MT academy</h2>
        <p>Every MT academy tool shares the same goal: make it easier to prepare for mock trial. Use this guide for a quick refresher, to onboard teammates, or to map out your next practice session.</p>
        <p>Browse the highlights below or jump straight to the full apps using the shortcut tiles. Each practice space opens in its own tab so you can experiment without losing progress.</p>
        <nav class="anchor-nav" aria-label="Page sections">
          <ul>
            <li><a href="#howto-overview">Quick Start</a></li>
            <li><a href="#howto-objections">Objections Drill</a></li>
            <li><a href="#howto-video-coach">Video Coach</a></li>
            <li><a href="#howto-writing">Writing Lab</a></li>
            <li><a href="#howto-rules">Rules Library</a></li>
            <li><a href="#howto-quiz">Rules Quiz</a></li>
            <li><a href="#howto-api">OpenAI API Keys</a></li>
          </ul>
        </nav>
        <div class="section-chips" role="list" aria-label="Jump to sections">
          <a class="section-chip" href="#howto-overview" role="listitem"><span>01</span> Quick Start</a>
          <a class="section-chip" href="#howto-objections" role="listitem"><span>02</span> Objections</a>
          <a class="section-chip" href="#howto-video-coach" role="listitem"><span>03</span> Video Coach</a>
          <a class="section-chip" href="#howto-writing" role="listitem"><span>04</span> Writing Lab</a>
          <a class="section-chip" href="#howto-rules" role="listitem"><span>05</span> Rules Library</a>
          <a class="section-chip" href="#howto-quiz" role="listitem"><span>06</span> Rules Quiz</a>
          <a class="section-chip" href="#howto-api" role="listitem"><span>07</span> API Keys</a>
        </div>
      </header>

      <div class="content">
        <section id="howto-overview" class="card highlight">
          <h2>Quick Start</h2>
          <p>Decide what skill you want to sharpen, then launch the matching tool. You can move between apps freely—your progress and generated drafts stay in their tabs until you clear them.</p>
          <p>If you plan to use ChatGPT scoring, drafting, or movement analysis, create your own OpenAI API key before jumping into drills (see <a href="#howto-api">API Keys</a> below). Each tile includes a shortcut to its how-to section and a direct launch link.</p>
          <div class="info-grid" aria-label="Tool shortcuts">
            <article class="info-tile">
              <div class="info-header">
                <strong>Objections Drill</strong>
                <a class="info-link info-link--howto" href="#howto-objections" aria-label="Read how to use the Objections Drill">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Practice fast objections with built-in fact patterns or AI-generated prompts.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="objections.html">Launch tool</a>
              </div>
            </article>
            <article class="info-tile">
              <div class="info-header">
                <strong>Video Coach</strong>
                <a class="info-link info-link--howto" href="#howto-video-coach" aria-label="Read how to use the Video Coach">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Record and score speeches with movement analysis plus delivery feedback.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="video-coach.html">Launch tool</a>
              </div>
            </article>
            <article class="info-tile">
              <div class="info-header">
                <strong>Writing Lab</strong>
                <a class="info-link info-link--howto" href="#howto-writing" aria-label="Read how to use the Writing Lab">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Draft openings, closings, and crosses using your notes and ChatGPT assists.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="writing.html">Launch tool</a>
              </div>
            </article>
            <article class="info-tile">
              <div class="info-header">
                <strong>Rules Library</strong>
                <a class="info-link info-link--howto" href="#howto-rules" aria-label="Read how to use the Rules Library">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Search the NCHSAA rules instantly and save citations for competition.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="rules.html">Launch tool</a>
              </div>
            </article>
            <article class="info-tile">
              <div class="info-header">
                <strong>Rules Quiz</strong>
                <a class="info-link info-link--howto" href="#howto-quiz" aria-label="Read how to use the Rules Quiz">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Challenge yourself or teammates with custom quizzes and lightning rounds.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="quiz.html">Launch tool</a>
              </div>
            </article>
            <article class="info-tile">
              <div class="info-header">
                <strong>API Keys Portal</strong>
                <a class="info-link info-link--howto" href="#howto-api" aria-label="Read how to set up API keys">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a.75.75 0 0 1 .75-.75h6.69L8.22 5.03a.75.75 0 1 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.22-2.22H3.75A.75.75 0 0 1 3 8Z"/></svg>
                  How-to
                </a>
              </div>
              <p class="info-summary">Securely store, test, or remove the OpenAI keys used across every tool.</p>
              <div class="info-actions">
                <a class="info-link info-link--launch" href="api-keys.html">Launch tool</a>
              </div>
            </article>
          </div>
        </section>

        <section id="howto-objections" class="card">
          <h2>Objections Drill</h2>
          <ol>
            <li>Set the topic, difficulty, and prompt style (built-in scenario or fresh AI prompt).</li>
            <li>Read the fact pattern, select the best objection, and note the supporting rule.</li>
            <li>Click <em>Check</em> to compare your answer with the expected objection and rule citation.</li>
            <li>Use <em>ChatGPT Argue</em> to practice explaining your reasoning in real time.</li>
            <li>Press <em>Score</em> to receive detailed feedback from ChatGPT on the strength of your argument.</li>
            <li>Need a refresher on objection lists? Open the <a href="rules.html" data-section="rules">Rules Library</a> in another tab.</li>
          </ol>
        </section>

        <section id="howto-video-coach" class="card">
          <h2>Video Coach</h2>
          <ol>
            <li>Choose the speech type you want to rehearse, then hit <em>Start Recording</em>.</li>
            <li>After finishing, click <em>Stop</em>, then review or download your video.</li>
            <li>Select <em>Re-score</em> for updated delivery notes and <em>Show Voice</em> to review the transcript.</li>
            <li>Use <em>Movement (ChatGPT)</em> for posture and gesture analysis—large uploads automatically fall back to transcript coaching.</li>
            <li>Confirm your API configuration anytime with <em>Test ChatGPT</em> in the toolbar.</li>
            <li>Final results appear as a rating (Terrible → Amazing) with specific action items to try in your next run.</li>
            <li>Want to benchmark progress? Log each rehearsal in your team tracker or share the download with coaches.</li>
          </ol>
        </section>

        <section id="howto-writing" class="card">
          <h2>Writing Lab</h2>
          <ol>
            <li>Pick a document type (opening, closing, cross, etc.) and jot down the facts or themes you want to highlight.</li>
            <li>Click <em>Ask ChatGPT to Draft</em> to generate a sample passage tailored to your notes.</li>
            <li>Edit the draft directly in the browser, then copy it into your preferred editor or team folder.</li>
            <li>Pair your draft with a <a href="rules.html" data-section="rules">rule citation</a> or <a href="objections.html" data-section="objections">objection drill</a> to stress-test your argument.</li>
          </ol>
        </section>

        <section id="howto-rules" class="card">
          <h2>Rules Library</h2>
          <ol>
            <li>Search by rule number, keyword, or topic. Results update instantly.</li>
            <li>Select a rule to read the full text along with a short explanation.</li>
            <li>Use <em>Clear</em> to reset your search or open the <em>Official PDF</em> for the complete rulebook.</li>
            <li>Need a pop quiz on what you just read? Jump to the <a href="quiz.html" data-section="quiz">Rules Quiz</a> without leaving your browser.</li>
          </ol>
        </section>

        <section id="howto-quiz" class="card">
          <h2>Rules Quiz</h2>
          <ol>
            <li>Choose a mode (standard or lightning), the rule sets you want to review, question count, and difficulty.</li>
            <li>Press <em>Start Quiz</em> to begin. Each question appears one at a time—answer, then click <em>Next</em>.</li>
            <li>Track your accuracy with the live score display and revisit tricky rules with the review links.</li>
            <li>Run a rematch after reviewing the <a href="rules.html" data-section="rules">Rules Library</a> to lock in those citations.</li>
          </ol>
        </section>

        <section id="howto-api" class="card">
          <h2>OpenAI API Keys</h2>
          <ol>
            <li>Log in at <a href="https://platform.openai.com/">platform.openai.com</a> using your own account.</li>
            <li>Visit the <a href="https://platform.openai.com/account/billing/overview">Billing dashboard</a> and add a payment method so ChatGPT requests can process.</li>
            <li>Open the <a href="https://platform.openai.com/api-keys">API Keys page</a> and click <strong>Create new secret key</strong>.</li>
            <li>Copy the key into MT academy's <a href="api-keys.html" data-section="keys">API Key portal</a>, choose a model, and hit <em>Save ChatGPT Key</em>.</li>
            <li>Return to any tool and click <em>Test ChatGPT</em> (or the equivalent button) to confirm everything works.</li>
          </ol>
          <p>Keep your key private. You can remove it at any time with the <em>Remove</em> button on the API Keys page.</p>
          <div class="callout" role="note">
            <strong>Need help?</strong>
            <span>OpenAI bills by usage. You can monitor spending on the <a href="https://platform.openai.com/account/usage">Usage dashboard</a> and set alerts there. For MT academy-specific questions, reach out through the <a href="contact.html" data-section="contact">contact form</a>.</span>
          </div>
        </section>
      </div>

      <footer class="footer">
        <p>Back to the <a href="#howto-overview">top of this guide</a> or explore other tools from the main navigation. Want rules at a glance? Jump into the <a href="rules.html" data-section="rules">Rules Library</a>, and when you're ready to practice live, start a <a href="video-coach.html" data-section="video">Video Coach</a> session.</p>
      </footer>
    </div>
  </section>
  <!-- Contact -->
  <section id="contact" class="card">
    <h2>Contact</h2>
    <p class="small">For recommendations, contact the creator at <a href="mailto:amielbeyo1@gmail.com">amielbeyo1@gmail.com</a>.</p>
  </section>
</div>

<script>
// Detailed Arizona Mock Trial Rules of Evidence
// Expose rule details on the global object so they are available to scripts
// that run after this file is loaded. Using `globalThis` ensures compatibility
// in both browser and non-browser environments (where `window` may be
// undefined).
const root = typeof globalThis !== 'undefined' ? globalThis : (typeof window !== 'undefined' ? window : {});
root.AZ_RULES_DETAIL = {
  "101": {
    full: `These rules govern proceedings in the Arizona High School Mock Trial Program.`,
    meaning: `These are the evidence rules used in this competition.`
  },
  "102": {
    full: `These rules should be construed so as to administer every proceeding fairly, eliminate unjustifiable expense and delay, and promote the development of evidence law, to the end of ascertaining the truth and securing a just determination.`,
    meaning: `Judges and competitors should apply the rules to ensure fairness and a search for truth.`
  },
  "105": {
    full: `If the court admits evidence that is admissible against a party or for a purpose\u2014but not against another party or for another purpose\u2014the court, on timely request, must restrict the evidence to its proper scope and instruct the jury accordingly.`,
    meaning: `When evidence is allowed for one reason but not another, the judge will tell the jury how it can be used.`
  },
  "106": {
    full: `If a party introduces all or part of a writing or recorded statement, an adverse party may require the introduction, at that time, of any other part\u2014or any other writing or recorded statement\u2014that in fairness ought to be considered at the same time.`,
    meaning: `When one side offers part of a document or recording, the other side can insist on showing the rest so the jury is not misled.`
  },
  "201": {
    full: `(a) Scope. This rule governs judicial notice of an adjudicative fact only, not a legislative fact. (b) Kinds of Facts That May Be Judicially Noticed. The court may judicially notice a fact that is not subject to reasonable dispute because it: (1) is generally known within the trial court\u2019s territorial jurisdiction; or (2) can be accurately and readily determined from sources whose accuracy cannot reasonably be questioned. (c) Taking Notice. The court: (1) may take judicial notice on its own; or (2) must take judicial notice if a party requests it and the court is supplied with the necessary information. (d) Timing. The court may take judicial notice at any stage of the proceeding. (e) Opportunity to Be Heard. On timely request, a party is entitled to be heard on the propriety of taking judicial notice and the nature of the fact to be noticed. (f) Instructing the Jury. In a civil case, the court must instruct the jury to accept the noticed fact as conclusive. In a criminal case, the court must instruct the jury that it may or may not accept the noticed fact as conclusive.`,
    meaning: `Courts can accept certain commonly known or easily verified facts without formal proof. In civil cases the jury must accept them; in criminal cases the jury may choose whether to accept them.`
  },
  "401": {
    full: `Evidence is relevant if: (a) it has any tendency to make a fact more or less probable than it would be without the evidence; and (b) the fact is of consequence in determining the action.`,
    meaning: `Evidence is relevant when it helps prove or disprove an important fact in the case.`
  },
  "402": {
    full: `Relevant evidence is admissible unless any of the following provides otherwise: the United States Constitution; a federal statute; these rules; or other rules prescribed by the Supreme Court. Irrelevant evidence is not admissible.`,
    meaning: `If evidence relates to the issues in the case, it comes in unless some other rule keeps it out.`
  },
  "403": {
    full: `The court may exclude relevant evidence if its probative value is substantially outweighed by a danger of one or more of the following: unfair prejudice, confusing the issues, misleading the jury, undue delay, wasting time, or needlessly presenting cumulative evidence.`,
    meaning: `Even when evidence matters, the judge can keep it out if it causes more problems than it is worth.`
  },
  "404": {
    full: `(a) Character Evidence. (1) Prohibited Uses. Evidence of a person\u2019s character or character trait is not admissible to prove that on a particular occasion the person acted in accordance with the character or trait. (2) Exceptions for a Defendant or Victim in a Criminal Case. (A) a defendant may offer evidence of the defendant\u2019s pertinent trait, and if the evidence is admitted, the prosecutor may offer evidence to rebut it; (B) subject to Rule 412, a defendant may offer evidence of an alleged victim\u2019s pertinent trait, and if the evidence is admitted, the prosecutor may offer evidence to rebut it and may offer evidence of the defendant\u2019s same trait; and (C) in a homicide case, the prosecutor may offer evidence of the alleged victim\u2019s trait of peacefulness to rebut evidence that the victim was the first aggressor. (3) Exceptions for a Witness. Evidence of a witness\u2019s character may be admitted under Rules 607, 608, and 609. (b) Crimes, Wrongs, or Other Acts. (1) Prohibited Uses. Evidence of a crime, wrong, or other act is not admissible to prove a person\u2019s character in order to show that on a particular occasion the person acted in accordance with the character. (2) Permitted Uses; Notice in a Criminal Case. This evidence may be admissible for another purpose, such as proving motive, opportunity, intent, preparation, plan, knowledge, identity, absence of mistake, or lack of accident. On request by a defendant in a criminal case, the prosecutor must provide reasonable notice of the general nature of any such evidence that the prosecutor intends to offer at trial and do so before trial or during trial if the court, for good cause, excuses lack of pretrial notice.`,
    meaning: `You generally cannot use someone\u2019s past behavior to show they acted the same way this time, but character evidence can come in for limited purposes or to show things like motive or intent.`
  },
  "405": {
    full: `(a) By Reputation or Opinion. When evidence of a person\u2019s character or character trait is admissible, it may be proved by testimony about the person\u2019s reputation or by testimony in the form of an opinion. On cross-examination of the character witness, the court may allow an inquiry into relevant specific instances of the person\u2019s conduct. (b) By Specific Instances of Conduct. When a person\u2019s character or character trait is an essential element of a charge, claim, or defense, the character or trait may also be proved by relevant specific instances of the person\u2019s conduct.`,
    meaning: `If character evidence is allowed, it usually comes in through reputation or opinion; specific acts are allowed only when character itself is at issue.`
  },
  "406": {
    full: `Evidence of a person\u2019s habit or an organization\u2019s routine practice may be admitted to prove that on a particular occasion the person or organization acted in accordance with the habit or routine practice. The court may admit this evidence regardless of whether it is corroborated or whether there was an eyewitness.`,
    meaning: `Regular habits can show what likely happened on a specific occasion.`
  },
  "407": {
    full: `When measures are taken that would have made an earlier injury or harm less likely to occur, evidence of the subsequent measures is not admissible to prove negligence, culpable conduct, a defect in a product or its design, or a need for a warning or instruction. But the court may admit this evidence for another purpose, such as impeachment or\u2014if disputed\u2014proving ownership, control, or the feasibility of precautionary measures.`,
    meaning: `Fixing a problem after an accident cannot be used to show the party was negligent before, but it may show things like ownership or control.`
  },
  "408": {
    full: `(a) Prohibited Uses. Evidence of the following is not admissible to prove or disprove the validity or amount of a disputed claim or to impeach by a prior inconsistent statement or a contradiction: (1) furnishing, promising, or offering\u2014or accepting, promising to accept, or offering to accept\u2014a valuable consideration in compromising or attempting to compromise the claim; and (2) conduct or statements made during compromise negotiations about the claim\u2014except when offered in a criminal case and when the negotiations related to a claim by a public office in the exercise of its regulatory, investigative, or enforcement authority. (b) Exceptions. The court may admit this evidence for another purpose, such as proving a witness\u2019s bias or prejudice, negating a contention of undue delay, or proving an effort to obstruct a criminal investigation or prosecution.`,
    meaning: `Settlement talks can\u2019t be used to show someone is liable, but they might show bias or obstruction.`
  },
  "409": {
    full: `Evidence of furnishing, promising to pay, or offering to pay medical, hospital, or similar expenses resulting from an injury is not admissible to prove liability for the injury.`,
    meaning: `Paying someone\u2019s medical bills doesn\u2019t mean you admit fault.`
  },
  "410": {
    full: `(a) Prohibited Uses. In a civil or criminal case, evidence of the following is not admissible against the defendant who made the plea or participated in the plea discussions: (1) a guilty plea that was later withdrawn; (2) a nolo contendere plea; (3) a statement made during a proceeding on either of those pleas under Federal Rule of Criminal Procedure 11 or a comparable state procedure; or (4) a statement made during plea discussions with an attorney for the prosecuting authority if the discussions did not result in a guilty plea or they resulted in a later-withdrawn guilty plea. (b) Exceptions. The court may admit a statement described in Rule 410(a)(3) or (4): (1) in any proceeding in which another statement made during the same plea or plea discussions has been introduced, if in fairness the statements ought to be considered together; or (2) in a criminal proceeding for perjury or false statement, if the defendant made the statement under oath, on the record, and with counsel present.`,
    meaning: `Withdrawn pleas and most plea-talk statements cannot be used against a defendant, except in limited situations.`
  },
  "411": {
    full: `Evidence that a person was or was not insured against liability is not admissible to prove whether the person acted negligently or otherwise wrongfully. But the court may admit this evidence for another purpose, such as proving a witness\u2019s bias or prejudice or proving agency, ownership, or control.`,
    meaning: `Having or lacking insurance doesn\u2019t show fault, though it can show bias or who controlled something.`
  },
  "501": {
    full: `The common law\u2014as interpreted by United States courts in the light of reason and experience\u2014governs a claim of privilege unless the United States Constitution, a federal statute, or rules prescribed by the Supreme Court provide otherwise. In civil cases, state law governs privilege regarding a claim or defense for which state law supplies the rule of decision.`,
    meaning: `Only established privileges apply, such as attorney-client or doctor-patient.`
  },
  "601": {
    full: `Every person is competent to be a witness unless these rules provide otherwise.`,
    meaning: `Almost anyone can testify.`
  },
  "602": {
    full: `A witness may testify to a matter only if evidence is introduced sufficient to support a finding that the witness has personal knowledge of the matter. Evidence to prove personal knowledge may consist of the witness\u2019s own testimony. This rule does not apply to a witness\u2019s expert testimony under Rule 703.`,
    meaning: `Witnesses can only talk about what they personally perceived.`
  },
  "607": {
    full: `Any party, including the party that called the witness, may attack the witness\u2019s credibility.`,
    meaning: `Either side can challenge a witness\u2019s truthfulness.`
  },
  "608": {
    full: `(a) Reputation or Opinion Evidence. A witness\u2019s credibility may be attacked or supported by testimony about the witness\u2019s reputation for having a character for truthfulness or untruthfulness, or by testimony in the form of an opinion about that character. But evidence of truthful character is admissible only after the witness\u2019s character for truthfulness has been attacked. (b) Specific Instances of Conduct. Except for a criminal conviction under Rule 609, extrinsic evidence is not admissible to prove specific instances of a witness\u2019s conduct in order to attack or support the witness\u2019s character for truthfulness. But the court may, on cross-examination, allow them to be inquired into if they are probative of the character for truthfulness or untruthfulness of the witness or another witness whose character the witness being cross-examined has testified about.`,
    meaning: `You can use reputation or opinion to show a witness lies or tells the truth, and sometimes ask about specific acts on cross.`
  },
  "609": {
    full: `(a) In General. The following rules apply to attacking a witness\u2019s character for truthfulness by evidence of a criminal conviction: (1) for a crime that, in the convicting jurisdiction, was punishable by death or by imprisonment for more than one year, the evidence: (A) must be admitted, subject to Rule 403, in a civil case or in a criminal case in which the witness is not a defendant; and (B) must be admitted in a criminal case in which the witness is a defendant, if the probative value of the evidence outweighs its prejudicial effect to that defendant; and (2) for any crime regardless of the punishment, the evidence must be admitted if the court can readily determine that establishing the elements of the crime required proving\u2014or the witness\u2019s admitting\u2014a dishonest act or false statement. (b) Limit on Using the Evidence After 10 Years. If more than 10 years have passed since the witness\u2019s conviction or release, the evidence is admissible only if its probative value substantially outweighs its prejudicial effect and the proponent gives reasonable written notice. (c) Effect of a Pardon, Annulment, or Certificate of Rehabilitation. Evidence of a conviction is not admissible if the conviction has been the subject of a pardon, annulment, certificate of rehabilitation, or other equivalent procedure based on a finding of rehabilitation, or based on a finding of innocence. (d) Juvenile Adjudications. Evidence of a juvenile adjudication is admissible only if certain conditions are met. (e) Pendency of an Appeal. A conviction that satisfies this rule is admissible even if an appeal is pending; evidence of the pendency is also admissible.`,
    meaning: `Prior convictions can show a witness lies, but there are many limits, especially for old crimes or when the witness is the defendant.`
  },
  "610": {
    full: `Evidence of a witness\u2019s religious beliefs or opinions is not admissible to attack or support the witness\u2019s credibility.`,
    meaning: `You can\u2019t use religion to argue someone is more or less truthful.`
  },
  "611": {
    full: `(a) Control by the Court; Purposes. The court should exercise reasonable control over the mode and order of examining witnesses and presenting evidence so as to (1) make those procedures effective for determining the truth; (2) avoid wasting time; and (3) protect witnesses from harassment or undue embarrassment. (b) Scope of Cross-Examination. Cross-examination is not limited to the subject matter of the direct examination and may inquire into any relevant facts or matters affecting the witness\u2019s credibility. (c) Leading Questions. Leading questions should not be used on direct examination except as necessary to develop the witness\u2019s testimony. Ordinarily, the court should allow leading questions (1) on cross-examination; and (2) when a party calls a hostile witness, an adverse party, or a witness identified with an adverse party. (d) Redirect and Recross. After cross-examination, redirect and recross are permitted, limited to matters raised on the immediately preceding examination and subject to the court\u2019s discretion.`,
    meaning: `Judges control questioning; cross can explore any relevant matter; leading questions generally belong on cross or with hostile witnesses; redirect and recross are allowed but limited and discretionary.`
  },
  "612": {
    full: `(a) Scope. This rule gives an adverse party certain options when a witness uses a writing to refresh memory: while testifying; or before testifying, if the court decides that justice requires the party to have those options. (b) Adverse Party\u2019s Options; Deleting Unrelated Matter. Unless 18 U.S.C. \u00a7 3500 provides otherwise in a criminal case, an adverse party is entitled to have the writing produced, to inspect it, to cross-examine the witness about it, and to introduce in evidence any portion that relates to the witness\u2019s testimony. If the producing party claims that the writing includes unrelated matter, the court must examine the writing in camera, delete any unrelated portion, and order that the rest be delivered to the adverse party. Any portion deleted over objection must be preserved for the record. (c) Failure to Produce or Deliver the Writing. If a writing is not produced or is not delivered as ordered, the court may issue any appropriate order; but if the prosecution does not comply in a criminal case, the court must strike the witness\u2019s testimony or declare a mistrial.`,
    meaning: `If a witness uses a document to jog memory, the other side gets to see it and may use it in cross.`
  },
  "613": {
    full: `(a) Showing or Disclosing the Statement During Examination. When examining a witness about the witness\u2019s prior statement, a party need not show it or disclose its contents to the witness. But the party must, on request, show it or disclose its contents to an adverse party\u2019s attorney. (b) Extrinsic Evidence of a Prior Inconsistent Statement. Extrinsic evidence of a witness\u2019s prior inconsistent statement is admissible only if the witness is given an opportunity to explain or deny the statement and an adverse party is given an opportunity to examine the witness about it, or if justice so requires. This rule does not apply to an opposing party\u2019s statement under Rule 801(d)(2).`,
    meaning: `You don\u2019t have to show a prior statement before asking a witness about it, but the other side can see it; extrinsic proof is allowed only with a chance to explain.`
  },
  "701": {
    full: `If a witness is not testifying as an expert, testimony in the form of an opinion is limited to one that is (a) rationally based on the witness\u2019s perception; (b) helpful to clearly understanding the witness\u2019s testimony or to determining a fact in issue; and (c) not based on scientific, technical, or other specialized knowledge within the scope of Rule 702.`,
    meaning: `Nonexperts may give opinions only if based on what they personally saw and if it helps the jury.`
  },
  "702": {
    full: `A witness who is qualified as an expert by knowledge, skill, experience, training, or education may testify in the form of an opinion or otherwise if (a) the expert\u2019s scientific, technical, or other specialized knowledge will help the trier of fact to understand the evidence or to determine a fact in issue; (b) the testimony is based on sufficient facts or data; (c) the testimony is the product of reliable principles and methods; and (d) the expert has reliably applied the principles and methods to the facts of the case.`,
    meaning: `Experts can testify if their specialized knowledge will help and they used reliable methods.`
  },
  "703": {
    full: `An expert may base an opinion on facts or data in the case that the expert has been made aware of or personally observed. If experts in the particular field would reasonably rely on those kinds of facts or data in forming an opinion on the subject, they need not be admissible for the opinion to be admitted. But if the facts or data would otherwise be inadmissible, the proponent may disclose them to the jury only if their probative value in helping the jury evaluate the opinion substantially outweighs their prejudicial effect.`,
    meaning: `Experts can rely on information others gave them, but that information usually isn\u2019t shown to the jury unless its value outweighs any prejudice.`
  },
  "704": {
    full: `(a) In General \u2014 Not Automatically Objectionable. An opinion is not objectionable just because it embraces an ultimate issue. (b) Exception. In a criminal case, an expert witness must not state an opinion about whether the defendant did or did not have a mental state or condition that constitutes an element of the crime charged or of a defense. Those matters are for the trier of fact alone.`,
    meaning: `Witnesses may give opinions on ultimate facts, but experts cannot say the defendant had the required mental state.`
  },
  "705": {
    full: `Unless the court orders otherwise, an expert may state an opinion\u2014and give the reasons for it\u2014without first testifying to the underlying facts or data. But the expert may be required to disclose those facts or data on cross-examination.`,
    meaning: `Experts can give opinions without first listing every fact, but can be asked about those facts on cross.`
  },
  "801": {
    full: `(a) Statement. \u201cStatement\u201d means a person\u2019s oral assertion, written assertion, or nonverbal conduct, if the person intended it as an assertion. (b) Declarant. \u201cDeclarant\u201d means the person who made the statement. (c) Hearsay. \u201cHearsay\u201d means a statement that (1) the declarant does not make while testifying at the current trial or hearing; and (2) a party offers in evidence to prove the truth of the matter asserted in the statement. (d) Statements That Are Not Hearsay. A statement that meets the following conditions is not hearsay: (1) A Declarant-Witness\u2019s Prior Statement. The declarant testifies and is subject to cross-examination about a prior statement, and the statement: (A) is inconsistent with the declarant\u2019s testimony and was given under penalty of perjury at a trial, hearing, or other proceeding or in a deposition; (B) is consistent with the declarant\u2019s testimony and is offered to rebut an express or implied charge that the declarant recently fabricated it or acted from a recent improper influence or motive in so testifying, or to rehabilitate the declarant\u2019s credibility as a witness when attacked on another ground; or (C) identifies a person as someone the declarant perceived earlier. (2) An Opposing Party\u2019s Statement. The statement is offered against an opposing party and: (A) was made by the party in an individual or representative capacity; (B) is one the party manifested that it adopted or believed to be true; (C) was made by a person whom the party authorized to make a statement on the subject; (D) was made by the party\u2019s agent or employee on a matter within the scope of that relationship and while it existed; or (E) was made by the party\u2019s coconspirator during and in furtherance of the conspiracy.`,
    meaning: `Hearsay is an out-of-court statement offered for its truth. Some statements, like prior testimony or admissions by a party, are defined as \u201cnot hearsay.\u201d`
  },
  "802": {
    full: `Hearsay is not admissible unless any of the following provides otherwise: a federal statute; these rules; or other rules prescribed by the Supreme Court.`,
    meaning: `Out-of-court statements offered for their truth are kept out unless an exception applies.`
  },
  "803": {
    full: `The following are not excluded by the rule against hearsay, regardless of whether the declarant is available as a witness: (1) Present Sense Impression; (2) Excited Utterance; (3) Then-Existing Mental, Emotional, or Physical Condition; (4) Statement Made for Medical Diagnosis or Treatment; (5) Recorded Recollection; (6) Records of a Regularly Conducted Activity; (7) Absence of a Record of a Regularly Conducted Activity; (8) Public Records; (10) Absence of a Public Record; (16) Statements in Ancient Documents; (18) Statements in Learned Treatises, Periodicals, or Pamphlets; (21) Reputation Concerning Character; (22) Judgment of a Previous Conviction.`,
    meaning: `These are the most common hearsay exceptions where the declarant may be available or not, such as excited utterances and business records.`
  },
  "804": {
    full: `(a) Criteria for Being Unavailable. A declarant is considered to be unavailable as a witness if the declarant: (1) is exempted from testifying about the subject matter of the declarant\u2019s statement because the court rules that a privilege applies; (2) refuses to testify about the subject matter despite a court order to do so; (3) testifies to not remembering the subject matter; (4) cannot be present or testify at the trial or hearing because of death or a then-existing infirmity, physical illness, or mental illness; or (5) is absent from the trial or hearing and the statement\u2019s proponent has not been able, by process or other reasonable means, to procure the declarant\u2019s attendance or testimony. But this subdivision (a) does not apply if the statement\u2019s proponent procured or wrongfully caused the declarant\u2019s unavailability as a witness in order to prevent the declarant from attending or testifying. (b) The Exceptions. The following are not excluded by the rule against hearsay if the declarant is unavailable as a witness: (1) Former Testimony. Testimony that was given as a witness at a trial, hearing, or lawful deposition and is now offered against a party who had\u2014or in a civil case, whose predecessor in interest had\u2014an opportunity and similar motive to develop it by direct, cross-, or redirect examination; (2) Statement Under the Belief of Imminent Death. In a prosecution for homicide or in a civil case, a statement that the declarant, while believing the declarant\u2019s death to be imminent, made about its cause or circumstances; (3) Statement Against Interest. A statement that a reasonable person in the declarant\u2019s position would have made only if the person believed it to be true because, when made, it was so contrary to the declarant\u2019s proprietary or pecuniary interest or had so great a tendency to invalidate the declarant\u2019s claim against someone else or to expose the declarant to civil or criminal liability, and if offered in a criminal case, is supported by corroborating circumstances that clearly indicate its trustworthiness; (4) Statement of Personal or Family History. A statement about the declarant\u2019s own birth, adoption, legitimacy, ancestry, marriage, divorce, relationship by blood, adoption, or marriage, or similar facts of personal or family history, or about another person concerning any of these facts, as well as death, if the declarant was related to the person or was so intimately associated with the person\u2019s family that the declarant\u2019s information is likely to be accurate; (6) Statement Offered Against a Party That Wrongfully Caused the Declarant\u2019s Unavailability. A statement offered against a party that wrongfully caused\u2014or acquiesced in wrongfully causing\u2014the declarant\u2019s unavailability as a witness, and did so intending that result.`,
    meaning: `If the speaker can\u2019t testify, certain statements like former testimony or dying declarations may still be used.`
  },
  "805": {
    full: `Hearsay within hearsay is not excluded by the rule against hearsay if each part of the combined statements conforms with an exception to the rule.`,
    meaning: `Every layer of a multi-level statement must fit an exception.`
  },
  "806": {
    full: `When a hearsay statement\u2014or a statement described in Rule 801(d)(2)(C), (D), or (E)\u2014has been admitted in evidence, the declarant\u2019s credibility may be attacked, and then supported, by any evidence that would be admissible for those purposes if the declarant had testified as a witness. The court may admit evidence of the declarant\u2019s inconsistent statement or conduct, regardless of when it occurred or whether the declarant had an opportunity to explain or deny it. If the party against whom the statement was admitted calls the declarant as a witness, the party may examine the declarant on the statement as if on cross-examination.`,
    meaning: `Once a hearsay statement is in, you can attack the speaker\u2019s credibility just like any witness.`
  },
  "807": {
    full: `(a) In General. Under the following conditions, a hearsay statement is not excluded by the rule against hearsay even if the statement is not admissible under a hearsay exception in Rule 803 or 804: (1) the statement has equivalent circumstantial guarantees of trustworthiness; (2) it is offered as evidence of a material fact; (3) it is more probative on the point for which it is offered than any other evidence that the proponent can obtain through reasonable efforts; and (4) admitting it will best serve the purposes of these rules and the interests of justice. (b) Notice. The statement is admissible only if, before the trial or hearing, the proponent gives an adverse party reasonable notice of the intent to offer the statement and its particulars, including the declarant\u2019s name and address, so that the party has a fair opportunity to meet it.`,
    meaning: `Even if no specific exception applies, a trustworthy statement on an important point can be allowed with advance notice.`
  },
  "103": {full:`A party may claim error in a ruling to admit or exclude evidence only if it affects a substantial right and the party timely objects or makes an offer of proof. The court may take notice of plain error.`,meaning:`To preserve an evidentiary issue, object promptly; serious plain errors can be reviewed even without objection.`},
  "104": {full:`The court decides preliminary questions about whether a witness is qualified, a privilege exists, or evidence is admissible. When relevance depends on a fact, proof must support that finding.`,meaning:`Judges decide foundational questions and may admit conditionally relevant evidence only with supporting proof.`},
  "301": {full:`In civil cases, unless a statute or rules provide otherwise, a presumption imposes on the party against whom it is directed the burden of producing evidence to rebut it.`,meaning:`Once a presumption arises, the opposing party must produce evidence to overcome it.`},
  "302": {full:`State law governs the effect of a presumption regarding a claim or defense for which state law provides the rule of decision.`,meaning:`Use state law to determine presumptions in civil actions.`},
  "412": {full:`(a) Prohibited Uses. The following evidence is not admissible in a civil or criminal proceeding involving alleged sexual misconduct:\n  (1) evidence offered to prove that a victim engaged in other sexual behavior; or\n  (2) evidence offered to prove a victim\u2019s sexual predisposition.\n(b) Exceptions.\n  (1) Criminal Cases. The court may admit the following evidence in a criminal case:\n    (A) evidence of specific instances of a victim\u2019s sexual behavior, if offered to prove that someone other than the defendant was the source of semen, injury, or other physical evidence;\n    (B) evidence of specific instances of a victim\u2019s sexual behavior with respect to the person accused of the sexual misconduct, if offered by the defendant to prove consent or if offered by the prosecutor; and\n    (C) evidence whose exclusion would violate the defendant\u2019s constitutional rights.\n  (2) Civil Cases. In a civil case, the court may admit evidence offered to prove a victim\u2019s sexual behavior or sexual predisposition if its probative value substantially outweighs the danger of harm to any victim and of unfair prejudice to any party. The court may admit evidence of a victim\u2019s reputation only if the victim has placed it in controversy.\n(c) Procedure to Determine Admissibility.\n  (1) Motion. If a party intends to offer evidence under Rule 412(b), the party must:\n    (A) file a motion that specifically describes the evidence and states the purpose for which it is to be offered;\n    (B) do so at least 14 days before trial unless the court, for good cause, sets a different time;\n    (C) serve the motion on all parties; and\n    (D) notify the victim or, when appropriate, the victim\u2019s guardian or representative.\n  (2) Hearing. Before admitting evidence under this rule, the court must conduct an in camera hearing and give the victim and parties a right to attend and be heard. The motion, related materials, and the record of the hearing must be sealed and remain under seal unless the court orders otherwise.\n(d) Definition of \u201cVictim.\u201d In this rule, \u201cvictim\u201d includes an alleged victim.`,meaning:`Victim sexual history is mostly barred, subject to narrow exceptions and special procedures.`},
  "413": {full:`(a) Permitted Uses. In a criminal case in which a defendant is accused of a sexual assault, the court may admit evidence that the defendant committed any other sexual assault. The evidence may be considered on any matter to which it is relevant.\n(b) Disclosure to the Defendant. If the prosecutor intends to offer this evidence, the prosecutor must disclose it to the defendant, including witnesses\u2019 statements or a summary of the expected testimony, at least 15 days before trial or at a later time that the court allows for good cause.\n(c) Effect on Other Rules. This rule does not limit the admission or consideration of evidence under any other rule.\n(d) Definition of \u201cSexual Assault.\u201d In this rule and Rule 415, \u201csexual assault\u201d means a crime under federal or state law involving any conduct proscribed by 18 U.S.C. chapter 109A, contact without consent between any part of the defendant\u2019s body\u2014or an object\u2014and another person\u2019s genitals or anus, contact between the defendant\u2019s genitals or anus and any part of another person\u2019s body, deriving sexual pleasure from inflicting death, bodily injury, or physical pain on another person, or an attempt or conspiracy to engage in such conduct.`,meaning:`Prior sexual assaults by the accused can be used against them in similar cases after proper notice.`},
  "414": {full:`(a) Permitted Uses. In a criminal case in which a defendant is accused of child molestation, the court may admit evidence that the defendant committed any other child molestation. The evidence may be considered on any matter to which it is relevant.\n(b) Disclosure to the Defendant. If the prosecutor intends to offer this evidence, the prosecutor must disclose it to the defendant, including witnesses\u2019 statements or a summary of the expected testimony, at least 15 days before trial or at a later time that the court allows for good cause.\n(c) Effect on Other Rules. This rule does not limit the admission or consideration of evidence under any other rule.\n(d) Definition of \u201cChild\u201d and \u201cChild Molestation.\u201d In this rule and Rule 415, \u201cchild\u201d means a person below the age of 14, and \u201cchild molestation\u201d means a crime under federal or state law involving any sexual contact with a child, deriving sexual pleasure from inflicting death, bodily injury, or physical pain on a child, or an attempt or conspiracy to engage in such conduct.`,meaning:`Evidence of other child molestation offenses by the defendant can be admitted with notice.`},
  "415": {full:`(a) Permitted Uses. In a civil case involving a claim for relief based on a party\u2019s alleged sexual assault or child molestation, the court may admit evidence that the party committed any other sexual assault or child molestation. The evidence may be considered on any matter to which it is relevant.\n(b) Disclosure to the Opponent. If a party intends to offer this evidence, the party must disclose it to the opposing party, including witnesses\u2019 statements or a summary of the expected testimony, at least 15 days before trial or at a later time that the court allows for good cause.\n(c) Effect on Other Rules. This rule does not limit the admission or consideration of evidence under any other rule.`,meaning:`Civil sexual-assault or molestation suits may include evidence of prior similar acts with proper notice.`},
  "502": {full:`The attorney\u2013client privilege and work-product protection apply even after disclosure unless the holder intentionally waives it; subject to limitations for inadvertent disclosure.`,meaning:`Confidential lawyer\u2013client communications are protected unless clearly waived.`},
  "503": {full:`A patient has a privilege to refuse to disclose and to prevent others from disclosing confidential communications made for mental health diagnosis or treatment.`,meaning:`Psychotherapist\u2013patient communications are protected.`},
  "504": {full:`A person has a privilege to refuse to disclose and to prevent others from disclosing a confidential communication made to a cleric in a spiritual capacity.`,meaning:`Spiritual counseling communications remain confidential.`},
  "505": {full:`An individual has a privilege to refuse to disclose and to prevent another from disclosing confidential marital communications.`,meaning:`Spouses may keep private marital conversations out of court.`},
  "506": {full:`The government has a privilege to refuse to disclose the identity of an informer.`,meaning:`Informer identities are protected unless fairness requires disclosure.`},
  "614": {full:`(a) Calling. The court may call a witness on its own or at a party\u2019s request. Each party is entitled to cross-examine the witness.\n(b) Examining. The court may examine a witness regardless of who calls the witness.\n(c) Objections. A party may object to the court\u2019s calling or examining a witness either at that time or at the next opportunity when the jury is not present.`,meaning:`Judges can call and question witnesses, but parties may object.`},
  "615": {full:`At a party\u2019s request, the court must order witnesses excluded so that they cannot hear other witnesses\u2019 testimony. Or the court may do so on its own. But this rule does not authorize excluding:\n  (a) a party who is a natural person;\n  (b) an officer or employee of a party that is not a natural person, after being designated as the party\u2019s representative by its attorney;\n  (c) a person whose presence a party shows to be essential to presenting the party\u2019s claim or defense; or\n  (d) a person authorized by statute to be present.`,meaning:`Witnesses can be sequestered, but parties and essential witnesses may remain.`},
  "706": {full:`(a) Appointment Process. On a party\u2019s motion or on its own, the court may order the parties to show cause why expert witnesses should not be appointed and may ask the parties to submit nominations. The court may appoint any expert that the court finds appropriate. The court must inform the expert of the expert\u2019s duties. The court may authorize the expert to hold conferences with the parties, to testify, and to be deposed by any party.\n(b) Expert\u2019s Role. The expert must advise the parties of any findings. The expert\u2019s deposition may be taken by any party; the expert may be called to testify by the court or any party; and the expert may be cross-examined by any party.\n(c) Compensation. The expert is entitled to a reasonable compensation, as the court directs. In civil cases, the compensation is paid by the parties; in criminal cases, it is paid from funds provided by law.\n(d) Disclosing the Appointment to the Jury. The court may authorize disclosure to the jury that the court appointed the expert.\n(e) Parties\u2019 Choice of Their Own Experts. This rule does not limit a party in calling its own expert witnesses.`,meaning:`Courts may appoint their own experts, who may be deposed and cross-examined and must be paid as the court directs.`},
  "901": {full:`(a) To satisfy the requirement of authenticating or identifying an item of evidence, the proponent must produce evidence sufficient to support a finding that the item is what the proponent claims it is. (b) Examples include testimony of a witness with knowledge, distinctive characteristics, and more.`,meaning:`Evidence must be shown to be genuine through testimony or characteristics.`},
  "902": {full:`The following items are self-authenticating; they require no extrinsic evidence of authenticity: domestic public documents under seal, certified copies of public records, official publications, newspapers, trade inscriptions, acknowledged documents, commercial paper, and certified business records, among others.`,meaning:`Certain documents prove themselves without additional testimony.`},
  "903": {full:`The testimony of a subscribing witness is unnecessary to authenticate a writing unless required by a statute.`,meaning:`You usually don't need the signing witness to authenticate a document.`},
  "1001": {full:`Defines writings, recordings, photographs, originals, and duplicates for the rules on proving content.`,meaning:`Clarifies terminology for best-evidence rules.`},
  "1002": {full:`An original writing, recording, or photograph is required to prove its content unless these rules or a statute provide otherwise.`,meaning:`To prove content, produce the original unless an exception applies.`},
  "1003": {full:`A duplicate is admissible to the same extent as the original unless a genuine question is raised about the original's authenticity or it would be unfair to admit the duplicate.`,meaning:`Copies are fine unless authenticity is challenged.`},
  "1004": {full:`An original is not required if it has been lost or destroyed, cannot be obtained, is in the opponent's possession and they fail to produce it, or relates only to a collateral matter.`,meaning:`Other evidence of content is allowed when the original isn't available for specified reasons.`},
  "1005": {full:`The contents of an official record may be proved by a copy certified as correct or by a witness who has compared it with the original.`,meaning:`Certified copies can prove public records.`},
  "1006": {full:`The proponent may use a summary, chart, or calculation to prove the content of voluminous writings, recordings, or photographs that cannot be conveniently examined in court.`,meaning:`Summaries of voluminous documents are admissible if originals are available.`},
  "1007": {full:`The proponent may prove the content of a writing, recording, or photograph by the testimony, deposition, or written statement of the party against whom the evidence is offered.`,meaning:`A party's own words can prove a document's content without the original.`},
  "1008": {full:`Ordinarily, the court determines whether the proponent has fulfilled the factual conditions for admitting other evidence of content under these rules; in jury trials, the jury decides disputes about whether an original ever existed, whether another one produced at trial is the original, and whether other evidence accurately reflects the content.`,meaning:`Judges admit secondary evidence; juries resolve factual disputes about originals.`},
  "1101": {full:`These rules apply to proceedings in United States courts except as provided for certain types of cases and circumstances.`,meaning:`Rules govern most proceedings with specific exceptions.`},
  "1102": {full:`These rules may be cited as the Arizona Rules of Evidence.`,meaning:`Provides the formal title of the rule set.`},
  "1103": {full:`These rules do not supersede existing privileges or other federal statutes.`,meaning:`Other statutes and privileges remain effective.`}
};

</script>
<script>
// Mock trial scoring utilities
const MT_SCORING = (() => {
  const OPENING_CRITERIA = [
    "Provided a case overview and story",
    "The theme/theory of the case was identified",
    "Mentioned the key witnesses",
    "Provided a clear and concise description of their team\u2019s evidence and side of the case",
    "Stated the relief or verdict requested",
    "Discussed the burden of proof",
    "Presentation was non-argumentative; did not include improper statements or assume facts not in evidence",
    "Spoke naturally and clearly",
    "Captured attention with a compelling hook or introduction",
    "Presented a clear roadmap for what the judge would hear",
    "Maintained professional courtroom demeanor and eye contact",
    "Used notes sparingly and purposefully",
  ];

  const DIRECT_CRITERIA = [
    "Properly phrased and effective questions",
    "Examination was organized effectively to make points clearly; questions had clear purpose",
    "Used proper courtroom procedures",
    "Handled objections appropriately and effectively",
    "Did not overuse objections",
    "Did not ask questions that called for an unfair extrapolation from the witness",
    "Demonstrated an understanding of the Modified Federal Rules of Evidence",
    "Handled physical evidence appropriately and effectively",
    "Spoke confidently and clearly",
    "Questions were predominantly open-ended and non-leading",
    "Witness testimony advanced the team\u2019s case theory",
    "Transitions between topics were smooth and logical",
    "Established proper foundations for exhibits and testimony",
    "Maintained effective witness control and rapport",
  ];

  const CROSS_CRITERIA = [
    "Properly phrased and effective questions",
    "Examination was organized effectively to make points clearly; questions had clear purpose",
    "Used proper courtroom procedures",
    "Handled objections appropriately and effectively",
    "Did not overuse objections",
    "Did not ask questions that called for an unfair extrapolation from the witness",
    "Used various techniques, as necessary, to handle a non-responsive witness",
    "Properly impeached witnesses",
    "Demonstrated an understanding of the Modified Federal Rules of Evidence",
    "Handled physical evidence appropriately and effectively",
    "Spoke confidently and clearly",
    "Questions were leading and limited to one fact each",
    "Maintained tight control and prevented narrative responses",
    "Listened to answers and adjusted follow-up questions",
    "Elicited helpful admissions or undermined witness credibility",
    "Concluded with a clear, memorable point",
  ];

  const CLOSING_CRITERIA = [
    "Theme/theory reiterated in closing argument",
    "Summarized the evidence",
    "Emphasized the supporting points of their own case and mistakes and weaknesses of the opponent\u2019s case",
    "Concentrated on the important, not the trivial",
    "Applied the relevant law",
    "Discussed burden of proof",
    "Did not discuss evidence that was not included in the trial presentation",
    "Overall, the closing statement was persuasive",
    "Use of notes was minimal, effective, and purposeful",
    "Contained spontaneous elements that reflect unanticipated outcomes of this specific trial",
    "Spoke naturally and clearly",
    "Organized the argument with a clear roadmap",
    "Addressed and refuted major points from the opposition",
    "Integrated witness testimony and exhibits into the argument",
    "Ended with a strong, memorable call for the verdict",
    "Maintained professional demeanor and time awareness",
  ];

  function numericToGrade(score) {
    if (score < 5) return 'F';
    if (score < 6) return 'D';
    if (score < 7) return 'C-';
    if (score < 8) return 'B-';
    if (score < 10) return 'A-';
    return 'A';
  }

  function evaluate(responses, criteria) {
    if (responses.length !== criteria.length) {
      throw new Error('Number of responses must match number of criteria');
    }
    const score = responses.filter(Boolean).length / criteria.length * 10;
    return { score, grade: numericToGrade(score) };
  }

  return {
    OPENING_CRITERIA,
    DIRECT_CRITERIA,
    CROSS_CRITERIA,
    CLOSING_CRITERIA,
    numericToGrade,
    evaluateOpening: responses => evaluate(responses, OPENING_CRITERIA),
    evaluateDirect: responses => evaluate(responses, DIRECT_CRITERIA),
    evaluateCross: responses => evaluate(responses, CROSS_CRITERIA),
    evaluateClosing: responses => evaluate(responses, CLOSING_CRITERIA),
  };
})();
</script>
<script>
// ChatGPT scoring and transcript formatting utilities ported from Python
function chatTokenParam(model, maxTokens){
  return { max_tokens: maxTokens };
}
const ChatGPTScoring = (() => {
  const NON_ANSWER_PATTERNS = [
    /^i don't know$/i,
    /^i do not know$/i,
    /^i dont know$/i,
    /^i'm not sure$/i,
    /^im not sure$/i,
    /^no idea$/i,
    /^idk$/i,
  ];

  const RATING_RUBRIC = `Score on a 1–10 scale (decimals welcome) that reflects how a real high-school regional judge would rate the performance.

Anchor the number using these bands:
1–2  Serious errors or no meaningful response.
3–4  Understands the task but misstates key rules or facts.
5–6  Competent but missing multiple checklist items or strategic moments.
7–8  Competition ready with only minor gaps.
9–10 Final-round quality: precise law, strong record use, confident delivery.

Judge each performance on four checkpoints:
• Accuracy: correct rules, burdens, and remedies.
• Record use: specific facts or testimony that support the point.
• Structure: organized, easy-to-follow roadmap with clear asks.
• Delivery: professional tone and control over pacing.

Reward clear references to the record and deductions that are tied to the rubric. Ignore spelling or transcription quirks when the meaning is clear.`;

  const ARGUMENT_RUBRIC = `Mock Trial Objection Rubric (10 total points).

Evaluate only the advocate’s objection argument or response:
• Rule Ground (0–3): Identify the correct rule or standard and state it plainly.
• Application (0–4): Tie the rule to the testimony with concrete citations.
• Exceptions & Remedy (0–2): Address the best counter and request the right ruling.
• Professionalism (0–1): Concise, confident delivery that sounds like open court.

Translate the final score to the 1–10 scale and use decimals when helpful. A razor-sharp, well-supported objection should land near 9–10; thin or inaccurate work belongs in the lower bands.`;

const PROMPT_TEMPLATE_RELAXED =
`You are a neutral mock trial high school judge. Read the transcript and score it exactly as you would in a live round. Let the words on the page decide the result.\n\n`+
`Transcript:\n{transcript}\n\n`+
`Rubric:\n{rubric}\n\n`+
`{jsonGuide}`;

const PROMPT_TEMPLATE_RULING_RELAXED =
`You are a neutral mock trial high school judge. Decide the objection exactly as you would in court, then rate the advocate using the rubric. Stay grounded in the transcript.\n\n`+
`Transcript:\n{transcript}\n\n`+
`Rubric:\n{rubric}\n\n`+
`{jsonGuide}`;

const PROMPT_TEMPLATE =
`You are a neutral mock trial high school judge. Read the transcript and score it exactly as you would in a live round. Base every comment on the words provided.\n\n`+
`Transcript:\n{transcript}\n\n`+
`Rubric:\n{rubric}\n\n`+
`Respond using this format:\n`+
`Summary: <2–3 sentences highlighting the decisive moments>\n`+
`Score: <single number or low-high range on the 1–10 scale>\n`+
`Explanation: <why the score matches the rubric>\n`+
`Improvements: <two concrete suggestions>\n`+
`Assumptions: <assumptions or "None">`;

const PROMPT_TEMPLATE_RULING =
`You are a neutral mock trial high school judge. Decide the objection exactly as you would in court, then rate the advocate using the rubric. Ground every statement in the transcript.\n\n`+
`Transcript:\n{transcript}\n\n`+
`Rubric:\n{rubric}\n\n`+
`Respond using this format:\n`+
`Ruling: <Sustained or Overruled>\n`+
`Summary: <2–3 sentences highlighting the decisive moments>\n`+
`Score: <single number or low-high range on the 1–10 scale>\n`+
`Explanation: <why the score matches the rubric>\n`+
`Improvements: <two concrete suggestions>\n`+
`Assumptions: <assumptions or "None">`;

const PROMPT_PREFIX_RELAXED =
  "Judge the transcript like a high-school regional mock trial judge. Pick the score the performance truly earned, using decimals when they help." +
  " Never auto-fill a middle score (like 7/10 or 70/100); double-check every rubric category and the weighted math before locking in the number." +
  " The platform audits your weighted math—if any category or the total disagrees, fix it before you reply; mismatches are rejected." +
  " Cross-check every rubric checkpoint and lower the specific category when the transcript misses an item, explaining the deduction." +
  " Focus only on what is written and cite the key moments that drove your decision.";

const PROMPT_PREFIX =
  "Judge the transcript like a high-school regional mock trial judge. Select the number the performance genuinely earned." +
  " Never default to a middling result—audit each category, recompute the weighted total, and make sure it matches before finalizing." +
  " The platform audits your weighted math—correct any mismatch before responding or the score will be rejected." +
  " Be specific about decisive facts or rule applications and ignore harmless typos.";

  function buildScoringPrompt(transcript, includeRuling=false, rubric=RATING_RUBRIC, options={}){
    const relaxed = Boolean(options && options.relaxed);
    const isVideo = options?.mode === 'video';
    const catKeys = Array.isArray(options?.catKeys) ? options.catKeys.filter(Boolean) : [];
    const catLabels = Array.isArray(options?.catLabels) ? options.catLabels : [];
    const catWeights = Array.isArray(options?.catWeights) ? options.catWeights : [];
    const catFocus = Array.isArray(options?.catFocus) ? options.catFocus : [];
    let cleaned = transcript.trim();
    const lowered = cleaned.toLowerCase();
    if (NON_ANSWER_PATTERNS.some(r => r.test(lowered))) {
      cleaned += relaxed
        ? '\n\n[Context: The participant indicated they lacked an answer. Apply the rubric accordingly.]'
        : '\n\n[Note: The participant admitted lack of knowledge; according to the rubric this should be scored 1.]';
    }
    if (!relaxed) {
      const wordCount = (lowered.match(/\b\w+\b/g) || []).length;
      if (wordCount < 15) {
        cleaned += '\n\n[Note: The response is very brief. Only award a high score if the brevity still covers the rubric items with concrete support; otherwise explain the deduction.]';
      }
      const sentenceCount = (cleaned.match(/[.!?](?:\s|$)/g) || []).length;
      if (sentenceCount < 8) {
        cleaned += '\n\n[Note: This transcript is quite brief. If you lower the score, tie the deduction to specific unchecked checklist items rather than the length alone.]';
      }
    }

    let jsonGuide = '';
    if (relaxed) {
      const catPairs = catKeys.map((key, idx) => ({ key, label: catLabels[idx] || key }));
      const categoriesExample = catPairs.length
        ? `{ ${catPairs.map(p => `"${p.key}": 0-100`).join(', ')} }`
        : '{}';
      const commentsExample = catPairs.length
        ? `{ ${catPairs.map(p => `"${p.key}": "feedback on ${p.label}"`).join(', ')} }`
        : '{}';
      const guideLines = [
        'Return valid JSON with this structure (numbers on a 0–100 scale with one decimal; convert any 1–10 scores by multiplying by 10):',
        '{',
        includeRuling ? '  "ruling": "Sustained" or "Overruled",' : null,
        '  "summary": "2-3 sentences referencing decisive facts",',
        '  "total": number,',
        '  "range": "low-high" or "",',
        '  "scoreLow": number or null,',
        '  "scoreHigh": number or null,',
        `  "categories": ${categoriesExample},`,
        `  "comments": ${commentsExample},`,
        '  "explanation": "brief reason tying the rubric to the score",',
        '  "notes": "two improvement tips separated by \n",',
        '  "midband_justification": [],',
        '  "decimals_used": "",',
        '  "qa": []',
        '}',
        'Only include details that appear in the transcript.'
      ].filter(Boolean);
      if (isVideo) {
        if (catPairs.length) {
          guideLines.push('Category calibration (0–100 total):');
          for (let idx = 0; idx < catPairs.length; idx++) {
            const pair = catPairs[idx];
            const weightVal = Number.isFinite(Number(catWeights[idx])) ? Number(catWeights[idx]) : null;
            const focusText = (catFocus[idx] || '').trim();
            const weightLabel = weightVal !== null ? `weight ${weightVal}` : 'weight ?';
            const focusLabel = focusText ? ` – ${focusText}` : '';
            guideLines.push(`  • ${pair.label} (${pair.key}): ${weightLabel}${focusLabel}`);
          }
        }
        guideLines.push('Do not respond until every listed category has an explicit 0–100 score with one decimal place.');
        guideLines.push('Report the total and every category on the 0–100 scale (for example, 9.4/10 should be written as 94.0).');
        guideLines.push('Ensure "total" equals the weighted category sum (rounded to the nearest tenth).');
        guideLines.push('Do not provide placeholder or automatic scores (e.g., 7/10 or 70/100). Recalculate deliberately and double- or triple-check totals before responding.');
        guideLines.push('Confirm that every category score reflects the transcript and that the weighted math matches the overall score you report. If anything is off, fix it before you send the response.');
        guideLines.push('If the total sits between 75 and 80 inclusive, add at least one "midband_justification" entry quoting or citing the transcript.');
        guideLines.push('Match every "comments" entry to its category and cite transcript cues (quotes, question numbers, or line references).');
        guideLines.push('Fill "decimals_used" with the decimal endings that appear in your scores or range (e.g., ".2 & .7" or "none").');
      }
      jsonGuide = guideLines.join('\n');
    }

    const tmpl = includeRuling
      ? (relaxed ? PROMPT_TEMPLATE_RULING_RELAXED : PROMPT_TEMPLATE_RULING)
      : (relaxed ? PROMPT_TEMPLATE_RELAXED : PROMPT_TEMPLATE);
    const prefix = relaxed ? PROMPT_PREFIX_RELAXED : PROMPT_PREFIX;
    return tmpl
      .replace('{transcript}', cleaned)
      .replace('{rubric}', prefix + "\n\n" + rubric)
      .replace('{jsonGuide}', jsonGuide);
  }

  function parseScoreResponse(text){
    const rulingMatch = text.match(/Ruling:\s*(Sustained|Overruled)/i);
    const summaryMatch = text.match(/Summary:\s*([\s\S]*?)\nScore(?: Range)?:/i);
    const scoreMatch = text.match(/Score(?: Range)?:\s*(\d+(?:\.\d+)?)(?:\s*(?:-|–|—|to)\s*(\d+(?:\.\d+)?))?/i);
    const explanationMatch = text.match(/Explanation:\s*([\s\S]*?)(?:\nAssumptions?:|\nImprovements?:|\n?$)/i);
    const assumptionsMatch = text.match(/Assumptions?:\s*([\s\S]*?)(?:\nImprovements?:|\n?$)/i);
    const improvementMatch = text.match(/Improvements?:\s*([\s\S]*)/i);
    if(!scoreMatch || !explanationMatch){
      throw new Error('Response did not match expected format');
    }
    return {
      ruling: rulingMatch ? rulingMatch[1] : null,
      summary: summaryMatch ? summaryMatch[1].trim() : '',
      score: scoreMatch[2] ? `${scoreMatch[1]}-${scoreMatch[2]}` : scoreMatch[1],
      scoreLow: Number(scoreMatch[1]),
      scoreHigh: scoreMatch[2] ? Number(scoreMatch[2]) : undefined,
      explanation: explanationMatch[1].trim(),
      assumptions: assumptionsMatch ? assumptionsMatch[1].trim() : '',
      improvement: improvementMatch ? improvementMatch[1].trim() : ''
    };
  }

  return { buildScoringPrompt, parseScoreResponse, ARGUMENT_RUBRIC };
})();

function formatTranscripts(pairs){
  const combinedLines = [];
  const questionLines = [];
  const answerLines = [];
  pairs.forEach((pair, idx) => {
    if(!Array.isArray(pair) || pair.length !== 2){
      throw new Error("Each item in 'pairs' must be a 2-item sequence");
    }
    const [qRaw, aRaw] = pair;
    const q = String(qRaw).trim();
    const a = String(aRaw).trim();
    const n = idx + 1;
    combinedLines.push(`Q${n}: ${q}`);
    combinedLines.push(`A${n}: ${a}`);
    questionLines.push(`Question ${n}: ${q}`);
    answerLines.push(`Answer ${n}: ${a}`);
  });
  return [
    combinedLines.join('\n'),
    questionLines.join('\n'),
    answerLines.join('\n')
  ];
}
</script>
<script>
var OBJECTION_CHOICES=["Hearsay","Hearsay within Hearsay","Leading","Speculation","Lack of Foundation","Lack of Personal Knowledge","Compound","Improper Character","Improper Opinion","Asked & Answered","Relevance","Argumentative","Vague/Ambiguous","Nonresponsive","Beyond Scope","Assumes Facts Not in Evidence","Narrative","Misstates Evidence","Cumulative","Subsequent Remedial Measures","Compromise/Offers","Medical Payments","Plea Discussions","Insurance"];
var CURRENT_STATE='AZ';
function $(id){return document.getElementById(id);}
function Q(s){return Array.from(document.querySelectorAll(s));}
// Predeclare EngineState to avoid reference errors in non-browser environments.
var EngineState = { mode: 'chatgpt', openaiKey: '', openaiModel: 'gpt-4o', openaiMaxTokens: 600 };
// Ensure the script only runs in a browser environment.
if (typeof window !== 'undefined' && typeof document !== 'undefined') {
/* Debug + provenance */
let DEBUG_CHATGPT = true;
function showProvenance(msg, isErr=false){
  const s = document.getElementById('videoStatus');
  if(!s) return;
  const tag = isErr ? '\u26a0\ufe0f' : '\u2705';
  s.innerHTML = `<span style="font-weight:600">${tag} ${msg}</span>`;
  s.style.color = isErr ? '#ef9a9a' : '#9aa4b2';
}

/* Utilities */
function save(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function scoreToRating(score){
  const val=Number(score);
  if(!Number.isFinite(val)) return 'Unrated';
  if(val<40) return 'Terrible';
  if(val<60) return 'Bad';
  if(val<75) return 'Medium';
  if(val<90) return 'Good';
  return 'Amazing';
}
function shuffle(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}
function escHTML(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])):''}

function attachFollowupSender(id, handler){
  const el=$(id);
  if(!el||typeof handler!=='function') return;
  el.addEventListener('keydown',ev=>{
    if(ev.key!=='Enter') return;
    if(ev.shiftKey||ev.altKey||ev.isComposing) return;
    ev.preventDefault();
    handler();
  });
}

/* Robust JSON extraction (handles ```json fences) */
function extractFirstJson(str){
  if(!str) return null;
  const clean = str.replace(/```json\s*([\s\S]*?)```/i,'$1').replace(/```\s*([\s\S]*?)```/g,'$1').trim();
  try{ return JSON.parse(clean); }catch(_){}
  const start = clean.indexOf('{'); const end = clean.lastIndexOf('}');
  if(start!==-1 && end!==-1 && end>start){
    const cand = clean.slice(start,end+1);
    try{ return JSON.parse(cand); }catch(_){}
  }
  return null;
}

/* State data */
function makeRubricMap(stateName, abbr){
  return {
    opening:`Evaluate a ${stateName} high-school mock trial OPENING STATEMENT. Score on a 0–100 scale (multiply the 1–10 result by 10) using these weights: Case Theory & Record Integration 40, Roadmap & Structural Clarity 28, Theme Engagement & Momentum 17, Delivery & Courtroom Presence 15. Checklist: state the theme and burden, forecast the witnesses/exhibits that prove each chapter, preview the requested verdict, and stay confident without becoming argumentative. Reward concise openings that connect promises to specific record anchors; deduct when the theory, roadmap, or ask is vague or missing.`,
    closing:`Evaluate a ${stateName} high-school mock trial CLOSING ARGUMENT. Weights (total 100): Law & Fact Application 32, Structure & Chapter Flow 18, Refutation & Defense of Record 22, Narrative Drive & Ask 14, Delivery & Command 14. Checklist: restate the theme, walk element-by-element through the record, answer the opponent’s best points, emphasize the burden, and finish with a direct verdict ask. Reward closings that compare both cases with citations; deduct when it merely recaps testimony or ignores defense arguments.`,
    direct:`Evaluate a ${stateName} high-school mock trial DIRECT EXAMINATION. Weights: Chapters & Theory Advancement 24, Open Question Technique 24, Foundation & Exhibits 20, Listening & Follow-up Control 22, Delivery & Witness Connection 10. Look for conversational, non-leading chapters that advance the theory, proper foundations/authentication, responsive follow-ups, and confident courtroom manner. Deduct for leading/compound questions, missing foundations, or ignored witness drift; reward directs that feel like a guided story built on record facts.`,
    cross:`Evaluate a ${stateName} high-school mock trial CROSS EXAMINATION. Weights: Chapter Goals & Theory Impact 22, Leading Control & Pace 28, Impeachment & Admissions 25, Brevity & Question Craft 15, Delivery & Courtroom Presence 10. Checklist: tight leading questions, strategic admissions or impeachments, clear chapter purpose, and professional tone. Reward surgical, fact-anchored control; deduct when questions ramble, invite narrative answers, or skip obvious impeachment opportunities.`
  };
}
/* Global engine state */
EngineState = {
  get mode(){
    const stored = load('mtpl.engineMode','chatgpt');
    return stored === 'builtin' ? 'chatgpt' : stored;
  },
  set mode(v){
    const sanitized = v === 'builtin' ? 'chatgpt' : v;
    save('mtpl.engineMode', sanitized);
    renderModeBadge();
  },
  get openaiKey(){ return load('mtpl.openaiKey','') },
  set openaiKey(v){ save('mtpl.openaiKey', v||'') },
  get openaiModel(){ return load('mtpl.openaiModel','gpt-4o') },
  set openaiModel(v){ save('mtpl.openaiModel', v||'gpt-4o') },
  get openaiMaxTokens(){ return load('mtpl.openaiMaxTokens',600) },
  set openaiMaxTokens(v){ save('mtpl.openaiMaxTokens', Number(v)||600) }
};

if (EngineState.openaiKey && EngineState.mode !== 'chatgpt') {
  EngineState.mode = 'chatgpt';
}
renderModeBadge();

function renderModeBadge(){
  const b=$('modeBadge'), banner=$('videoModeBanner');
  if(!b) return;
  if(EngineState.mode==='chatgpt' && EngineState.openaiKey){
    b.textContent='Mode: ChatGPT (OpenAI API)';
    if(banner) banner.innerHTML = 'Scoring via <strong>ChatGPT (OpenAI API)</strong>.';
  } else {
    b.textContent='Mode: ChatGPT (API key required)';
    if(banner) banner.innerHTML = 'Add your OpenAI API key to enable scoring. Built-in scoring has been removed.';
  }
}

/* Navigation menu links */
document.addEventListener('DOMContentLoaded',()=>{
  const navMenu=$('navMenu');
  navMenu.addEventListener('click',e=>{
    const link=e.target.closest('a.tab');
    if(link){
      navMenu.classList.remove('open');
      $('menuToggle').setAttribute('aria-expanded','false');
    }
  });
});

/* Gateway wiring */
function openVideoGate(){ $('videoGate').style.display='flex'; $('openaiKey').value = EngineState.openaiKey||''; $('openaiModel').value=EngineState.openaiModel; $('openaiMaxTokens').value=EngineState.openaiMaxTokens; }
function closeVideoGate(){ $('videoGate').style.display='none' }
function maybeShowVideoGate(){
  const seen=load('mtpl.videoGateSeen',false);
  const hasKey=!!EngineState.openaiKey;
  if(!seen){
    openVideoGate();
    save('mtpl.videoGateSeen',true);
  } else if(!hasKey){
    openVideoGate();
  }
}
function attachVideoGateHandlers(){
  $('btnCloseGate').addEventListener('click', closeVideoGate);
  const builtinBtn=$('btnUseBuiltin');
  if(builtinBtn){
    builtinBtn.addEventListener('click', ()=>{
      alert('Built-in scoring has been retired. Add your ChatGPT API key to continue.');
    });
  }
  $('btnUseChatGPT').addEventListener('click', ()=>{
    const key = $('openaiKey').value.trim();
    const model = $('openaiModel').value;
    const maxt = Number($('openaiMaxTokens').value) || 600;
    // Accept sk- and sk-proj- and other future variants that start with sk-
    const isValidKey = /^sk-[A-Za-z0-9_-]{10,}$/.test(key);
    if (!isValidKey) {
      alert('Paste a valid OpenAI API key (starts with \u201csk-\u201d).');
      return;
    }
    EngineState.openaiKey=key; EngineState.openaiModel=model; EngineState.openaiMaxTokens=maxt; EngineState.mode='chatgpt';
    closeVideoGate(); renderModeBadge();
    $('videoStatus').textContent='ChatGPT scoring enabled. Paste or record a transcript, then click Re-score.';
  });
  $('btnForgetKey').addEventListener('click', ()=>{
    EngineState.openaiKey='';
    EngineState.mode='chatgpt';
    renderModeBadge();
    save('mtpl.videoGateSeen',false);
    $('videoStatus').textContent='Add your OpenAI API key to enable scoring.';
    alert('Removed saved API key. Built-in scoring is no longer available.');
  });
}
document.addEventListener('DOMContentLoaded', attachVideoGateHandlers);

function initKeyPage(){
  const openaiInput = $('keyPageOpenAI');
  const openaiModel = $('keyPageOpenAIModel');
  const openaiMax = $('keyPageOpenAIMaxTokens');
  if(!openaiInput || !openaiModel || !openaiMax) return;
  openaiInput.value = EngineState.openaiKey || '';
  openaiModel.value = EngineState.openaiModel;
  openaiMax.value = EngineState.openaiMaxTokens;
  $('saveOpenAI').addEventListener('click', ()=>{
    const key = openaiInput.value.trim();
    if(!/^sk-[A-Za-z0-9_-]{10,}$/.test(key)){
      alert('Paste a valid OpenAI key (starts with "sk-").');
      return;
    }
    EngineState.openaiKey = key;
    EngineState.openaiModel = openaiModel.value;
    EngineState.openaiMaxTokens = Number(openaiMax.value) || 600;
    EngineState.mode = 'chatgpt';
    renderModeBadge();
    alert('OpenAI key saved.');
  });
  $('removeOpenAI').addEventListener('click', ()=>{
    EngineState.openaiKey = '';
    EngineState.mode = 'chatgpt';
    openaiInput.value = '';
    renderModeBadge();
    save('mtpl.videoGateSeen', false);
    alert('OpenAI key removed. Built-in scoring is no longer available.');
  });
}
document.addEventListener('DOMContentLoaded', initKeyPage);

/* Env warnings + error surface */
function envWarn(){
  const el=$('videoStatus'); if(!el) return;
  const msgs=[];
  if(!window.isSecureContext && location.hostname!=='localhost') msgs.push('Use HTTPS or localhost for camera/mic.');
  try{ if(window.top!==window.self) msgs.push('If embedded: add allow="camera; microphone" on iframe.'); }catch(e){}
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) msgs.push('Camera API not available.');
  if(msgs.length) el.textContent = msgs.join(' ');
}
window.addEventListener('error', e=>{
  const s=$('videoStatus'); if(s) { s.textContent = 'JS Error: '+(e?.message||'error'); s.style.color='#ef9a9a'; }
});
window.addEventListener('unhandledrejection', e=>{
  const s=$('videoStatus'); if(s){ s.textContent = 'Promise error: '+(e?.reason?.message||String(e?.reason||'error')); s.style.color='#ef9a9a'; }
});

/* Legacy stub retained */
function evaluateRubric(){ return {org:4,delivery:5,content:4,presence:6,words:0,wpm:0,fillers:0,legalKeywords:0,signposts:0}; }

} // end browser check

</script>
<script>
// --- Global audio helpers (used by Objections + Video Coach) ---
(async function attachGlobalAudioHelpers(){
  const root = (typeof globalThis!=="undefined") ? globalThis : window;

  // Convert an audio/video Blob to WAV (mono/stereo preserved)
  root.blobToWav = async function blobToWav(file){
    const arrayBuffer = await file.arrayBuffer();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    const numChannels = audioBuffer.numberOfChannels;
    const sampleRate = audioBuffer.sampleRate;
    const length = audioBuffer.length * numChannels * 2 + 44;
    const buffer = new ArrayBuffer(length);
    const view = new DataView(buffer);
    let offset = 0;
    function writeString(str){ for(let i=0;i<str.length;i++) view.setUint8(offset++, str.charCodeAt(i)); }
    function writeUint16(d){ view.setUint16(offset, d, true); offset += 2; }
    function writeUint32(d){ view.setUint32(offset, d, true); offset += 4; }
    writeString('RIFF'); writeUint32(length - 8); writeString('WAVE'); writeString('fmt ');
    writeUint32(16); writeUint16(1); writeUint16(numChannels);
    writeUint32(sampleRate); writeUint32(sampleRate * numChannels * 2);
    writeUint16(numChannels * 2); writeUint16(16); writeString('data'); writeUint32(length - 44);
    const channels = [];
    for (let c=0;c<numChannels;c++) channels.push(audioBuffer.getChannelData(c));
    for (let i=0;i<audioBuffer.length;i++){
      for (let c=0;c<numChannels;c++){
        const sample = Math.max(-1, Math.min(1, channels[c][i]));
        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
        offset += 2;
      }
    }
    return new Blob([buffer], {type:'audio/wav'});
  };

  // Transcribe with OpenAI (tries multiple models, graceful fallback)
  root.transcribeFile = async function transcribeFile(file, filenameHint){
    const key = (typeof EngineState!=="undefined") ? EngineState.openaiKey : "";
    if(!key) return "";

    const tryModels = ["whisper-1", "gpt-4o-transcribe"];
    const mkForm = (f, name) => {
      const form = new FormData();
      form.append("file", f, name || "audio.wav");
      form.append("temperature", "0");
      return form;
    };

    for (const m of tryModels) {
      try {
        const form = mkForm(file, filenameHint || "audio.wav");
        form.append("model", m);
        const resp = await fetch("https://api.openai.com/v1/audio/transcriptions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${key}` },
          body: form
        });
        const data = await resp.json();
        if (data?.text) return data.text.trim();
        if (data?.error?.message) throw new Error(data.error.message);
      } catch (_e) {
        // try the next model
      }
    }
    return "";
  };

  root.transcribeFileDetailed = async function transcribeFileDetailed(file, filenameHint){
    const key = (typeof EngineState!=="undefined") ? EngineState.openaiKey : "";
    if(!key) return { text:"", words:[] };
    const tryModels=["whisper-1","gpt-4o-transcribe"];
    const mkForm=(f,name)=>{
      const form=new FormData();
      form.append("file",f,name||"audio.wav");
      form.append("temperature","0");
      form.append("response_format","verbose_json");
      form.append("timestamp_granularities[]","word");
      return form;
    };
    for(const m of tryModels){
      try{
        const form=mkForm(file,filenameHint||"audio.wav");
        form.append("model",m);
        const resp=await fetch("https://api.openai.com/v1/audio/transcriptions",{
          method:"POST",
          headers:{"Authorization":`Bearer ${key}`},
          body:form
        });
        const data=await resp.json();
        if(data?.text){
          const words=[];
          if(Array.isArray(data.words)){
            data.words.forEach(w=>{ if(w?.word) words.push({word:w.word,start:w.start,end:w.end}); });
          } else if(Array.isArray(data.segments)){
            data.segments.forEach(seg=>{
              if(Array.isArray(seg.words)){
                seg.words.forEach(w=>{ if(w?.word) words.push({word:w.word,start:w.start,end:w.end}); });
              }
            });
          }
          return { text:data.text.trim(), words };
        }
        if(data?.error?.message) throw new Error(data.error.message);
      }catch(_e){
        // try next model
      }
    }
    return { text:"", words:[] };
  };
})();
</script>
<script>
// --- REPLACE callOpenAIChat with this hardened version ---
async function callOpenAIChat({ messages, model, maxTokens = 600, json = false, signal }) {
  if (!EngineState.openaiKey || !/^sk-[A-Za-z0-9_-]{10,}/.test(EngineState.openaiKey)) {
    const err = new Error('Missing or malformed OpenAI API key.');
    err.type = 'config';
    throw err;
  }

  // 1) Quick ping to fail fast on invalid key/quota
  async function ping() {
    try {
      const r = await fetch('https://api.openai.com/v1/models', {
        method: 'GET',
        headers: { Authorization: `Bearer ${EngineState.openaiKey}` },
        cache: 'no-store',
        keepalive: true,
      });
      if (!r.ok) {
        const t = await r.text().catch(()=> '');
        let msg = 'OpenAI auth/models check failed';
        try { const j = JSON.parse(t); msg = j?.error?.message || msg; } catch (parseErr) {}
        const e = new Error(msg);
        e.status = r.status;
        throw e;
      }
    } catch (e) {
      // Don’t block if ping fails due to adblockers; only throw on clear auth errors
      if (e?.status === 401 || e?.status === 429 || e?.status === 403) throw e;
    }
  }

  // 2) Try the ping, but ignore network-only failures
  try { await ping(); } catch (e) { /* surface later if main call fails */ }

  const baseBody = {
    model,
    messages,
    temperature: 0,
    max_tokens: Math.max(50, Math.min(8192, Number(maxTokens) || 600)),
  };

  async function attempt(useJson) {
    const body = useJson
      ? { ...baseBody, response_format: { type: 'json_object' } }
      : baseBody;

    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${EngineState.openaiKey}`,
      },
      body: JSON.stringify(body),
      signal,
      cache: 'no-store',
      keepalive: true,
    });

    // Read text first to preserve error detail
    const rawText = await resp.text();
    let data = null;
    try { data = JSON.parse(rawText); } catch (parseErr) {}

    if (!resp.ok) {
      const e = new Error(
        data?.error?.message ||
        `OpenAI HTTP ${resp.status}${rawText ? ` — ${rawText.slice(0, 200)}` : ''}`
      );
      e.status = resp.status;
      e.code = data?.error?.code;
      e.type = data?.error?.type;
      e.raw = data || rawText;
      throw e;
    }

    const content = data?.choices?.[0]?.message?.content ?? '';
    if (typeof content === 'string') return content;
    if (Array.isArray(content)) return content.map(p => p?.text || '').join('');
    return String(content || '');
  }

  // 3) Try JSON first, gracefully fall back to text
  try {
    return await attempt(json);
  } catch (e) {
    const msg = String(e?.message || '').toLowerCase();
    const isSchemaish = msg.includes('response_format') || msg.includes('json');
    if (json && (e.status === 400 || isSchemaish)) {
      // Retry in plain text mode
      return await attempt(false);
    }
    if (e.status === 429) e.code = e.code || 'rate_limit';
    throw e;
  }
}

</script>
<script>
if (typeof window !== 'undefined' && typeof document !== 'undefined') {
/* Objections module (full) */

const Objections=(function(){
 const DB=[
  {fact:"Witness: 'My friend told me the light was red.'",ans:"Hearsay",rule:"801/802",why:"Out-of-court statement for truth.",q:"Best objection?"},
  {fact:"Officer: 'The neighbor said he saw the defendant running.'",ans:"Hearsay",rule:"801/802",why:"Non-testifying declarant.",q:"Best objection?"},
  {fact:"Witness: 'She nodded yes when I asked if she was drunk.'",ans:"Hearsay",rule:"801(a)/(c)",why:"Nonverbal assertion.",q:"Best objection?"},
  {fact:"Witness: 'My boss said HR told him policy changed.'",ans:"Hearsay within Hearsay",rule:"805",why:"Multiple layers.",q:"Best objection?"},
  {fact:"On direct: 'You were texting while driving, right?'",ans:"Leading",rule:"611(c)",why:"Leading on direct.",q:"Best objection?"},
  {fact:"Witness: 'He intended to rob me.'",ans:"Speculation",rule:"602",why:"Mental state speculation.",q:"Best objection?"},
  {fact:"Counsel moves to admit Exhibit 5 without sponsor.",ans:"Lack of Foundation",rule:"104/602/901",why:"No predicate laid.",q:"Best objection?"},
  {fact:"Counsel: 'Did you call and write to the insurer?'",ans:"Compound",rule:"611(a)",why:"Two questions in one.",q:"Best objection?"},
  {fact:"Counsel: 'You're lying to get a payout, aren't you?'",ans:"Argumentative",rule:"611(a)",why:"Badgering.",q:"Best objection?"},
  {fact:"Counsel repeats same question after answer.",ans:"Asked & Answered",rule:"611(a)",why:"Repetition.",q:"Best objection?"},
  {fact:"On cross: entirely new topics not on direct.",ans:"Beyond Scope",rule:"611(b)",why:"Beyond scope.",q:"Best objection?"},
  {fact:"Q: 'When was it?' (no context)",ans:"Vague/Ambiguous",rule:"611(a)",why:"Unclear.",q:"Best objection?"},
  {fact:"Q misquotes exhibit contents.",ans:"Misstates Evidence",rule:"403/611",why:"Mischaracterizes evidence.",q:"Best objection?"},
  {fact:"Q assumes unproven premise.",ans:"Assumes Facts Not in Evidence",rule:"611(a)",why:"Presumes disputed fact.",q:"Best objection?"},
  {fact:"Witness gives long story beyond question.",ans:"Narrative",rule:"611(a)",why:"Narrative/nonresponsive.",q:"Best objection?"},
  {fact:"Sixth witness repeats identical fact.",ans:"Cumulative",rule:"403",why:"Needless cumulation.",q:"Best objection?"},
  {fact:"Counsel: 'He has a reputation for speeding so he sped here.'",ans:"Improper Character",rule:"404(a)",why:"Propensity.",q:"Best objection?"},
  {fact:"Lay witness: 'He was negligent.'",ans:"Improper Opinion",rule:"701",why:"Legal conclusion.",q:"Best objection?"},
  {fact:"After accident company installed guardrails (to prove negligence).",ans:"Subsequent Remedial Measures",rule:"407",why:"Not to prove negligence.",q:"Best objection?"},
  {fact:"'Didn't defendant offer to pay medical bills?'",ans:"Medical Payments",rule:"409",why:"Not to prove liability.",q:"Best objection?"},
  {fact:"'You tried to settle for $5,000, right?'",ans:"Compromise/Offers",rule:"408(a)",why:"Settlement talks.",q:"Best objection?"},
  {fact:"'You have car insurance, correct?' (to show fault)",ans:"Insurance",rule:"411",why:"Insurance \u2260 negligence.",q:"Best objection?"},
  {fact:"'In plea talks you admitted speeding, right?'",ans:"Plea Discussions",rule:"410(a)",why:"Plea statements.",q:"Best objection?"},
  {fact:"Witness: 'My accountant told me the books were falsified.'",ans:"Hearsay",rule:"801/802",why:"Out-of-court statement for truth.",q:"Best objection?"},
  {fact:"Witness: 'The shopkeeper said the defendant looked nervous.'",ans:"Hearsay",rule:"801/802",why:"Out-of-court statement offered for truth.",q:"Best objection?"},
  {fact:"Witness: 'My mother said the signal was green.'",ans:"Hearsay",rule:"801/802",why:"Statement from non-testifying declarant.",q:"Best objection?"},
  {fact:"Witness: 'According to the police report, the suspect confessed.'",ans:"Hearsay",rule:"801/802",why:"Report is an out-of-court statement.",q:"Best objection?"},
  {fact:"Witness: 'My coworker said the manager heard the janitor admit stealing.'",ans:"Hearsay within Hearsay",rule:"805",why:"Multiple out-of-court layers.",q:"Best objection?"},
  {fact:"Witness: 'The letter quotes a doctor saying the nurse repeated the patient's words.'",ans:"Hearsay within Hearsay",rule:"805",why:"Quoted statement contains another statement.",q:"Best objection?"},
  {fact:"Witness: 'She texted me that her brother claimed the witness lied.'",ans:"Hearsay within Hearsay",rule:"805",why:"Text relays secondhand claim.",q:"Best objection?"},
  {fact:"Witness: 'The memo states an informant told detectives the victim shouted.'",ans:"Hearsay within Hearsay",rule:"805",why:"Memo contains declarant reporting another declarant.",q:"Best objection?"},
  {fact:"On direct: 'You met the defendant on April 3, didn't you?'",ans:"Leading",rule:"611(c)",why:"Suggests answer on direct.",q:"Best objection?"},
  {fact:"On direct: 'You saw him hit the brake, right?'",ans:"Leading",rule:"611(c)",why:"Leading question on direct.",q:"Best objection?"},
  {fact:"On direct: 'And then you called 911, correct?'",ans:"Leading",rule:"611(c)",why:"Suggests sequence on direct.",q:"Best objection?"},
  {fact:"On direct: 'It's true you were angry that night, isn't it?'",ans:"Leading",rule:"611(c)",why:"Counsel suggests the answer.",q:"Best objection?"},
  {fact:"Witness: 'He must have been speeding because he was late.'",ans:"Speculation",rule:"602",why:"Inference about speed without perception.",q:"Best objection?"},
  {fact:"Witness: 'She probably hid the evidence to protect herself.'",ans:"Speculation",rule:"602",why:"Guessing about motive.",q:"Best objection?"},
  {fact:"Witness: 'I think he intended to burn the documents.'",ans:"Speculation",rule:"602",why:"Speculates on intent.",q:"Best objection?"},
  {fact:"Witness: 'He looked like he wanted to fight.'",ans:"Speculation",rule:"602",why:"Opinion on unperceived mental state.",q:"Best objection?"},
  {fact:"Counsel offers a photo with no testimony about who took it.",ans:"Lack of Foundation",rule:"104/602/901",why:"No predicate for authenticity.",q:"Best objection?"},
  {fact:"Counsel introduces a contract without establishing authenticity.",ans:"Lack of Foundation",rule:"104/602/901",why:"Document not authenticated.",q:"Best objection?"},
  {fact:"Counsel asks an expert for an opinion before qualifying them.",ans:"Lack of Foundation",rule:"104/702",why:"Expert not yet qualified.",q:"Best objection?"},
  {fact:"Counsel shows a weapon without proving chain of custody.",ans:"Lack of Foundation",rule:"104/901",why:"No evidence it's the same item.",q:"Best objection?"},
  {fact:"Witness: 'I heard the alarm, so the fire started in the kitchen.'",ans:"Lack of Personal Knowledge",rule:"602",why:"Assumes facts without observation.",q:"Best objection?"},
  {fact:"Witness: 'They told me the defendant was out of town.'",ans:"Lack of Personal Knowledge",rule:"602",why:"Relies on others' statements.",q:"Best objection?"},
  {fact:"Witness: 'I assume the car was stolen because the window was broken.'",ans:"Lack of Personal Knowledge",rule:"602",why:"No firsthand knowledge of theft.",q:"Best objection?"},
  {fact:"Witness: 'The document looked real to me.'",ans:"Lack of Personal Knowledge",rule:"602",why:"Opinion without basis in perception.",q:"Best objection?"},
  {fact:"Counsel: 'Did you grab the phone and run out the door?'",ans:"Compound",rule:"611(a)",why:"Two questions in one.",q:"Best objection?"},
  {fact:"Counsel: 'You spoke to the manager and sent the email?'",ans:"Compound",rule:"611(a)",why:"Multiple inquiries at once.",q:"Best objection?"},
  {fact:"Counsel: 'Isn't it true you called, texted, and visited the victim?'",ans:"Compound",rule:"611(a)",why:"Several questions combined.",q:"Best objection?"},
  {fact:"Counsel: 'You checked the lock and opened the safe, right?'",ans:"Compound",rule:"611(a)",why:"Two actions in single question.",q:"Best objection?"},
  {fact:"Counsel: 'Aren't you known for being dishonest?'",ans:"Improper Character",rule:"404(a)",why:"Attacks propensity for dishonesty.",q:"Best objection?"},
  {fact:"Counsel: 'You have a reputation for fighting, don't you?'",ans:"Improper Character",rule:"404(a)",why:"Propensity evidence.",q:"Best objection?"},
  {fact:"Counsel: 'Because you're clumsy, you tripped that day?'",ans:"Improper Character",rule:"404(a)",why:"Uses trait to prove conduct.",q:"Best objection?"},
  {fact:"Counsel: 'He was fired for theft before, so he stole here.'",ans:"Improper Character",rule:"404(a)",why:"Prior acts to show propensity.",q:"Best objection?"},
  {fact:"Lay witness: 'The contract is legally binding.'",ans:"Improper Opinion",rule:"701",why:"Legal conclusion from lay witness.",q:"Best objection?"},
  {fact:"Lay witness: 'The driver was negligent.'",ans:"Improper Opinion",rule:"701",why:"Invades province of jury.",q:"Best objection?"},
  {fact:"Lay witness: 'He was guilty.'",ans:"Improper Opinion",rule:"701",why:"Ultimate legal conclusion by lay witness.",q:"Best objection?"},
  {fact:"Lay witness: 'The medicine caused her illness.'",ans:"Improper Opinion",rule:"701",why:"Requires expert testimony.",q:"Best objection?"},
  {fact:"Counsel repeats 'What time did you arrive?' after answer given.",ans:"Asked & Answered",rule:"611(a)",why:"Question already answered.",q:"Best objection?"},
  {fact:"Counsel re-asks 'Did you sign the check?' despite prior answer.",ans:"Asked & Answered",rule:"611(a)",why:"Repeated question.",q:"Best objection?"},
  {fact:"Counsel keeps asking 'Were you angry?' though witness answered.",ans:"Asked & Answered",rule:"611(a)",why:"Repetition.",q:"Best objection?"},
  {fact:"Counsel asks again 'Where were you seated?' after response.",ans:"Asked & Answered",rule:"611(a)",why:"Asked and answered.",q:"Best objection?"},
  {fact:"Counsel: 'What is your favorite movie?'",ans:"Relevance",rule:"401/402",why:"No bearing on case.",q:"Best objection?"},
  {fact:"Counsel: 'How many pets do you own?'",ans:"Relevance",rule:"401/402",why:"Irrelevant personal detail.",q:"Best objection?"},
  {fact:"Counsel: 'What did you eat for breakfast?'",ans:"Relevance",rule:"401/402",why:"Does not make fact more or less probable.",q:"Best objection?"},
  {fact:"Counsel: 'Where did you vacation last summer?'",ans:"Relevance",rule:"401/402",why:"Unrelated to issues.",q:"Best objection?"},
  {fact:"Counsel: 'Isn't it true you're just making this up?'",ans:"Argumentative",rule:"611(a)",why:"Badgers the witness.",q:"Best objection?"},
  {fact:"Counsel: 'You think you're smarter than everyone, don't you?'",ans:"Argumentative",rule:"611(a)",why:"Seeks argument, not facts.",q:"Best objection?"},
  {fact:"Counsel: 'Why are you lying to the court?'",ans:"Argumentative",rule:"611(a)",why:"Accuses witness instead of eliciting facts.",q:"Best objection?"},
  {fact:"Counsel: 'Is this how you always deceive people?'",ans:"Argumentative",rule:"611(a)",why:"Argumentative/insulting.",q:"Best objection?"},
  {fact:"Counsel: 'Was the thing big?'",ans:"Vague/Ambiguous",rule:"611(a)",why:"Unclear reference.",q:"Best objection?"},
  {fact:"Counsel: 'Did you do it earlier?'",ans:"Vague/Ambiguous",rule:"611(a)",why:"Ambiguous timing.",q:"Best objection?"},
  {fact:"Counsel: 'Was it handled the usual way?'",ans:"Vague/Ambiguous",rule:"611(a)",why:"Undefined terms.",q:"Best objection?"},
  {fact:"Counsel: 'Were they over there then?'",ans:"Vague/Ambiguous",rule:"611(a)",why:"Confusing question.",q:"Best objection?"},
  {fact:"Q: 'Did you see the crash?' Witness: 'I've driven that road for years and know every turn.'",ans:"Nonresponsive",rule:"611(a)",why:"Answer fails to address question.",q:"Best objection?"},
  {fact:"Q: 'What time was it?' Witness: 'Well, I left home early and grabbed coffee.'",ans:"Nonresponsive",rule:"611(a)",why:"Does not answer time asked.",q:"Best objection?"},
  {fact:"Q: 'Did you sign the contract?' Witness: 'My lawyer advised me about the deal.'",ans:"Nonresponsive",rule:"611(a)",why:"Does not answer whether signed.",q:"Best objection?"},
  {fact:"Q: 'Was the light red?' Witness: 'I was worried about my job that day.'",ans:"Nonresponsive",rule:"611(a)",why:"Avoids direct answer.",q:"Best objection?"},
  {fact:"On cross, counsel asks about defendant's finances not on direct.",ans:"Beyond Scope",rule:"611(b)",why:"Topic not covered on direct.",q:"Best objection?"},
  {fact:"On cross, counsel questions witness about unrelated prior lawsuit.",ans:"Beyond Scope",rule:"611(b)",why:"Outside scope of direct examination.",q:"Best objection?"},
  {fact:"On cross, counsel explores new theory not covered in direct.",ans:"Beyond Scope",rule:"611(b)",why:"Introduces entirely new subject.",q:"Best objection?"},
  {fact:"On cross, counsel delves into medical history not raised earlier.",ans:"Beyond Scope",rule:"611(b)",why:"Exceeds scope of direct.",q:"Best objection?"},
  {fact:"Counsel: 'When did you stop embezzling funds?'",ans:"Assumes Facts Not in Evidence",rule:"611(a)",why:"Presumes embezzlement without proof.",q:"Best objection?"},
  {fact:"Counsel: 'Where did you hide the stolen car?'",ans:"Assumes Facts Not in Evidence",rule:"611(a)",why:"Assumes theft not in evidence.",q:"Best objection?"},
  {fact:"Counsel: 'After you hit the victim, what did you do?'",ans:"Assumes Facts Not in Evidence",rule:"611(a)",why:"Assumes act not established.",q:"Best objection?"},
  {fact:"Counsel: 'How often do you meet your accomplice?'",ans:"Assumes Facts Not in Evidence",rule:"611(a)",why:"Presumes accomplice relationship.",q:"Best objection?"},
  {fact:"Witness launches into entire day instead of answering question.",ans:"Narrative",rule:"611(a)",why:"Provides narrative beyond question.",q:"Best objection?"},
  {fact:"Witness explains events from childhood unrelated to question.",ans:"Narrative",rule:"611(a)",why:"Narrative beyond scope.",q:"Best objection?"},
  {fact:"Witness gives long story about career before answering.",ans:"Narrative",rule:"611(a)",why:"Unnecessary narrative.",q:"Best objection?"},
  {fact:"Witness recites conversation line-by-line beyond question.",ans:"Narrative",rule:"611(a)",why:"Excessive narrative response.",q:"Best objection?"},
  {fact:"Counsel: 'You said the meeting was on Tuesday,' but witness said Monday.",ans:"Misstates Evidence",rule:"403/611",why:"Misquotes prior testimony.",q:"Best objection?"},
  {fact:"Counsel claims exhibit shows $5,000 when it shows $500.",ans:"Misstates Evidence",rule:"403/611",why:"Mischaracterizes exhibit.",q:"Best objection?"},
  {fact:"Counsel says witness identified a knife though they said gun.",ans:"Misstates Evidence",rule:"403/611",why:"Alters prior statement.",q:"Best objection?"},
  {fact:"Counsel asserts witness saw two people though they said one.",ans:"Misstates Evidence",rule:"403/611",why:"Misstates testimony.",q:"Best objection?"},
  {fact:"Tenth witness repeats same statement about weather.",ans:"Cumulative",rule:"403",why:"Needlessly presents same fact.",q:"Best objection?"},
  {fact:"Counsel introduces third photo of same scene already proven.",ans:"Cumulative",rule:"403",why:"Excessive evidence on same point.",q:"Best objection?"},
  {fact:"Multiple witnesses testify to same conversation already established.",ans:"Cumulative",rule:"403",why:"Repetition of evidence.",q:"Best objection?"},
  {fact:"Counsel asks another officer to repeat testimony of first officer.",ans:"Cumulative",rule:"403",why:"Cumulative witness testimony.",q:"Best objection?"},
  {fact:"'After the accident, you installed brighter lights, correct?'",ans:"Subsequent Remedial Measures",rule:"407",why:"Post-accident fix to prove negligence.",q:"Best objection?"},
  {fact:"'You added guardrails after the fall, didn't you?'",ans:"Subsequent Remedial Measures",rule:"407",why:"Later safety measure.",q:"Best objection?"},
  {fact:"'The company rewrote the manual after the incident?'",ans:"Subsequent Remedial Measures",rule:"407",why:"Post-event change.",q:"Best objection?"},
  {fact:"'You replaced the ladder after the worker slipped?'",ans:"Subsequent Remedial Measures",rule:"407",why:"Subsequent repair offered for negligence.",q:"Best objection?"},
  {fact:"'You proposed settling the claim for half the amount?'",ans:"Compromise/Offers",rule:"408(a)",why:"Settlement offer.",q:"Best objection?"},
  {fact:"'He emailed offering to resolve the dispute without trial?'",ans:"Compromise/Offers",rule:"408(a)",why:"Settlement discussion.",q:"Best objection?"},
  {fact:"'You suggested mediation and offered compensation?'",ans:"Compromise/Offers",rule:"408(a)",why:"Attempt to compromise claim.",q:"Best objection?"},
  {fact:"'She promised payment if plaintiff dropped the case?'",ans:"Compromise/Offers",rule:"408(a)",why:"Settlement offer.",q:"Best objection?"},
  {fact:"'Didn't you pay her hospital bill to show you cared?'",ans:"Medical Payments",rule:"409",why:"Offer to pay medical expenses.",q:"Best objection?"},
  {fact:"'He offered to cover surgery costs?'",ans:"Medical Payments",rule:"409",why:"Payment for medical expenses.",q:"Best objection?"},
  {fact:"'You sent money for her rehab, correct?'",ans:"Medical Payments",rule:"409",why:"Medical payment evidence.",q:"Best objection?"},
  {fact:"'He reimbursed ambulance fees, right?'",ans:"Medical Payments",rule:"409",why:"Offer to pay medical bill.",q:"Best objection?"},
  {fact:"'During plea talks, you admitted the burglary, correct?'",ans:"Plea Discussions",rule:"410(a)",why:"Statement during plea negotiations.",q:"Best objection?"},
  {fact:"'In negotiations with the prosecutor, you said you'd plead guilty?'",ans:"Plea Discussions",rule:"410(a)",why:"Plea discussion statement.",q:"Best objection?"},
  {fact:"'You offered to plead to a lesser offense in a meeting with the DA?'",ans:"Plea Discussions",rule:"410(a)",why:"Plea bargaining statement.",q:"Best objection?"},
  {fact:"'You discussed pleading in exchange for testimony?'",ans:"Plea Discussions",rule:"410(a)",why:"Plea negotiation statement.",q:"Best objection?"},
  {fact:"'Your insurance paid for the damage, didn't it?'",ans:"Insurance",rule:"411",why:"Evidence of insurance to prove liability.",q:"Best objection?"},
  {fact:"'You filed a claim with your insurer after the crash?'",ans:"Insurance",rule:"411",why:"Insurance offered for negligence.",q:"Best objection?"},
  {fact:"'Isn't it true your liability policy would cover this?'",ans:"Insurance",rule:"411",why:"Insurance to show fault.",q:"Best objection?"},
  {fact:"'Insurance would reimburse you if found liable?'",ans:"Insurance",rule:"411",why:"Insurance evidence to prove negligence.",q:"Best objection?"},
  {fact:"Witness: 'The news reported the defendant confessed.'",ans:"Hearsay",rule:"801/802",why:"Media report offered for truth.",q:"Best objection?"},
  {fact:"On direct: 'He ignored the warning signs, didn't he?'",ans:"Leading",rule:"611(c)",why:"Suggests answer on direct.",q:"Best objection?"},
  {fact:"Counsel offers a digital log without proof of accuracy.",ans:"Lack of Foundation",rule:"104/901",why:"No authentication of electronic record.",q:"Best objection?"},
  {fact:"Counsel: 'Isn't your favorite color blue?'",ans:"Relevance",rule:"401/402",why:"Irrelevant personal preference.",q:"Best objection?"}
 ];
 const CORE=new Set(["Hearsay","Leading","Speculation","Lack of Foundation","Lack of Personal Knowledge","Compound","Argumentative","Asked & Answered","Beyond Scope","Vague/Ambiguous","Nonresponsive","Relevance"]);
 const ADV=new Set(["Hearsay within Hearsay","Misstates Evidence","Assumes Facts Not in Evidence","Narrative","Cumulative","Improper Character","Improper Opinion","Subsequent Remedial Measures","Compromise/Offers","Medical Payments","Plea Discussions","Insurance"]);
 function cat(a){if(a.includes('Hearsay'))return'Hearsay';if(["Leading","Argumentative","Asked & Answered","Beyond Scope","Vague/Ambiguous","Nonresponsive","Compound","Assumes Facts Not in Evidence","Narrative","Misstates Evidence"].includes(a))return'611 Control';if(["Lack of Foundation","Lack of Personal Knowledge"].includes(a))return'Foundation';if(a==="Improper Opinion")return'Opinion/Experts';if(a==="Improper Character")return'Character/404';if(["Relevance","Cumulative"].includes(a))return'Relevance/403';if(["Subsequent Remedial Measures","Compromise/Offers","Medical Payments","Plea Discussions","Insurance"].includes(a))return'Policy Exclusions';return'Other'}
function passDiff(ans,d){if(d==='both')return true;const isCore=CORE.has(ans);return d==='core'?isCore:ADV.has(ans)||!isCore}
let cur=null, stats=load('mtpl.objStats',{}), gptChat=[], gptRecog=null, gptRecStream=null, gptSendLocked=false,
    lastJudgeContext=null, judgeFollowupChat=[], judgeFollowupSending=false;
function updateGPTSend(){
 $('btnGPTSend').disabled=gptSendLocked || !$('objGPTInput').value.trim();
}
function appendChat(role,text){
 const out=$('objGPTChat');
 const div=document.createElement('div');
 div.className=`chat-entry ${role}`;
 const label=document.createElement('strong');
 label.textContent=role==='user'? 'You:' : role==='judge'? 'Judge:' : 'ChatGPT:';
 div.appendChild(label);
 div.appendChild(document.createTextNode(' '+text));
 out.appendChild(div);
 out.scrollTop=out.scrollHeight;
}
function appendJudgeDecision(res){
 const out=$('objGPTChat');
 const div=document.createElement('div');
 div.className='chat-entry judge';
 const label=document.createElement('strong');
 label.textContent='Judge:';
 div.appendChild(label);

 const scoreLow=typeof res.scoreLow==='number'&&!Number.isNaN(res.scoreLow)?res.scoreLow:null;
 const scoreHigh=typeof res.scoreHigh==='number'&&!Number.isNaN(res.scoreHigh)?res.scoreHigh:null;
 const outstanding=scoreLow!==null&&scoreLow>=9&&(scoreHigh===null||scoreHigh>=9);
 if(outstanding&&res.ruling){
  const short=document.createElement('span');
  const rulingText=res.ruling.toLowerCase()==='sustained'?'Objection sustained.':'Objection overruled.';
  short.textContent=` ${rulingText} Judge sides with you.`;
  div.appendChild(short);
  out.appendChild(div);
  out.scrollTop=out.scrollHeight;
  return;
 }

 const ruling=document.createElement('div');
 ruling.innerHTML=`<strong>Ruling:</strong> ${escHTML(res.ruling||'')}`;
 div.appendChild(ruling);
 if(res.summary){
  const sum=document.createElement('div');
  sum.innerHTML=`<strong>Summary:</strong> ${escHTML(res.summary)}`;
  div.appendChild(sum);
 }
 if(res.score){
  const score=document.createElement('div');
  score.hidden=true;
  score.innerHTML=`<strong>Score Range:</strong> ${escHTML(res.score)}`;
  div.appendChild(score);
 }
 const explain=document.createElement('div');
 explain.innerHTML=`<strong>Explanation:</strong> ${escHTML(res.explanation)}`;
 div.appendChild(explain);
 if(res.assumptions){
  const as=document.createElement('div');
  as.innerHTML=`<strong>Assumptions:</strong> ${escHTML(res.assumptions)}`;
  div.appendChild(as);
 }
 if(res.improvement){
  const improv=document.createElement('div');
  improv.innerHTML=`<strong>Improvements:</strong> ${escHTML(res.improvement)}`;
  div.appendChild(improv);
 }
 out.appendChild(div);
 out.scrollTop=out.scrollHeight;
}

function buildJudgeSummaryText(res){
 const lines=[];
 if(res?.summary) lines.push(`Summary: ${res.summary}`);
 if(res?.score) lines.push(`Score Range: ${res.score}`);
 if(res?.explanation) lines.push(`Explanation: ${res.explanation}`);
 if(res?.assumptions) lines.push(`Assumptions: ${res.assumptions}`);
 if(res?.improvement) lines.push(`Improvements: ${res.improvement}`);
 return lines.join('\n');
}

function updateJudgeFollowupStatus(msg,isError=false){
 const el=$('objJudgeFollowupStatus');
 if(!el) return;
 el.textContent=msg||'';
 el.style.color=isError?'#ef4444':'inherit';
}

function resetJudgeFollowup(){
 lastJudgeContext=null;
 judgeFollowupChat=[];
 judgeFollowupSending=false;
 const wrap=$('objJudgeFollowupWrap');
 const input=$('objJudgeFollowup');
 if(wrap) wrap.hidden=true;
 if(input){ input.value=''; input.disabled=true; }
 updateJudgeFollowupStatus('');
}

  function prepareJudgeFollowup(summaryText, transcript, rawText){
    lastJudgeContext={summaryText, transcript, rawText};
    judgeFollowupChat=[
      {role:'system',content:'You are the same mock trial judge who just evaluated the competitor. Provide clarifications referencing your prior ruling and the transcript. Only change scores if explicitly requested.'}
    ];
    if(summaryText){
     judgeFollowupChat.push({role:'assistant',content:summaryText});
    }
    if(rawText && rawText!==summaryText){
     judgeFollowupChat.push({role:'assistant',content:rawText});
    }
    const chat=$('objGPTChat');
    if(chat) chat.hidden=false;
    const wrap=$('objJudgeFollowupWrap');
    const input=$('objJudgeFollowup');
    const ready=EngineState.mode==='chatgpt' && !!EngineState.openaiKey;
    if(wrap) wrap.hidden=false;
    if(input){
      input.value='';
      input.disabled=!ready;
      if(ready) input.focus();
    }
    updateJudgeFollowupStatus(ready?
      'Follow-up ready. Ask the judge for clarification or guidance.' :
      'Enter a ChatGPT API key and enable ChatGPT mode to send follow-up questions.',
      !ready
    );
  }

async function sendJudgeFollowup(){
 if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
  alert('ChatGPT mode not enabled or API key missing.');
  return;
 }
 if(!lastJudgeContext){
  alert('Request a ChatGPT score first.');
  return;
 }
 const input=$('objJudgeFollowup');
 if(!input) return;
 const question=input.value.trim();
 if(judgeFollowupSending) return;
 if(!question){
  updateJudgeFollowupStatus('Type a follow-up question before sending.', true);
  return;
 }
 judgeFollowupSending=true;
 input.disabled=true;
 const chat=$('objGPTChat');
 if(chat) chat.hidden=false;
 appendChat('user',question);
 const contextParts=[];
  if(lastJudgeContext.summaryText){
  contextParts.push(`Your previous evaluation (structured summary):\n${lastJudgeContext.summaryText}`);
 }
  if(lastJudgeContext.rawText){
  contextParts.push(`Your original evaluation text:\n${lastJudgeContext.rawText}`);
 }
 contextParts.push(`Transcript evaluated:\n${lastJudgeContext.transcript}`);
 contextParts.push(`Competitor follow-up question:\n${question}`);
 contextParts.push('Respond as the same judge. Clarify your scoring, highlight actionable improvements, and revise the score only if explicitly asked to do so.');
 judgeFollowupChat.push({role:'user',content:contextParts.join('\n\n')});
 const userIndex=judgeFollowupChat.length-1;
 updateJudgeFollowupStatus('Sending follow-up…');
 try{
  const model=EngineState.openaiModel||'gpt-4o';
  const maxTokens=Math.max(200,Math.min(2000,Number(EngineState.openaiMaxTokens)||600));
  const raw=await callOpenAIChat({messages:judgeFollowupChat,model,maxTokens,json:false});
  const reply=(raw||'').trim();
  if(reply){
   judgeFollowupChat.push({role:'assistant',content:reply});
   appendChat('judge',reply);
   updateJudgeFollowupStatus('Judge replied.');
  }else{
   judgeFollowupChat.splice(userIndex,1);
   updateJudgeFollowupStatus('Judge returned an empty reply.',true);
  }
 }catch(e){
  console.error('[Judge Follow-up]',e);
  judgeFollowupChat.splice(userIndex,1);
  updateJudgeFollowupStatus(`Follow-up failed: ${e?.message||'error'}`,true);
 }finally{
  judgeFollowupSending=false;
  input.disabled=false;
  input.value='';
  input.focus();
 }
}
function populate(){const sel=$('objSelect');sel.innerHTML=OBJECTION_CHOICES.map(c=>`<option>${c}</option>`).join('')}
function pool(){const f=$('objFilter').value||'all',d=$('objDiff').value||'both';return DB.filter(x=>(f==='all'||cat(x.ans)===f)&&passDiff(x.ans,d))}
function norm(v){return (v||'').toString().trim().toLowerCase()}
function newQ(){const p=pool();cur=p.length?p[Math.floor(Math.random()*(p.length))]:DB[Math.floor(Math.random()*DB.length)];$('objFact').textContent=cur.fact;$('objQ').textContent=cur.q;const r=$('objResult');r.hidden=true;r.classList.remove('ok','bad');$('objRule').textContent='';$('objWhy').textContent='';$('objRuling').textContent='';$('objSelect').selectedIndex=0}
 function updStats(c,ok){stats[c]=stats[c]||{attempts:0,correct:0};stats[c].attempts++;if(ok)stats[c].correct++;save('mtpl.objStats',stats);renderStats()}
 function renderStats(){const cats=['Hearsay','611 Control','Foundation','Opinion/Experts','Character/404','Relevance/403','Policy Exclusions'];$('objStats').textContent=cats.map(k=>{const s=stats[k]||{attempts:0,correct:0};const pct=s.attempts?Math.round(100*s.correct/s.attempts):0;return `${k.split('/')[0]} ${pct}% (${s.correct}/${s.attempts})`}).join(' \u00b7 ')}
function check(){if(!cur)return;const ok=norm($('objSelect').value)===norm(cur.ans);const r=$('objResult');r.hidden=false;r.classList.toggle('ok',ok);r.classList.toggle('bad',!ok);$('objRuling').textContent=ok?'Sustained.':'Overruled.';$('objRule').textContent=cur.rule;$('objWhy').textContent=cur.why;updStats(cat(cur.ans),ok)}
function model(){if(!cur)return;const r=$('objResult');r.hidden=false;$('objRuling').textContent='Model Answer';$('objRule').textContent=cur.rule;$('objWhy').textContent=`${cur.why} (Correct: ${cur.ans})`}
 async function gptNew(){
  if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
   alert('ChatGPT mode not enabled or API key missing.');
   return;
  }
  resetJudgeFollowup();
  const diff=$('objGPTDiff').value||'easy';
  $('objGPTChat').hidden=true;
  $('btnGPTRule').disabled=false;
  gptSendLocked=false;
  updateGPTSend();
  let userPrompt=`Generate a ${diff} difficulty objection drill.`;
  if(diff==='difficult') userPrompt+=' Use a nuanced fact pattern requiring multiple evidence rules or exceptions.';
  try{
   const messages=[
    {role:'system',content:`${STATES[CURRENT_STATE].judgePrompt} Use the ${STATES[CURRENT_STATE].name} State and Regional Tournament judges rubric. Provide a short fact pattern followed by a single question and answer transcript. Use only these objection names: ${OBJECTION_CHOICES.join(', ')}. Ensure there is exactly one correct objection grounded in the transcript and rules of evidence. Return only JSON with fields fact,q,ans,rule,why.`},
    {role:'user',content:`${userPrompt} Include the brief transcript and follow the rubric precisely.`}
   ];
   const model=EngineState.openaiModel||'gpt-4o';
   const tokenParam=chatTokenParam(model,250);
   const resp=await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${EngineState.openaiKey}`},
    body:JSON.stringify({model,messages,response_format:{type:'json_object'},...tokenParam})
   });
   const data=await resp.json();
   const raw=data?.choices?.[0]?.message?.content||'';
   const obj=extractFirstJson(raw);
   if(obj&&obj.fact&&obj.q&&obj.ans){
    cur=obj;
    $('objFact').textContent=obj.fact;
    $('objQ').textContent=obj.q;
    const r=$('objResult');r.hidden=true;r.classList.remove('ok','bad');
    $('objRule').textContent='';$('objWhy').textContent='';$('objRuling').textContent='';
    const ans=OBJECTION_CHOICES.find(c=>norm(c)===norm(obj.ans));
    cur.ans=ans||obj.ans;
    $('objSelect').selectedIndex=0;
   } else {
    alert('Bad response from ChatGPT.');
   }
  }catch(e){
   console.error('[GPT Prompt]',e);
   alert('ChatGPT error');
  }
 }
 async function gptArgue(){
  if(!cur){alert('Get a prompt first.');return;}
  if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
   alert('ChatGPT mode not enabled or API key missing.');
   return;
  }
 const role = $('objGPTRole').value || 'chatgpt';

 // Stronger system guardrails: NO NEW FACTS, NO HYPOTHETICALS
 const systemMsg = {
  role: 'system',
  content:
`${STATES[CURRENT_STATE].judgePrompt}
You are acting as opposing counsel in a mock trial objection argument.
Constraints (must follow):
- Do NOT invent or add any facts, events, injuries, statements, or timelines beyond the SCENARIO block.
- Do NOT use hypotheticals or "for example" stories.
- Never issue a ruling or act like the judge. Do NOT say phrases such as "sustained," "overruled," or "move on." Your role is only to argue against the user's objection as opposing counsel.
- If the question lacks foundation or requires inference beyond the SCENARIO, object on that basis (e.g., Rule 602 speculation, Rule 611, etc.) WITHOUT adding facts.
- Avoid Rule 602 objections unless the lack of personal knowledge is unmistakable; prefer other rules or no objection when foundation appears sufficient.
- Keep responses concise, transcript-style (1–3 sentences), grounded ONLY in the SCENARIO facts and the rules of evidence.`
 };

 let userMsg;
 if (role === 'chatgpt') {
  // Opposing counsel states an objection ONLY from the given scenario
  userMsg = {
    role: 'user',
    content:
 `SCENARIO (verbatim)
Fact: ${cur.fact}
Question: ${cur.q}

Task for Opposing Counsel:
- State the single best objection drawn ONLY from the SCENARIO and Arizona HS Mock Trial Rules (cite rule number, e.g., 602, 611(c), 801/802).
- Do NOT make up what happened next. Do NOT add facts or examples. No hypotheticals.
- Use Rule 602 only when lack of personal knowledge is obvious; avoid defaulting to 602 for close calls.
- Keep it to 1–3 sentences max.
- End with: "Counsel, your response?"`
  };
 } else {
  // User will object; opposing counsel should only prompt, still bound by SCENARIO
  userMsg = {
    role: 'user',
    content:
 `SCENARIO (verbatim)
Fact: ${cur.fact}
Question: ${cur.q}

Task:
- Briefly set the scene (1 sentence max) WITHOUT adding any facts.
- Ask me to state my objection based ONLY on the SCENARIO.
- After I object, respond ONLY as opposing counsel, still WITHOUT adding facts. Keep each turn 1–3 sentences.`
  };
 }
 gptChat=[systemMsg,userMsg];
  const out=$('objGPTChat');
  out.hidden=false;
  out.innerHTML='';
  $('objGPTControls').hidden=false;
  $('btnGPTRule').hidden=false;
  $('btnGPTRule').disabled=false;
  $('objGPTInput').value='';
  gptSendLocked=false;
  updateGPTSend();
   try{
    const model=EngineState.openaiModel||'gpt-4o';
    const tokenParam=chatTokenParam(model,150);
    const resp=await fetch('https://api.openai.com/v1/chat/completions',{
     method:'POST',
     headers:{'Content-Type':'application/json','Authorization':`Bearer ${EngineState.openaiKey}`},
     body:JSON.stringify({model,messages:gptChat,temperature:0.7,...tokenParam})
    });
   const data=await resp.json();
   const text=data?.choices?.[0]?.message?.content?.trim()||'';
   gptChat.push({role:'assistant',content:text});
   appendChat('chatgpt',text);
  }catch(e){
   console.error('[GPT Argue]',e);
   const raw = e?.raw ? (typeof e.raw === 'string' ? e.raw.slice(0,200) : JSON.stringify(e.raw).slice(0,200)) : '';
   appendChat('chatgpt', `ChatGPT error: ${e?.message || 'error'}${raw ? ` | ${raw}` : ''}`);
  }
  }
  async function gptSend(){
   if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){alert('ChatGPT mode not enabled or API key missing.');return;}
   const inp=$('objGPTInput');const txt=inp.value.trim();if(!txt)return;inp.value='';
   updateGPTSend();
  gptChat.push({role:'user',content:txt});
  appendChat('user',txt);
  try{
   const model=EngineState.openaiModel||'gpt-4o';
   const tokenParam=chatTokenParam(model,150);
   const resp=await fetch('https://api.openai.com/v1/chat/completions',{
     method:'POST',
     headers:{'Content-Type':'application/json','Authorization':`Bearer ${EngineState.openaiKey}`},
     body:JSON.stringify({model,messages:gptChat,temperature:0.7,...tokenParam})
    });
   const data=await resp.json();
   const reply=data?.choices?.[0]?.message?.content?.trim()||'';
   gptChat.push({role:'assistant',content:reply});
   appendChat('chatgpt',reply);
  }catch(e){
   console.error('[GPT Send]',e);
   const raw = e?.raw ? (typeof e.raw === 'string' ? e.raw.slice(0,200) : JSON.stringify(e.raw).slice(0,200)) : '';
   appendChat('chatgpt', `ChatGPT error: ${e?.message || 'error'}${raw ? ` | ${raw}` : ''}`);
  }
  }
function gptRecord(){
  if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){alert('ChatGPT mode not enabled or API key missing.');return;}
  $('objGPTInput').value='';
  updateGPTSend();
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  // Prefer OpenAI transcription when an API key is available
  if(EngineState.openaiKey && navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
   const getMicStream = async () => {
     try {
       return await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:true,echoCancellation:true}});
     } catch (_) {
       return navigator.mediaDevices.getUserMedia({audio:true});
     }
   };
   getMicStream().then(stream=>{
     gptRecStream=stream;
     try{
       const types=['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/ogg;codecs=opus','audio/mpeg'];
       const mime=types.find(t=>MediaRecorder.isTypeSupported(t))||'';
       const rec=new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
       gptRecog=rec;const chunks=[];
       rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data)};
       rec.onstop=async()=>{
         $('btnGPTRecord').disabled=false;
         $('btnGPTStopRecord').disabled=true;
         gptRecog=null; if(gptRecStream){gptRecStream.getTracks().forEach(t=>t.stop());gptRecStream=null;}
         const type=rec.mimeType||mime||'audio/webm';
         const blob=new Blob(chunks,{type});
         try{
           const wav=await blobToWav(blob);
           const text=await transcribeFile(wav,'audio.wav');
           if(text){$('objGPTInput').value=text;}
         }catch(err){alert('Transcription error: '+err.message);}
         updateGPTSend();
       };
       rec.start();
       $('btnGPTRecord').disabled=true;
       $('btnGPTStopRecord').disabled=false;
     }catch(e){
       alert('MediaRecorder not supported: '+e.message);
       gptRecStream.getTracks().forEach(t=>t.stop());
       gptRecStream=null;
     }
   }).catch(err=>alert('Mic error: '+err.message));
  } else if(SR){
   // Fallback to browser speech recognition when no API key is available
   gptRecog=new SR();
   let txt='';
   gptRecog.lang='en-US';
   gptRecog.continuous=true;
   gptRecog.interimResults=false;
   gptRecog.onresult=ev=>{
     for(let i=ev.resultIndex;i<ev.results.length;i++){
       const res=ev.results[i];
       if(res.isFinal){ txt+=res[0].transcript+' '; }
     }
   };
   gptRecog.onend=()=>{
     $('btnGPTRecord').disabled=false;
     $('btnGPTStopRecord').disabled=true;
     const t=txt.trim();
     gptRecog=null;
     if(t){ $('objGPTInput').value=t; }
     updateGPTSend();
   };
   gptRecog.onerror=e=>{
     alert('Speech recognition: '+e.error);
     $('btnGPTRecord').disabled=false;
     $('btnGPTStopRecord').disabled=true;
     gptRecog=null;
   };
   $('btnGPTRecord').disabled=true;
   $('btnGPTStopRecord').disabled=false;
   gptRecog.start();
  } else {
   alert('Speech recognition not supported in this browser.');
  }
}
function gptStopRecord(){
  if(gptRecog){
   $('btnGPTStopRecord').disabled=true;
   try{gptRecog.stop();}catch(e){}
  }
}
  async function gptRule(){
    if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
      alert('ChatGPT mode not enabled or API key missing.');
      return;
    }

    // Require at least one user argument beyond the initial scenario
    const userMsgs = gptChat.filter(m => m.role === 'user');
    if(userMsgs.length <= 1){
      alert('Provide your argument before requesting a ruling.');
      return;
    }

    resetJudgeFollowup();

    // Tag the whole conversation for CONTEXT (judge can read it, but must not score it)
    const fullTagged = gptChat.map(m => {
      // User = you; Assistant = opposing counsel; anything else = system
      const tag = (m.role === 'user') ? '[USER]' : (m.role === 'assistant' ? '[OC]' : '[SYS]');
      return `${tag}: ${m.content}`;
    }).join('\n');

    // Build a USER-ONLY block that the judge must score
    const userOnly = gptChat
      .filter(m => m.role === 'user')
      .slice(1)
      .map(m => `[USER]: ${m.content}`)
      .join('\n');

    // Include the original scenario verbatim so the judge has the same context
    const scenarioHeader =
`SCENARIO (verbatim)
Fact: ${cur.fact}
Question: ${cur.q}
Candidate Objection (from prompt): ${cur.ans} (Rule ${cur.rule})`;

    // Compose the transcript with explicit instructions:
    // - CONTEXT is visible but not to be scored
    // - EVALUATE block is the ONLY material to score
    const transcript =
`${scenarioHeader}

CONTEXT (read for background; DO NOT SCORE any of this):
${fullTagged}

EVALUATE (score ONLY the [USER] lines below using the rubric):
${userOnly}

Scoring rule:
- Apply the rubric strictly to the EVALUATE block ([USER] lines).
- Ignore any facts or arguments that appear only in CONTEXT.
- Do NOT infer or credit facts not in the SCENARIO.`;

    // Keep your existing rubric/template & parser/output
    const prompt = ChatGPTScoring.buildScoringPrompt(transcript, true, ChatGPTScoring.ARGUMENT_RUBRIC);

    let parsed=null;
    try{
      const model = EngineState.openaiModel || 'gpt-4o';
      const tokenParam = chatTokenParam(model,400);
      const resp = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${EngineState.openaiKey}`},
        body: JSON.stringify({
          model,
          messages:[{role:'user', content: prompt}],
          temperature: 0.7,
          ...tokenParam
        })
      });
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content?.trim() || '';

      try{
        parsed = ChatGPTScoring.parseScoreResponse(text); // unchanged parser
        appendJudgeDecision(parsed);                            // unchanged UI
      }catch{
        // If the model didn't use the expected format, show raw text so you see what happened
        appendChat('judge', text);
      }

      const summaryText = buildJudgeSummaryText(parsed);
      prepareJudgeFollowup(summaryText, transcript, text);

      gptSendLocked = true;
      updateGPTSend();
      $('btnGPTRule').disabled = true;

    }catch(e){
      console.error('[GPT Rule]', e);
      const raw = e?.raw ? (typeof e.raw === 'string' ? e.raw.slice(0,200) : JSON.stringify(e.raw).slice(0,200)) : '';
      appendChat('chatgpt', `ChatGPT error: ${e?.message || 'error'}${raw ? ` | ${raw}` : ''}`);
      resetJudgeFollowup();
    }
  }
function wire(){
  populate();
  $('btnNewObj').addEventListener('click',newQ);
  $('btnCheckObj').addEventListener('click',check);
  $('objFilter').addEventListener('change',newQ);
  $('objDiff').addEventListener('change',newQ);
  $('btnResetStats').addEventListener('click',()=>{
    stats={};
    save('mtpl.objStats',stats);
    renderStats();
    alert('Mastery stats cleared.');
  });
  $('btnGPTNew').addEventListener('click',gptNew);
  $('btnGPTArgue').addEventListener('click',gptArgue);
  $('btnGPTSend').addEventListener('click',gptSend);
  $('btnGPTRecord').addEventListener('click',gptRecord);
  $('btnGPTStopRecord').addEventListener('click',gptStopRecord);
  $('btnGPTRule').addEventListener('click',gptRule);
  $('objGPTInput').addEventListener('input',updateGPTSend);
  $('btnObjChangeEngine').addEventListener('click',openVideoGate);
  attachFollowupSender('objJudgeFollowup',sendJudgeFollowup);
  resetJudgeFollowup();
  updateGPTSend();
  newQ();
  renderStats();
}
 return{wire}
})();

  /* Video Coach (ChatGPT integration) */
const VideoCoach=(function(){
  let stream=null,rec=null,chunks=[],timer=null,sec=0,recog=null,
      lastVideoBlob=null,lastVideoDuration=0,lastVideoUrl='',currentFacingMode='user',
      writeChat=[],writeContext=null,writeFollowupCount=0,writeFollowupSending=false,
      videoJudgeContext=null,videoFollowupChat=[],videoFollowupSending=false;

  const EXEMPLARS={
    opening:{title:"Opening Exemplar",text:`Mr. Majeur and members of the jury, they set him up. The police let him down. Despite what Mr. Majeur just told you, this is not a case about a man with connections. This is a case about two people who staged a crime, and the police department that failed to do its job. Good evening, members of the jury. My name is Kapir Majeur, and I am proud to represent Hollis Trimble. Hollis is a lifelong hero. He did not shoot Lupe Cappos, and he walked into this courtroom today presumed innocent. Despite his constitutional right not to, he'll take the stand, look you in the eyes, and explain. This was a setup. Here's what you'll learn in trial. The supposed victim, Lupe Cappos, is no victim at all. Four days before his shooting, he met with a childhood friend in the dark corner of a dimly lit restaurant, where they planned to frame my client. You'll learn the supposed victim was a journalist seeking fame. And his friend? A felon with a vendetta against my client. They believed successfully framing Hollis Trimble was their ticket to fame and revenge. Cappos agreed that in exchange for $25,000, he would lure Mr. Trimble to his house, allow his felon friend to shoot at him, but claim to police that Mr. Trimble was the shooter. They execute this plan. Police arrest Mr. Trimble. But here's the worst part, members of the jury. Shortly after the arrest, the police receive an audio recording of this plan, and evidence of a $25,000 transfer. But they've already got their head. So they label the audio recording a fake. They don't investigate this plan meeting. They don't investigate the source of the $25,000. And they don't investigate whether the shooting was a set-up. And that's why we're here. Because they set him up. The police let him down. When the state of Arizona charged Mr. Trimble, it took on the burden to prove beyond a reasonable doubt that Mr. Trimble attempted to kill Jose Cappos with a premeditated attempt. That means the state must also prove beyond a reasonable doubt that Mr. Trimble was not set up. The state will fail to meet this burden because of three things. The meeting, the money, and the mistakes. So let's take those one at a time. First, the meeting. An eyewitness named T.J. Hakiko will confirm that four days before the shooting, he witnessed the meeting where the supposed victim and his fellow friend planned the setup. This eyewitness heard Lupe Cappos agree to take a bullet in exchange for $25,000. Which brings me to our second evidence, the money. The supposed victim's bank records will show that one day after the shooting, he received that exact same amount of money, $25,000. And finally, third, the mistakes. A Phoenix police detective was presented with an audio recording of this money and evidence of a $25,000 wire transfer. But she made absolutely no effort to investigate these events. Because she didn't. We didn't. The proof will show that the name of the company who delivered this $25,000 wire transfer is shockingly similar to that of the fellow friend. And the recording, dismissed as fake by the police, is in fact authentic according to an expert in AI-generated auditing. All of this is why, at the end of trial, my co-counsel, Mr. Kenneth Hoyt, will ask you to find Mr. Trimble not guilty. Because when you look at the meeting, the money, and the mistakes, it becomes clear. Stay charged with the wrong man. Because they set him up. The police let him down. Thank you.`,guide:`1. Theme & Story \u2013 Begin with a central theme and a brief, illustrative story.\n2. Position \u2013 Clearly state which side you represent.\n3. Burden of Proof \u2013 Explain the applicable standard and who carries it.\n4. Witnesses & Evidence \u2013 Preview the key witnesses and evidence.\n5. Desired Verdict \u2013 Conclude by emphasizing the verdict you are seeking.`},
    closing:{title:"Closing Exemplar",text:`Why? Why did the supposed victim lie about knowing Phenomel? Why did the supposed victim say that he couldn't remember the meeting that happened four days before the shooting in Durant, Russia? Why did the supposed victim receive the exact amount of money that was in an audio recording in which he accepted the money to be shot? But most importantly, members of the jury, why didn't the police investigate any of this? It's because they set him up with the police and let him down.
Now the state cannot simply tell you that my client is guilty. They had to prove it beyond a reasonable doubt that this was not a set-up. Members of the jury, that is the highest burden in our criminal justice system. It requires proof to a moral suit. It means if you believe that there is even a possibility that this could have been a set-up, you must return a verdict of not guilty. Now the state has failed to meet this high burden, and to remember that, you only need to think about three things. The meeting, the money, and the mistakes.
Let's start with the meeting. The one that occurred in the corner of a dimly lit restaurant where people go where they don't want to be heard. The one where a Lupe Campos in Fenno Valley made a plan to set my client up. Where a Lupe Campos agreed to receive $25,000 in exchange for luring the defendant to his home and then being shot, taking a bullet from Fenno Valley.
That brings me to the second reason, which is the money itself. $25,000 one day after the shooting occurred. From Huckleberry Finn, LLC. Is Huckleberry Finn connected to Fenno Valley? Better yet, has the state proven that it is not? The answer is no, but let's assume for a second that the state is right. Let's assume that's Jory and Kika made all of this up. The $25,000, mere coincidence. How is it possible that the recording to Jory and Kika claims they have has the exact amount of money that was deposited in the Lupe Campos' account? Members of the jury, they're asking you to believe that this is pure coincidence. That is simply unbelievable.
Which brings me to the third reason, the mistakes of the Phoenix PD. Detective Abdullahi told you that the state investigated this case for a whole seven hours before they arrested my client. They received evidence that exonerated him, proved that they had the wrong person. They not only ignored the evidence, they threw it under the rug. They hid it. They declared that the audio recording was fake. After one listen, they didn't investigate the meeting between Finn O'Malley and Lupe Campos. They didn't investigate the $25,000 from Huckleberry Finn, LLC. If you believe that there's even a possibility that the detective did not perform a thorough enough investigation, you must find my client. Not yet. They tried to convince you that Mr. Trimble is a man with a lot of connections. The connection they're trying to hide from you today is the one between those two men sitting right there. The connection between Lupe Campos and Finn O'Malley. The meeting that Lupe Campos said, oh, I can't remember, and then Finn O'Malley follows up by saying, no, no, that meeting did occur. The one where Tahari Akinka tried to say, I have an audio recording here, you should listen to it. And the detective listened to it once, threw it to the side with no testing, or even impounding it, and said, I'm not considering this evidence. For most of the jury, that is not how justice works. That's not how our system was built. You have to find the defendant not guilty. Because they set him up, and the police did nothing but let him down.`,guide:`A good closing follows this structure:\n1. Introduction \u2013 Start with a story or hook that ties the theme to the case.\n2. Burden \u2013 State the burden of proof.\n3. Roadmap \u2013 Tell the fact-finder what evidence they must focus on that proves your case.\n4. Witnesses \u2013 Explain what each witness showed and connect it to the evidence and theme.\n5. Rebuttal \u2013 Respond to opposing counsel\u2019s main points.\n6. Verdict Request \u2013 Ask the jury or judge to rule in your favor.`},
    direct:{title:"Direct Exemplar",text:`Chapters with open questions: Background, Event, Aftermath.
      Background: Please introduce yourself. What do you do? How are you connected to June 12th?
      Event: What did you observe as you approached the intersection? What, if anything, did you notice about the blue sedan?
      Exhibit foundation: Do you recognize Exhibit 7? How do you recognize it? Is it a fair and accurate depiction?
      Move to admit Exhibit 7. Follow-up listening: What happened next?`},
    cross:{title:"Cross Exemplar",text:`Short leading questions, one fact per question:
      You were 200 feet away when you first saw the car, correct? Your view was partially blocked by a truck, right?
      In your statement on page 3, line 12, you wrote \u201cI couldn\u2019t see the lane dividers,\u201d correct?
      The intersection had no streetlights in that direction, yes?
      You can\u2019t say the car was speeding with certainty, correct?`}
  };

  const PATS={
    opening:{must:["theme","the evidence will show","you will hear","you will hear from","you will see","roadmap","first","second","burden","preponderance","ask you to return a verdict","verdict"],nice:["negligence","duty","breach","causation","damages","timeline","exhibit","witness","theory","story"]},
    closing:{must:["burden","roadmap","witness","they said","ask you","verdict"],nice:["theme","apply the law","element","preponderance","more likely than not","refute","opposing","jury instruction","standard of proof"]},
    direct:{must:["please introduce yourself","what did you","how do you recognize","fair and accurate","move to admit","what happened next"],nice:["open-ended","exhibit","foundation","background","event","aftermath","follow-up","authenticate","identify","admit into evidence"]},
    cross:{must:["correct?","right?","yes or no","you wrote","on page","line","you can\u2019t say","isn\u2019t it true"],nice:["leading","impeach","admission","one fact per question","control","statement","affidavit","deposition"]}
  };

  function clean(s){return (s||'').toLowerCase().replace(/[^a-z0-9\s']/g,' ').replace(/\s+/g,' ').trim()}
  function tokens(s){return clean(s).split(/\s+/).filter(Boolean)}
  function uniq(a){return Array.from(new Set(a))}
  function ngrams(arr,n){const out=[];for(let i=0;i<=arr.length-n;i++) out.push(arr.slice(i,i+n).join(' '));return out}
  function cosineCount(a,b){const m=new Map();a.forEach(t=>m.set(t,(m.get(t)||0)+1));const n=new Map();b.forEach(t=>n.set(t,(n.get(t)||0)+1));let dot=0,na=0,nb=0;m.forEach((v,k)=>{na+=v*v;if(n.has(k)) dot+=v*n.get(k)});n.forEach(v=>nb+=v*v);return (na&&nb)? dot/(Math.sqrt(na)*Math.sqrt(nb)) : 0;}
  const SIGNPOSTS_OPEN=/\b(first|second|third|to begin|the evidence will show|you will hear|you will see|our roadmap)\b/i;

  function compareToExemplar(type, transcript){
    const ex=EXEMPLARS[type]?.text||'';
    const tTokens=tokens(transcript), eTokens=tokens(ex);
    const tBigrams=ngrams(tTokens,2), eBigrams=ngrams(eTokens,2);
    const lexCos=cosineCount(tTokens,eTokens);
    const biCos=cosineCount(tBigrams,eBigrams);
    const libs=PATS[type]||{must:[],nice:[]};
    const lower=transcript.toLowerCase();
    const mustHits=libs.must.filter(k=>lower.includes(k)).length;
    const niceHits=libs.nice.filter(k=>lower.includes(k)).length;
    const mustScore=libs.must.length? mustHits/libs.must.length : 0;
    const niceScore=libs.nice.length? Math.min(1, niceHits/(libs.nice.length*0.7)) : 0;
    let struct=0;
    if(type==='opening'){
      struct+=/\b(theme|theory|story)\b/i.test(transcript)?0.2:0;
      struct+=/\bask (you|the jury)|we ask you\b|verdict\b/i.test(transcript)?0.2:0;
      struct+=/\bburden|preponderance\b/i.test(transcript)?0.2:0;
      struct+=/\byou will hear from\b/i.test(transcript)?0.2:0;
      struct+=SIGNPOSTS_OPEN.test(transcript)?0.2:0;
    }
    else if(type==='closing'){
      const intro=/\b(theme|story)\b/i.test(transcript);
      const burden=/\b(burden|preponderance|more likely than not)\b/i.test(transcript);
      const roadmap=/\b(roadmap|first|second|third|element)\b/i.test(transcript);
      const witnesses=/\b(witness(es)?|testif(?:y|ied)|evidence)\b/i.test(transcript);
      const rebut=/\b(refut|they said|they claim|opposing counsel)\b/i.test(transcript);
      const ask=/\b(ask (you|the jury)|return a verdict|rule in (your|our) favor)\b/i.test(transcript);
      [intro,burden,roadmap,witnesses,rebut,ask].forEach(h=>{if(h) struct+=1/6;});
    }
    else if(type==='direct'){struct+=/\bplease introduce yourself|state your name\b/i.test(transcript)?0.3:0; struct+=/\brecognize|fair and accurate|move to admit\b/i.test(transcript)?0.4:0; struct+=/\bwhat happened next\b/i.test(transcript)?0.3:0;}
    else if(type==='cross'){struct+=/\b(correct\?|right\?|yes or no|isn't it true)\b/i.test(transcript)?0.5:0; struct+=/\b(page|line|statement|affidavit|deposition)\b/i.test(transcript)?0.3:0; struct+=/\bone fact per\b/i.test(transcript)?0.2:0;}
    const blend=(0.35*lexCos+0.25*biCos+0.25*mustScore+0.10*niceScore+0.05*struct);
    return {lexCos:+lexCos.toFixed(3),biCos:+biCos.toFixed(3),mustHits,niceHits,mustTotal:libs.must.length,niceTotal:libs.nice.length,struct:+struct.toFixed(3),score:+blend.toFixed(3)};
  }

  const RUBRICS={
    opening:{name:'Opening',cats:[
      {key:'content',n:'Theory & Record Integration',w:0.36},
      {key:'organization',n:'Roadmap & Signposting',w:0.26},
      {key:'persuasion',n:'Theme & Momentum',w:0.22},
      {key:'delivery',n:'Delivery & Presence',w:0.16}
    ]},
    closing:{name:'Closing',cats:[
      {key:'content',n:'Law & Element Analysis',w:0.30},
      {key:'organization',n:'Structure & Story Arc',w:0.18},
      {key:'refutation',n:'Refutation & Case Defense',w:0.24},
      {key:'persuasion',n:'Ask & Impact',w:0.14},
      {key:'delivery',n:'Delivery & Command',w:0.14}
    ]},
    direct:{name:'Direct',cats:[
      {key:'content',n:'Chapters & Theory Advancement',w:0.26},
      {key:'openq',n:'Question Craft & Tone',w:0.22},
      {key:'foundation',n:'Foundations & Exhibits',w:0.20},
      {key:'listening',n:'Witness Listening & Follow-ups',w:0.22},
      {key:'delivery',n:'Witness Connection & Delivery',w:0.10}
    ]},
    cross:{name:'Cross',cats:[
      {key:'content',n:'Chapter Targets & Theory Impact',w:0.24},
      {key:'leading',n:'Leading Control & Tempo',w:0.26},
      {key:'impeach',n:'Impeachments & Admissions',w:0.26},
      {key:'brevity',n:'Precision & Efficiency',w:0.14},
      {key:'delivery',n:'Delivery & Presence',w:0.10}
    ]}
  };

  const VIDEO_CATEGORY_FOCUS={
    opening:{
      content:'Prove the theory with cited facts and burdens so the judge knows exactly what you will deliver.',
      organization:'Lay out a crisp roadmap with strong signposts and transitions from promise to promise.',
      persuasion:'Build narrative momentum with theme callbacks and purposeful word choice that never over-argues.',
      delivery:'Stand grounded, gesture with intent, and keep vocal control aligned with the transcript’s pace.'
    },
    closing:{
      content:'March element-by-element through the law, citing the record for every conclusion you ask the judge to adopt.',
      organization:'Sequence the chapters so the story escalates naturally toward the close while echoing the theme.',
      refutation:'Directly answer the opponent’s strongest arguments with receipts from the transcript or exhibits.',
      persuasion:'Make the ask inevitable by tying impact, burden, and relief into a unified finish.',
      delivery:'Project confident command—eye contact, pacing, and tone that show you own the room.'
    },
    direct:{
      content:'Map the theory chapter-by-chapter so every fact advances a clear purpose for the witness.',
      openq:'Keep questions open, short, and responsive—penalize leading or double-barreled phrases.',
      foundation:'Lay solid exhibit and expertise foundations before introducing the proof you need.',
      listening:'Drill follow-ups that rescue drift, clarify confusions, and highlight the answer the judge should hear.',
      delivery:'Encourage an invitational tone, steady posture, and connection that spotlights the witness.'
    },
    cross:{
      content:'Aim each chapter at a theory-critical concession so the scorecard moves in your favor.',
      leading:'Maintain relentless leading control and tempo that keeps the witness to “yes” or “no.”',
      impeach:'Capitalize on prior statements or exhibits to cement admissions and punish contradictions.',
      brevity:'Stay surgical—short, precise questions with no filler or stacking.',
      delivery:'Show poised aggression: courtroom professionalism with clear voice, posture, and eye contact.'
    }
  };

  function baseMetrics(text){
    const words=(text||'').trim().split(/\s+/).filter(Boolean);
    const wordCount=words.length;
    const wpm=sec>0?Math.round(wordCount/(sec/60)):(wordCount?150:0);
    const fillers=(text.match(/\b(um+|uh+|like|you know|er|ah)\b/gi)||[]).length;
    const signposts=(text.match(/\b(first|second|third|to begin|next|finally|in conclusion|therefore|because|the evidence (will|does) show)\b/gi)||[]).length;
    const vocab=uniq(words.map(w=>w.toLowerCase().replace(/[^a-z']/g,'')).filter(Boolean));
    const vocabRich=clamp(Math.log2(vocab.length+1)/7*10,1,10);
    return {wordCount,wpm,fillers,signposts,vocabRich};
  }

  function isEffectivelyEmpty(text){
    if(!text) return true;
    const stripped=text
      .replace(/\[(?:inaudible|noise|music|silence|applause)[^\]]*\]/gi,'')
      .replace(/[0-9]/g,'')
      .replace(/[\s.,!?;:"'`~^@#$%&*()_+\[\]{}<>\\\/|\-\u2013\u2014]/g,'')
      .trim();
    return stripped.length===0;
  }
  function effectiveWordCount(text){
    if(!text) return 0;
    const cleaned = text
      .replace(/\[(?:inaudible|noise|music|silence|applause)[^\]]*\]/gi,' ')
      .toLowerCase()
      .replace(/[^a-z?\s]/g,' ');
    const fillers=new Set(['um','uh','er','ah','like','you','know','so']);
    return cleaned.split(/\s+/).filter(Boolean).filter(w=>!fillers.has(w)).length;
  }

  function getQuestionLines(transcript){
    const lines=(transcript||'').split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let qLines=lines.filter(l=>/^\s*(Q[:;]|Question[:;])\s*/i.test(l))
                    .map(l=>l.replace(/^\s*(Q[:;]|Question[:;])\s*/i,''));
    if(qLines.length===0){ qLines=(transcript||'').match(/[^?]*\?/g)||[]; qLines=qLines.map(s=>s.trim()); }
    return qLines;
  }

  function formatTranscriptQA(transcript){
    const lines=(transcript||'').split(/\n+/).map(l=>l.trim()).filter(Boolean);
    let out=[], expectQ=true;
    for(const line of lines){
      if(/^\s*Q[:;\-]?/i.test(line)){ out.push('Q: '+line.replace(/^\s*Q[:;\-]?\s*/i,'')); expectQ=false; }
      else if(/^\s*A[:;\-]?/i.test(line)){ out.push('A: '+line.replace(/^\s*A[:;\-]?\s*/i,'')); expectQ=true; }
      else {
        out.push((expectQ?'Q: ':'A: ')+line);
        expectQ=!expectQ;
      }
    }
    return out.join('\n');
  }

  function formatTranscripts(pairs){
    const combinedLines=[], questionLines=[], answerLines=[];
    pairs.forEach((pair, idx)=>{
      const [question, answer] = pair;
      const num = idx+1;
      combinedLines.push(`Q${num}: ${question}`);
      combinedLines.push(`A${num}: ${answer}`);
      questionLines.push(`Question ${num}: ${question}`);
      answerLines.push(`Answer ${num}: ${answer}`);
    });
    return {
      combined: combinedLines.join('\n'),
      questions: questionLines.join('\n'),
      answers: answerLines.join('\n')
    };
  }
  function isOpenQuestion(q){return /^\s*(what|why|how|describe|explain|tell(\s+us)?|walk\s+us\s+through|please\s+introduce|state\s+your\s+name|who|where|when)\b/i.test(q);}
  function isLeadingQuestion(q){return /\b(correct\?|right\?|yes\s+or\s+no\b|isn'?t\s+(it|that)\s+true|wouldn'?t\s+you\s+agree|you\s+(agree|admit)|is\s+it\s+true\s+that)\b/i.test(q);}
  function isCompoundQuestion(q){return /\?[^?]+\?/.test(q) || /\b(and|or)\b[^?]*\?/i.test(q);}
  function hasFoundationCue(q){return /\b(recognize|identify|authenticate|fair\s+and\s+accurate|move\s+to\s+admit|admit\s+(it|this)|publish|marked\s+as\s+exhibit|exhibit\s+\d+)\b/i.test(q);}
  function hasImpeachAnchor(q){return /\b(page|line|statement|prior\s+statement|affidavit|deposition|in\s+your\s+statement|exhibit(\s+\d+)?)\b/i.test(q);}
  function bandScore(val,lo,hi){ if(!isFinite(val)||val<=0) return 3; if(val>=lo&&val<=hi) return 9; const span=Math.max(1,hi-lo); if(val>=lo-0.5*span&&val<=hi+0.5*span) return 7; if(val>=lo-1.0*span&&val<=hi+1.0*span) return 6; return 4; }
  function questionMetrics(text, secs){
    const qLines=getQuestionLines(text); const qCount=qLines.length;
    const minutes=secs>0?(secs/60):Math.max(1,(text.split(/\s+/).filter(Boolean).length)/140);
    const qPerMin=qCount/minutes;
    const tokCounts=qLines.map(q=>(q.match(/\S+/g)||[]).length);
    const avgTokens=tokCounts.length?(tokCounts.reduce((a,b)=>a+b,0)/tokCounts.length):0;
    let open=0,lead=0,compound=0,found=0,impeach=0,follow=0;
    qLines.forEach(q=>{ if(isOpenQuestion(q))open++; if(isLeadingQuestion(q))lead++; if(isCompoundQuestion(q))compound++; if(hasFoundationCue(q))found++; if(hasImpeachAnchor(q))impeach++; if(/\b(what\s+happened\s+next|then\s+what|after\s+that|and\s+what\s+did\s+you\s+do)\b/i.test(q))follow++; });
    const openRatio=qCount?open/qCount:0, leadRatio=qCount?lead/qCount:0, compoundRate=qCount?compound/qCount:0;
    return {qLines,qCount,qPerMin,avgTokens,openCount:open,leadCount:lead,compoundCount:compound,foundationCount:found,impeachCount:impeach,followupCount:follow,openRatio,leadRatio,compoundRate};
  }

  function score(type,text){
    const bm=baseMetrics(text);
    const cmp=compareToExemplar(type,text);
    const qM=questionMetrics(text,sec);

    const effWords=effectiveWordCount(text);
    const noSpeech = isEffectivelyEmpty(text) || effWords < 5;
    const isVeryShort = effWords < 10 && qM.qCount < 2;
    if(noSpeech){
      const conf=RUBRICS[type]; const pack={};
      conf.cats.forEach(c=>{ pack[c.key]=0; });
      return {buildScores(){return {cats:pack,total:0,metrics:bm,compare:{lexCos:0,biCos:0,mustHits:0,niceHits:0,mustTotal:0,niceTotal:0,struct:0,score:0},qm:qM,effWords}}};
    }

    const isOpen=type==='opening', isClose=type==='closing', isDir=type==='direct', isCross=type==='cross';

    let delivery=6;
    if(bm.wpm>=125&&bm.wpm<=165) delivery=9; else if(bm.wpm>=110&&bm.wpm<=180) delivery=7;
    delivery-=Math.min(3,Math.floor(bm.fillers/3)); if(bm.wordCount===0) delivery=1; delivery=clamp(delivery,1,10);

    let organization=clamp(4+Math.min(5,Math.floor(bm.signposts/2))+(cmp.struct>=0.4?1:0),1,10);

    let contentCore=clamp(3+Math.round(5*cmp.score)+Math.round(bm.vocabRich/4),1,10);
    let persuasion=clamp(3+Math.round(4*cmp.lexCos)+(/[!.]/.test(text)?2:0)+Math.round(bm.vocabRich/5),1,10);
    let refutation=0, openq=0, foundation=0, listening=0, leading=0, impeach=0, brevity=0;

    if(isOpen){
      const lower=text.toLowerCase();
      const hasTheme=/\b(theme|theory|story)\b/i.test(text);
      const hasEWS=/\bthe evidence will show\b/i.test(lower);
      const hasHearSee=/\byou will (hear|see)\b/i.test(lower);
      const hasRoadmap=/\b(first|second|third|to begin|our roadmap)\b/i.test(lower);
      const asksVerdict=/\b(ask you to return a verdict|we (ask|will ask) you.*verdict)\b/i.test(lower);
      const mentionsBurden=/\b(preponderance|burden|more likely than not)\b/i.test(lower);
      const mentionsElements=/\b(duty|breach|causation|damages)\b/i.test(lower);

      const ms=PATS.opening.must.length?PATS.opening.must.filter(k=>lower.includes(k)).length/PATS.opening.must.length:0;
      const ns=PATS.opening.nice.length?Math.min(1,PATS.opening.nice.filter(k=>lower.includes(k)).length/(PATS.opening.nice.length*0.7)):0;

      organization=Math.max(organization,clamp(5+(hasRoadmap?2:0)+(hasTheme?1:0)+(hasEWS?1:0)+(hasHearSee?1:0)+(asksVerdict?1:0),1,10));
      contentCore=clamp(Math.round(10*(0.45*ms+0.20*ns+0.25*cmp.biCos+0.10*cmp.lexCos))+(mentionsElements?1:0)+(mentionsBurden?1:0),1,10);
      persuasion=clamp(3+Math.round(3*cmp.lexCos)+Math.round(2*cmp.biCos)+(hasTheme?1:0)+(asksVerdict?1:0)+(mentionsBurden?1:0)-Math.min(2,Math.floor(bm.fillers/4)),1,10);
    }

    if(isClose){
      const lower=text.toLowerCase();
      const rebut=/\b(refut|they said|they claim|opposing counsel)\b/.test(lower);
      const structHits=Math.round(cmp.struct*6);
      organization=clamp(4+structHits,1,10);
      refutation=rebut?8:4;
    }

    if(isDir){
      const qMd=questionMetrics(text,sec);
      if(qMd.qCount>0){ const or=qMd.openRatio; openq=or>=0.75?10:or>=0.60?9:or>=0.50?7:or>=0.35?5:3; openq=clamp(openq-Math.min(3,Math.floor(qMd.leadCount/3)),1,10); } else openq=4;
      foundation=qMd.foundationCount>=3?9:qMd.foundationCount===2?8:qMd.foundationCount===1?6:3;

      /* FIX for the "line 445" ternary \u2192 explicit if/else */
      if (qMd.followupCount >= 3) {
        listening = 9;
      } else if (qMd.followupCount === 2) {
        listening = 7;
      } else if (qMd.followupCount === 1) {
        listening = 6;
      } else {
        listening = 4;
      }

      contentCore=clamp(Math.round(0.45*foundation+0.30*listening+0.15*organization+0.10*(cmp.lexCos*10)),1,10);
      organization=clamp(organization+(qMd.compoundRate<=0.05?1:0),1,10);
    }

    if(isCross){
      const qMc=questionMetrics(text,sec);
      if(qMc.qCount>0){ const lr=qMc.leadRatio; const density=bandScore(qMc.qPerMin,10,18); let baseLead=lr>=0.75?10:lr>=0.60?9:lr>=0.45?7:lr>=0.30?5:4; leading=clamp(Math.round(0.75*baseLead+0.25*density),1,10); } else leading=4;
      impeach=qMc.impeachCount>=3?9:qMc.impeachCount===2?7:qMc.impeachCount===1?6:3;
      let brev=bandScore(qMc.avgTokens||0,4,10); brev-=Math.min(3,Math.floor(qMc.compoundCount/2)); brevity=clamp(brev,1,10);
      contentCore=clamp(Math.round(0.40*leading+0.30*impeach+0.20*brevity+0.10*(cmp.biCos*10)),1,10);
      organization=clamp(organization+(brevity>=8?1:0)-(qMc.compoundRate>0.15?1:0),1,10);
    }


    const conf=RUBRICS[type]; const pack={};
    if(isOpen){pack.content=contentCore;pack.organization=organization;pack.persuasion=persuasion;pack.delivery=delivery;}
    else if(isClose){pack.content=contentCore;pack.organization=organization;pack.refutation=refutation;pack.persuasion=persuasion;pack.delivery=delivery;}
    else if(isDir){pack.content=contentCore;pack.openq=openq;pack.foundation=foundation;pack.listening=listening;pack.delivery=delivery;}
    else {pack.content=contentCore;pack.leading=leading;pack.impeach=impeach;pack.brevity=brevity;pack.delivery=delivery;}
    if((isOpen||isClose) && effWords<200){
      Object.keys(pack).forEach(k=>{pack[k]=clamp(pack[k]-1,1,10);});
    } else if(isOpen && effWords>=300 && effWords<=600){
      Object.keys(pack).forEach(k=>{pack[k]=clamp(pack[k]+1,1,10);});
    }

    let total=0; conf.cats.forEach(c=>{ total+=clamp(pack[c.key],1,10)*(c.w*10) }); total=Math.round(total);
    if(effWords<10 && qM.qCount<2) total=Math.min(total,25);

    return {buildScores(){return {cats:pack,total,metrics:bm,compare:cmp,qm:qM,effWords}}};
  }

  function scorebar(val){
    if(!Number.isFinite(val)){
      return '<div>N/A<div class="scorebar"><span style="width:0%"></span></div></div>';
    }
    const pct=clamp(Math.round((val/10)*100),0,100);
    return `<div>${val}/10<div class="scorebar"><span style="width:${pct}%"></span></div></div>`;
  }

  function renderReport(type, result){
    const conf=RUBRICS[type], pack=result.cats, m=result.metrics, cmp=result.compare;
    const comments=result.comments||{};
    const hasComments=Object.keys(comments).length>0;
    const rows=conf.cats.map(c=>`<tr><td>${c.n}</td><td style="width:220px">${scorebar(pack[c.key])}</td>${hasComments?`<td>${escHTML(comments[c.key]||'')}</td>`:''}</tr>`).join('');
    const ratingText=result.rating || scoreToRating(result.total);
    let rangeDisplay='N/A';
    if(result.range){
      const rawRange=String(result.range).trim();
      const match=rawRange.match(/^(\d+(?:\.\d+)?)\s*[\u2013\u2014\-]\s*(\d+(?:\.\d+)?)/);
      if(match){
        rangeDisplay=escHTML(match[1]===match[2]?match[1]:rawRange);
      }else{
        rangeDisplay=escHTML(rawRange);
      }
    }
    const decimalsNote=typeof result.decimals_used==='string'&&result.decimals_used.trim()?escHTML(result.decimals_used.trim()):'';
    const justifications=Array.isArray(result.midband_justification)?result.midband_justification:[];
    const midbandMeta=result.midbandMeta||null;
    let html=`
      <div><strong>${conf.name} \u2014 Judge Rubric Report</strong></div>
      <table class="table"><thead><tr><th>Category</th><th>Score</th>${hasComments?'<th>Comment</th>':''}</tr></thead><tbody>${rows}</tbody></table>
      <div class="kv" style="margin-top:8px">
        <div>Final Rating</div><div><strong>${ratingText}</strong></div>
        <div>Score</div><div>${result.total} / 100</div>
        <div>Range</div><div>${rangeDisplay}</div>
        ${decimalsNote?`<div class="coach-hidden" data-metric="decimals-note-label">Decimals Note</div><div class="coach-hidden" data-metric="decimals-note-value">${decimalsNote}</div>`:''}
        <div>Words</div><div>${m.wordCount}</div>
        <div>WPM</div><div>${m.wpm||'N/A'}</div>
        <div class="coach-hidden" data-metric="fillers-label">Fillers</div><div class="coach-hidden" data-metric="fillers-value">${m.fillers}</div>
        <div>Signposts</div><div>${m.signposts}</div>
        <div class="coach-hidden" data-metric="vocab-label">Vocab Richness</div><div class="coach-hidden" data-metric="vocab-value">${m.vocabRich.toFixed(1)}/10</div>
        <div class="coach-hidden" data-metric="exemplar-lex-label">Exemplar Similarity (lex)</div><div class="coach-hidden" data-metric="exemplar-lex-value">${Math.round(cmp.lexCos*100)}%</div>
        <div class="coach-hidden" data-metric="exemplar-bi-label">Exemplar Similarity (bigrams)</div><div class="coach-hidden" data-metric="exemplar-bi-value">${Math.round(cmp.biCos*100)}%</div>
      </div>`;
    if(result.explanation){
      html+=`<div class="small" style="margin-top:8px"><strong>Explanation:</strong> ${escHTML(result.explanation)}</div>`;
    }
    if(result.notes){
      html+=`<div class="small" style="margin-top:4px"><strong>Notes:</strong> ${escHTML(result.notes)}</div>`;
    }
    if(justifications.length){
      const items=justifications.map(j=>`<li>${escHTML(j)}</li>`).join('');
      html+=`<div class="small" style="margin-top:4px"><strong>Mid-band checklist notes (${justifications.length}):</strong><ul class="small" style="margin:4px 0 0 18px;">${items}</ul></div>`;
    }
    if(midbandMeta){
      const auditParts=[];
      let auditWarn=false;
      const passes=midbandMeta.attempts||0;
      if(midbandMeta.midbandTriggered){
        if(midbandMeta.finalInBand){
          auditParts.push(`Stayed in 75–80 after ${passes||1} reconsideration${(passes||1)===1?'':'s'} with ${midbandMeta.justificationCount||0} checklist observations logged.`);
        } else {
          auditParts.push(`Moved outside 75–80 after ${passes||1} reconsideration${(passes||1)===1?'':'s'}.`);
        }
      } else if(result.total>=75 && result.total<=80 && justifications.length>=2){
        auditParts.push('Mid-band total justified without additional reconsideration.');
      }
      if(midbandMeta.categoryTriggered){
        const delta = typeof midbandMeta.finalCategoryDelta === 'number' && Number.isFinite(midbandMeta.finalCategoryDelta)
          ? midbandMeta.finalCategoryDelta.toFixed(1)
          : null;
        const deltaNote = delta ? ` (delta ${delta})` : '';
        if(midbandMeta.categoryAligned){
          auditParts.push(`Category totals realigned to match the reported total${deltaNote}.`);
        } else {
          auditParts.push(`Warning: category totals still misaligned with the reported total${deltaNote}.`);
          auditWarn=true;
        }
      }
      if(midbandMeta.autoFilledDecimals){
        const note = midbandMeta.decimalsValue ? ` (${midbandMeta.decimalsValue})` : '';
        auditParts.push(`Decimals note auto-filled${note}.`);
      }
      if(auditParts.length){
        html+=`<div class="small" style="margin-top:4px"><strong>Audit:</strong> ${escHTML(auditParts.join(' '))}</div>`;
      }
      if(auditWarn && !(!justifications.length && result.total>=75 && result.total<=80)){
        html+=`<div class="warn" style="margin-top:6px">Audit flags require follow-up.</div>`;
      }
    }
    if(result.qa && result.qa.length){
      const qaRows=result.qa.map((qa,i)=>`<tr><td>${i+1}</td><td>${escHTML(qa.q||'')}</td><td>${qa.qScore||''} - ${escHTML(qa.qReason||'')}</td><td>${escHTML(qa.a||'')}</td><td>${qa.aScore||''} - ${escHTML(qa.aReason||'')}</td></tr>`).join('');
      html+=`<div style="margin-top:8px"><strong>Question/Answer Feedback</strong></div><table class="table"><thead><tr><th>#</th><th>Question</th><th>Q Score</th><th>Answer</th><th>A Score</th></tr></thead><tbody>${qaRows}</tbody></table>`;
    }
    let voiceHTML='';
    if(result.audio){
      const a=result.audio;
      voiceHTML+=`<div class="kv" style="margin-top:8px">
        <div>Volume</div><div>${escHTML(a.volRating)} (${a.avgVolume} dB)</div>
        <div>Tone</div><div>${escHTML(a.toneRating)} (${a.pitchVar} Hz)</div>
        <div>Clarity</div><div>${escHTML(a.clarityRating)}</div>
        <div>Speed</div><div>${escHTML(a.speedRating)} (${a.wpm} WPM)</div>
      </div>`;
      voiceHTML+=`<div class="small" style="margin-top:4px"><strong>Voice Tips:</strong> ${escHTML(a.tips)}</div>`;
    }
    html+=`<div id="voiceFeedback" style="display:none;margin-top:8px">${voiceHTML}</div>`;
    $('videoFeedback').innerHTML=html;
    $('videoFeedback').style.display='block';
    const btn=$('btnShowVoice');
    if(btn) btn.textContent='Show Voice';
  }

  function setStatus(msg,isErr=false){const s=$('videoStatus');s.textContent=msg||'';s.style.color=isErr?'#ef9a9a':'#9aa4b2'}
  function describeRecording(hasVideo,hasAudio){
    if(hasVideo&&hasAudio) return 'Recording video + audio…';
    if(hasVideo) return 'Recording video (mic off)…';
    if(hasAudio) return 'Recording audio only…';
    return 'Recording…';
  }
  function describeMediaStatus(hasVideo,hasAudio){
    if(hasVideo&&hasAudio) return 'Video + audio';
    if(hasVideo) return 'Video only (no mic)';
    if(hasAudio) return 'Audio only (no camera)';
    return 'No media tracks';
  }
  function updateRecordingIndicator(isRecording,hasVideo=false,hasAudio=false){
    const badge=$('recordingBadge');
    const detail=$('mediaStatus');
    if(badge){
      badge.classList.toggle('active',!!isRecording);
      badge.setAttribute('aria-hidden',isRecording?'false':'true');
    }
    if(detail){
      if(isRecording){
        detail.textContent=describeMediaStatus(hasVideo,hasAudio);
        detail.style.color=hasVideo&&hasAudio?'#16a34a':'#ef4444';
      }else{
        detail.textContent='';
        detail.style.color='var(--muted)';
      }
    }
  }
  function tUpd(){ $('videoTimer').textContent=new Date(sec*1000).toISOString().substr(14,5)}

  function blobToBase64(blob){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      // Data URLs may contain extra commas before the base64 payload (e.g. codec lists).
      // Split on commas and take the last segment to ensure we return only the encoded data.
      reader.onload=()=>{
        const result = reader.result || '';
        const b64 = result.split(',').pop() || '';
        resolve(b64);
      };
      reader.onerror=reject;
      reader.readAsDataURL(blob);
    });
  }

  async function analyzeVoice(blob){
    try{
      const arrayBuffer=await blob.arrayBuffer();
      const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const audioBuffer=await audioCtx.decodeAudioData(arrayBuffer);
      const data=audioBuffer.getChannelData(0);
      const sampleRate=audioBuffer.sampleRate;
      let sumSq=0,claritySum=0;
      for(let i=0;i<data.length;i++){
        const v=data[i];
        sumSq+=v*v;
        if(i>0) claritySum+=Math.abs(v-data[i-1]);
      }
      const rms=Math.sqrt(sumSq/data.length);
      const db=20*Math.log10(rms);
      const clarityScore=claritySum/data.length;
      let clarityRating='Clear';
      if(clarityScore<0.015) clarityRating='Muffled';
      function autoCorrelate(buf,sampleRate){
        let bestOff=-1,bestCorr=0;
        const maxSample=Math.min(buf.length,sampleRate);
        for(let off=50;off<sampleRate/2;off++){
          let corr=0;
          for(let i=0;i<maxSample;i++){
            const v1=buf[i],v2=buf[i+off];
            if(v1===undefined||v2===undefined) break;
            corr+=v1*v2;
          }
          if(corr>bestCorr){bestCorr=corr;bestOff=off;}
        }
        return (bestOff>0&&bestCorr>0)?sampleRate/bestOff:0;
      }
      const step=Math.floor(sampleRate/10);
      const pitches=[];
      for(let i=0;i+step*2<data.length;i+=step){
        const slice=data.slice(i,i+step);
        const p=autoCorrelate(slice,sampleRate);
        if(p>50&&p<500) pitches.push(p);
      }
      const avgPitch=pitches.length?pitches.reduce((a,b)=>a+b,0)/pitches.length:0;
      const pitchVar=pitches.length?Math.sqrt(pitches.reduce((s,v)=>s+(v-avgPitch)**2,0)/pitches.length):0;
      let volRating='Good';
      if(db<-40) volRating='Too quiet'; else if(db>-10) volRating='Too loud';
      let toneRating='Good';
      if(pitchVar<20) toneRating='Too steady'; else if(pitchVar>150) toneRating='Too much change';
      const tips=[];
      if(volRating!=='Good') tips.push(volRating==='Too quiet'?'Speak louder.':'Speak softer.');
      else tips.push('Volume level is good.');
      if(toneRating==='Too steady') tips.push('Add more pitch variety.');
      else if(toneRating==='Too much change') tips.push('Steady your tone.');
      else tips.push('Tone variation is good.');
      if(clarityRating!=='Clear') tips.push('Enunciate more for clarity.');
      tips.push('Use strategic pauses and vary your pace for emphasis.');

      const rawPoints=[];
      const segLen=sampleRate; // 1s segments
      let prevSegPitch=null;
      for(let start=0; start+segLen<=data.length; start+=segLen){
        let sSumSq=0,sClarity=0;
        for(let i=start;i<start+segLen;i++){
          const v=data[i];
          sSumSq+=v*v;
          if(i>start) sClarity+=Math.abs(v-data[i-1]);
        }
        const segRms=Math.sqrt(sSumSq/segLen);
        const segDb=20*Math.log10(segRms);
        const time=start/sampleRate;
        if(segDb<-40) rawPoints.push({time,msg:'speak louder'});
        else if(segDb>-10) rawPoints.push({time,msg:'speak softer'});

        const localPitches=[];
        for(let i=start;i+step<start+segLen && i+step*2<data.length;i+=step){
          const slice=data.slice(i,i+step);
          const p=autoCorrelate(slice,sampleRate);
          if(p>50&&p<500) localPitches.push(p);
        }
        if(localPitches.length){
          const segAvg=localPitches.reduce((a,b)=>a+b,0)/localPitches.length;
          const segVar=Math.sqrt(localPitches.reduce((s,v)=>s+(v-segAvg)**2,0)/localPitches.length);
          if(segVar<15) rawPoints.push({time,msg:'add pitch variety'});
          else if(segVar>180) rawPoints.push({time,msg:'steady your tone'});
          if(prevSegPitch!==null && Math.abs(segAvg-prevSegPitch)>50) rawPoints.push({time,msg:'voice trembling'});
          prevSegPitch=segAvg;
        }
        const segClarity=sClarity/segLen;
        if(segClarity<0.015) rawPoints.push({time,msg:'enunciate words'});
      }

      let words=[], transcript="";
      if(typeof EngineState!=="undefined" && EngineState.openaiKey){
        try{
          const wav=await blobToWav(blob);
          const t=await transcribeFileDetailed(wav,'audio.wav');
          if(t){ transcript=t.text||""; words=Array.isArray(t.words)?t.words:[]; }
        }catch(_e){}
      }

      if(!words.length){
        const tEl=document.getElementById('videoTranscript');
        const txt=tEl?tEl.value.trim():"";
        if(txt){
          const rawWords=txt.split(/\s+/).filter(Boolean);
          const total=data.length/sampleRate;
          const step=rawWords.length?total/rawWords.length:0;
          words=rawWords.map((w,i)=>({word:w,start:i*step,end:(i+1)*step}));
          transcript=txt;
        }
      }

      let wpm=0, speedRating='';
      if(words.length>1){
        const dur=words[words.length-1].end-words[0].start;
        if(dur>0){
          wpm=words.length/(dur/60);
          speedRating=wpm<100?'Too slow':wpm>135?'Too fast':'Good';
          tips.push(speedRating==='Too slow'?'Increase your pace.':speedRating==='Too fast'?'Slow down your delivery.':'Speaking pace is good.');
        }
        for(let i=0;i<words.length-1;i++){
          const gap=words[i+1].start-words[i].start;
          if(gap>0){
            const wpmLocal=60/gap;
            if(wpmLocal>180) rawPoints.push({time:words[i].start,msg:'speaking too fast',word:words[i].word});
            else if(wpmLocal<120) rawPoints.push({time:words[i].start,msg:'speaking too slow',word:words[i].word});
          }
        }
      }

      rawPoints.sort((a,b)=>a.time-b.time);
      const merged=[];
      for(const pt of rawPoints){
        const last=merged[merged.length-1];
        if(last && pt.time-last.end<1){
          last.end=pt.time;
          if(pt.word) last.words.push(pt.word);
          last.msgs.add(pt.msg);
        }else{
          merged.push({start:pt.time,end:pt.time,words:pt.word?[pt.word]:[],msgs:new Set([pt.msg])});
        }
      }
      const priority={'enunciate words':1,'voice trembling':2,'speaking too slow':3,'speaking too fast':4,'speak louder':5,'speak softer':6,'add pitch variety':7,'steady your tone':8};
      const resolved=merged.map(g=>{const msgs=[...g.msgs].sort((a,b)=>(priority[a]||99)-(priority[b]||99));return {msg:msgs[0],start:g.start,end:g.end,words:g.words};});

      const points=resolved.map(group=>{
        let phrase="";
        if(group.words.length){
          phrase=group.words.map(w=>w.trim()).join(' ');
        }else if(words.length){
          const mid=group.start+0.5;
          const nearest=words.reduce((a,b)=>Math.abs(b.start-mid)<Math.abs(a.start-mid)?b:a);
          if(Math.abs(nearest.start-mid)<=1.5) phrase=nearest.word.trim();
        }
        const quote=phrase?` "${phrase}"`:"";
        const around=quote?` around${quote}`:"";
        switch(group.msg){
          case 'speak louder':
            return `Speak louder${around} to project confidence.`;
          case 'speak softer':
            return `Speak softer${around} to create contrast.`;
          case 'add pitch variety':
            return `Add pitch variety${around} to keep the audience engaged.`;
          case 'steady your tone':
            return `Steady your tone${around} for a smoother delivery.`;
          case 'voice trembling':
            return `Pause here${around} and steady your voice.`;
          case 'enunciate words':
            return `Pause and enunciate${around} for clarity.`;
          case 'speaking too fast':
            return `Slow down here${around} to let the message land.`;
          case 'speaking too slow':
            return `Speed up here${around} to maintain energy.`;
          default:
            return `${group.msg}${around}.`;
        }
      });

      const res={avgVolume:+db.toFixed(1),avgPitch:+avgPitch.toFixed(1),pitchVar:+pitchVar.toFixed(1),clarity:+clarityScore.toFixed(3),volRating,toneRating,clarityRating,tips:tips.join(' '),points};
      if(words.length) res.words=words;
      if(transcript) res.transcript=transcript;
      if(wpm){ res.wpm=+wpm.toFixed(1); res.speedRating=speedRating; }
      return res;
    }catch(e){return null;}
  }

  async function requestMicStream(){
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) throw new Error('Mic API unavailable');
    const attempts=[
      {audio:{channelCount:1,noiseSuppression:true,echoCancellation:true}},
      {audio:{noiseSuppression:true,echoCancellation:true}},
      {audio:true}
    ];
    let err=null;
    for(const constraints of attempts){
      try{
        const mic=await navigator.mediaDevices.getUserMedia(constraints);
        if(mic && mic.getAudioTracks().length){
          return mic;
        }
        mic?.getTracks?.().forEach(track=>track.stop());
      }catch(e){
        err=e;
      }
    }
    throw err || new Error('Microphone unavailable');
  }

  async function startCamera(){
    setStatus('Requesting camera/mic\u2026');
    updateRecordingIndicator(false);
    $('movementFeedback').innerHTML='';
    const flipBtn=$('btnFlipCamera');
    if(flipBtn) flipBtn.disabled=true;
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ setStatus('Camera API not available in this environment.',true); if(flipBtn) flipBtn.disabled=false; return; }
    let hasAudio=true, hasVideo=true;
    const preferredFacing=currentFacingMode?{facingMode:{exact:currentFacingMode}}:true;
    const attemptConstraints=[
      {video:preferredFacing,audio:true},
      {video:currentFacingMode?{facingMode:currentFacingMode}:true,audio:true},
      {video:currentFacingMode?{facingMode:{ideal:currentFacingMode}}:true,audio:true},
      {video:true,audio:true}
    ];
    let lastErr=null;
    stream=null;
    for(const constraints of attemptConstraints){
      try{
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        break;
      }catch(err){
        lastErr=err;
      }
    }
    try{
      if(!stream){
        stream=await navigator.mediaDevices.getUserMedia({video:preferredFacing});
        hasAudio=false;
      }
    }catch(e){
      lastErr=e;
    }
    if(!stream){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:true});
        hasAudio=false;
      }catch(e2){
        lastErr=e2;
        try{
          stream=await navigator.mediaDevices.getUserMedia({audio:true});
          hasVideo=false; hasAudio=true;
        }catch(e3){ if(flipBtn) flipBtn.disabled=false; setStatus('Camera/mic error: '+(e3?.message||lastErr?.message||'Unavailable'), true); return; }
      }
    }
    if(!stream){ if(flipBtn) flipBtn.disabled=false; setStatus('Camera/mic error: '+(lastErr?.message||'Unavailable'), true); return; }
    hasVideo=stream.getVideoTracks().length>0;
    hasAudio=stream.getAudioTracks().length>0;

    if(hasVideo && !hasAudio){
      try{
        const micStream=await requestMicStream();
        const audioTracks=micStream.getAudioTracks();
        if(audioTracks.length){
          const combined=new MediaStream();
          stream.getVideoTracks().forEach(track=>combined.addTrack(track));
          audioTracks.forEach(track=>combined.addTrack(track));
          stream=combined;
          hasAudio=true;
        }
      }catch(e){
        console.warn('VideoCoach: unable to attach microphone', e);
        setStatus('Microphone unavailable; recording video only.', true);
      }
    }

    if(hasAudio){
      stream.getAudioTracks().forEach(track=>{ track.enabled=true; });
    }
    if(hasVideo){ $('videoPreview').srcObject=stream; $('videoPreview').muted=true; try{ await $('videoPreview').play(); }catch(_){}}
    else {
      $('videoPreview').srcObject=hasAudio?stream:null;
      $('videoPreview').muted=true;
    }
    const types= hasVideo
       ? (hasAudio?['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/mp4;codecs=h264,aac','video/mp4']
                  :['video/webm;codecs=vp9','video/webm;codecs=vp8','video/mp4'])
       : ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mpeg'];
    const mime=types.find(t=>MediaRecorder.isTypeSupported(t))||'';
    chunks=[]; try{ rec=new MediaRecorder(stream, mime?{mimeType:mime}:undefined); }catch(e){ setStatus('MediaRecorder not supported: '+e.message, true); rec=null; }
    if(!rec){
      updateRecordingIndicator(false);
      if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; }
      if(flipBtn) flipBtn.disabled=false;
      $('btnVideoStart').disabled=false;
      $('btnStopRecording').disabled=true;
      return;
    }
    rec.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data) };
    rec.onstop=()=>{
      const type=rec.mimeType||mime||(hasVideo?'video/webm':'audio/webm');
      const blob=new Blob(chunks,{type});
      lastVideoBlob=blob;
      lastVideoDuration=sec;
      if(lastVideoUrl){
        try{ URL.revokeObjectURL(lastVideoUrl); }catch(_){ }
      }
      lastVideoUrl=URL.createObjectURL(blob);
      const url=lastVideoUrl;
      const playBtn=$('btnPlayRecording');
      if(playBtn){
        playBtn.onclick=()=>{
          const v=$('videoPreview');
          v.srcObject=null;
          v.src=url;
          v.controls=true;
          v.play().catch(()=>{});
        };
      }
      try{
        const temp=document.createElement('video');
        temp.preload='metadata';
        temp.muted=true;
        const cleanup=()=>{
          temp.removeAttribute('src');
          try{ temp.load(); }catch(_){ }
        };
        temp.onloadedmetadata=()=>{
          if(Number.isFinite(temp.duration) && temp.duration>0){
            lastVideoDuration=temp.duration;
          }
          cleanup();
        };
        temp.onerror=cleanup;
        temp.src=url;
        try{ temp.load(); }catch(_){ }
      }catch(_){ }
    };
    let audioLossNotified=false;
    const notifyAudioLoss=()=>{
      if(audioLossNotified) return;
      audioLossNotified=true;
      hasAudio=false;
      if(rec && rec.state==='recording'){
        updateRecordingIndicator(true, stream.getVideoTracks().length>0, false);
        setStatus('Microphone disconnected during capture. Audio will be missing.', true);
      }
    };
    stream.getAudioTracks().forEach(track=>{
      if(track.addEventListener){
        track.addEventListener('ended', notifyAudioLoss, {once:false});
        track.addEventListener('mute', notifyAudioLoss, {once:false});
      }
      track.onended=notifyAudioLoss;
      track.onmute=notifyAudioLoss;
    });

    rec.start();
    sec=0; tUpd(); if(timer) clearInterval(timer); timer=setInterval(()=>{sec++;tUpd()},1000);
    $('btnVideoStart').disabled=true; $('btnStopRecording').disabled=false; $('btnAnalyzeMovement').disabled=!hasVideo;
    const recordingMsg=describeRecording(hasVideo,hasAudio);
    setStatus(recordingMsg, !hasAudio);
    updateRecordingIndicator(true,hasVideo,hasAudio);
    if(hasAudio){
      try{
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        if(SR){ recog=new SR(); recog.continuous=true; recog.interimResults=true; recog.lang='en-US';
          recog.onresult=ev=>{ let txt=''; for(let i=0;i<ev.results.length;i++){ txt+=ev.results[i][0].transcript+' ' } $('videoTranscript').value=txt.trim(); };
          recog.onerror=err=>setStatus('Speech recognition: '+err.error,true); recog.start();
        } else { setStatus('Live transcript not supported by this browser. You can paste a transcript.',true); }
      }catch(e){ setStatus('Speech recognition init error: '+e.message,true); }
    }
  }

  function stop(){
    if(timer){ clearInterval(timer); timer=null; }
    lastVideoDuration=sec;
    if(rec&&rec.state!=='inactive'){ rec.stop(); }
    if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; }
    if(recog){ try{ recog.stop(); }catch(e){} recog=null; }
    updateRecordingIndicator(false);
    const flipBtn=$('btnFlipCamera'); if(flipBtn) flipBtn.disabled=false;
    $('btnVideoStart').disabled=false; $('btnStopRecording').disabled=true;
    setStatus('Stopped. You can Re-score after editing transcript.');
    setTimeout(scoreNow,250);
  }

  function flipCamera(){
    if(rec&&rec.state==='recording'){
      setStatus('Stop recording before flipping camera.', true);
      return;
    }
    currentFacingMode=currentFacingMode==='user'?'environment':'user';
    const label=currentFacingMode==='user'?'front':'rear';
    setStatus(`Next recording will use the ${label} camera.`);
  }

  function buildChatGPTPrompt(type, transcript){
    const conf = RUBRICS[type] || { cats: [] };
    const rubricMap = STATES[CURRENT_STATE]?.rubricMap || {};
    const rubric = rubricMap[type] || rubricMap.opening;
    const typeLabels = {
      opening: 'OPENING STATEMENT',
      closing: 'CLOSING ARGUMENT',
      direct: 'DIRECT EXAMINATION',
      cross: 'CROSS EXAMINATION'
    };
    const selectedLabel = typeLabels[type] || type?.toString().toUpperCase() || 'PERFORMANCE';
    const cats = Array.isArray(conf.cats) ? conf.cats : [];
    const catKeys = cats.map(c => c.key);
    const catLabels = cats.map(c => c.n || c.key);
    const catWeights = cats.map(c => Math.round(c.w * 100));
    const focusMap = VIDEO_CATEGORY_FOCUS[type] || {};
    const catFocus = cats.map(c => focusMap?.[c.key] || '');
    const categoryLines = cats.length
      ? cats.map((c, idx) => {
          const weight = Number.isFinite(catWeights[idx]) ? catWeights[idx] : Math.round((c.w || 0) * 100);
          const focus = catFocus[idx] ? ` – ${catFocus[idx]}` : '';
          return `• ${c.n} (${c.key}): weight ${weight}${focus}`;
        }).join('\n')
      : '';
    const calibration = 'Video score calibration (0-100 total): 92-100 national champion; 85-91 state finals; 78-84 competitive with notable gaps; 70-77 developing; below 70 major issues or rule breaches.';
    const mismatch = 'If the transcript sounds like a different role, note the mismatch in "notes" and lower the misaligned categories instead of changing the rubric.';
    const commentNote = 'Tie every category comment and summary point to concrete transcript cues—quote phrases, reference question numbers, or cite exhibit names. Do not invent physical actions you cannot infer.';
    const verification = 'Recompute the weighted total from the category scores before you answer. If the math does not align, revise the categories or total—misaligned math is rejected and you must correct it before replying.';
    const rubricDiscipline = 'Walk the rubric checkpoint by checkpoint; when the transcript misses one, lower the precise category and cite the gap in your comments.';
    const mathDiscipline = 'Do not submit until every required category has a deliberate 0–100 score with one decimal and the weighted sum equals your "total" field.';
    const autop70 = 'Never rely on a default or placeholder like 70/100. Choose the score that the transcript actually earns, even if it lands at an extreme.';
    const extras = [
      `The competitor explicitly selected this performance as a ${selectedLabel}. Score it strictly as a ${selectedLabel} using the provided rubric, even if the transcript resembles another format.`,
      calibration,
      categoryLines ? `Category checkpoints:\n${categoryLines}` : '',
      rubricDiscipline,
      verification,
      mathDiscipline,
      autop70,
      commentNote,
      mismatch
    ].filter(Boolean).join('\n\n');
    const basePrompt = ChatGPTScoring.buildScoringPrompt(transcript, false, rubric, {
      relaxed: true,
      mode: 'video',
      catKeys,
      catLabels,
      catWeights,
      catFocus
    });
    return `${extras}\n\n${basePrompt}`;
  }

  function buildChatGPTMessages(type, transcript){
    const prompt = buildChatGPTPrompt(type, transcript);
    return [{role:'user', content: prompt}];
  }

  function parseChatGPTScoreResponse(text){
    const obj = extractFirstJson(text);
    if(!obj) throw new Error('bad_json');
    return obj;
  }

  function normalizeScorePayload(payload){
    if(!payload) return;
    const clampScore=v=>Math.max(0,Math.min(100,Number(v)));
    const toOneDecimal=v=>Number(clampScore(v).toFixed(1));
    const normalizeValue=raw=>{
      const num=Number(raw);
      if(!Number.isFinite(num)) return undefined;
      const scaled=num<=10?num*10:num;
      return toOneDecimal(scaled);
    };

    if(Number.isFinite(Number(payload.total))){
      const normalizedTotal=normalizeValue(payload.total);
      if(Number.isFinite(normalizedTotal)){
        payload.total=normalizedTotal;
      } else {
        delete payload.total;
      }
    }

    let lowVal=normalizeValue(payload.scoreLow);
    let highVal=normalizeValue(payload.scoreHigh);

    if(typeof payload.range==='string' && payload.range.trim()){
      const normalized=payload.range.replace(/[–—]/g,'-').replace(/\bto\b/gi,'-');
      const parts=normalized.split('-').map(part=>Number(part.trim())).filter(n=>!Number.isNaN(n));
      if(parts.length===2){
        let [lo,hi]=parts;
        if(lo<=10 && hi<=10){ lo*=10; hi*=10; }
        const normLo=toOneDecimal(lo);
        const normHi=toOneDecimal(hi);
        if(!Number.isFinite(lowVal)) lowVal=normLo;
        if(!Number.isFinite(highVal)) highVal=normHi;
      } else if(parts.length===1){
        let val=parts[0];
        if(val<=10) val*=10;
        const normalizedSingle=toOneDecimal(val);
        if(!Number.isFinite(lowVal) && !Number.isFinite(highVal)){
          lowVal=normalizedSingle;
          highVal=normalizedSingle;
        }
      }
    }

    if(Number.isFinite(lowVal) && Number.isFinite(highVal)){
      const low=Math.min(lowVal,highVal);
      const high=Math.max(lowVal,highVal);
      payload.scoreLow=low;
      payload.scoreHigh=high;
      payload.range=`${low.toFixed(1)}-${high.toFixed(1)}`;
      if(!Number.isFinite(Number(payload.total))){
        payload.total=toOneDecimal((low+high)/2);
      }
      return;
    }

    if(Number.isFinite(lowVal)){
      payload.scoreLow=toOneDecimal(lowVal);
      payload.scoreHigh=payload.scoreLow;
      payload.range=`${payload.scoreLow.toFixed(1)}-${payload.scoreHigh.toFixed(1)}`;
      if(!Number.isFinite(Number(payload.total))){
        payload.total=payload.scoreLow;
      }
      return;
    }

    if(Number.isFinite(highVal)){
      payload.scoreHigh=toOneDecimal(highVal);
      payload.scoreLow=payload.scoreHigh;
      payload.range=`${payload.scoreLow.toFixed(1)}-${payload.scoreHigh.toFixed(1)}`;
      if(!Number.isFinite(Number(payload.total))){
        payload.total=payload.scoreHigh;
      }
      return;
    }

    if(typeof payload.range==='string' && payload.range.trim()){
      const single=normalizeValue(payload.range);
      if(Number.isFinite(single)){
        payload.scoreLow=single;
        payload.scoreHigh=single;
        payload.range=`${single.toFixed(1)}-${single.toFixed(1)}`;
        if(!Number.isFinite(Number(payload.total))){
          payload.total=single;
        }
      }
    }
  }

  // --- Type detector (keyword + structure heuristics) ---
  function detectSpeechType(text){
    const s = (text||'').toLowerCase();
    const count = (re)=> (s.match(re)||[]).length;

    const openingHits = count(/\b(the evidence will show|you will (hear|see)|our roadmap|theme|story|preponderance|more likely than not|ask you.*verdict)\b/g);
    const closingHits = count(/\b(the (evidence|record) shows|apply(ing)? the law|element(s)?|instruction(s)?|they (said|claim|argue)|therefore|thus|in (conclusion|closing))\b/g);
    const directHits  = count(/\b(please introduce yourself|state your name|what did you observe|how do you recognize|fair and accurate|move to admit|what happened next)\b/g);
    const crossHits   = count(/\b(correct\?|right\?|yes or no|isn'?t it true|you wrote|on page|line \d+|is it true that)\b/g);

    const arr = [
      ['opening', openingHits],
      ['closing', closingHits],
      ['direct',  directHits],
      ['cross',   crossHits]
    ].sort((a,b)=>b[1]-a[1]);

    const [best, bestScore] = arr[0];
    const secondScore = arr[1][1];
    const confidence = bestScore === 0 ? 0 : (bestScore - secondScore) / Math.max(1, bestScore);
    return { type: best, confidence, vector:{opening:openingHits,closing:closingHits,direct:directHits,cross:crossHits} };
  }

  // --- Generic cap helper ---
  function capScore(payload, cap, reasonNote){
    const c = Math.max(0, Math.min(100, Number(cap)));
    if (!Number.isFinite(c)) return;
    const priorTotal = Number(payload.total);
    const priorLow = Number(payload.scoreLow);
    const priorHigh = Number(payload.scoreHigh);

    payload.total = Number.isFinite(priorTotal) ? Number(Math.min(priorTotal, c).toFixed(1)) : Number(c.toFixed(1));

    let newLow = Number.isFinite(priorLow) ? Math.min(priorLow, c) : undefined;
    let newHigh = Number.isFinite(priorHigh) ? Math.min(priorHigh, c) : undefined;

    if (newLow === undefined && newHigh !== undefined) {
      newLow = newHigh;
    } else if (newHigh === undefined && newLow !== undefined) {
      newHigh = newLow;
    } else if (newLow === undefined && newHigh === undefined) {
      newLow = payload.total;
      newHigh = payload.total;
    }

    if (Number.isFinite(newLow) && Number.isFinite(newHigh)) {
      const lowVal = Number(Math.min(newLow, newHigh).toFixed(1));
      const highVal = Number(Math.max(newLow, newHigh).toFixed(1));
      payload.scoreLow = lowVal;
      payload.scoreHigh = highVal;
      payload.range = `${lowVal.toFixed(1)}-${highVal.toFixed(1)}`;
    }

    payload.notes = (payload.notes || '') + `\n(auto-cap: ${reasonNote})`;
    normalizeScorePayload(payload);
  }

  // Backwards-compat alias used by earlier patches
  const capOpeningScore = capScore;

  function normalizeCategoryScore(raw, fallback=null){
    const num=Number(raw);
    if(!Number.isFinite(num)) return fallback;
    let scaled=num;
    if(Math.abs(num)>10){
      scaled=num/10;
    }
    const clamped=Math.max(0,Math.min(10,scaled));
    const fixed=Number(clamped.toFixed(1));
    return Number.isFinite(fixed)?fixed:fallback;
  }

  function normalizeHundredScore(raw){
    const num=Number(raw);
    if(!Number.isFinite(num)) return null;
    const scaled=Math.abs(num)<=10?num*10:num;
    const clamped=Math.max(0,Math.min(100,scaled));
    return Number(clamped.toFixed(1));
  }

  function validateScorePayload(payload, conf){
    const issues=[];
    if(!payload || typeof payload!=='object'){
      issues.push('missing payload');
      return {issues,categories:{},total:null,computed:null,commentCount:0,catUniform:false,categoryAligned:false,categoryDelta:null};
    }

    const categories={};
    let computedSum=0;
    let haveAllCategories=true;
    const cats=Array.isArray(conf?.cats)?conf.cats:[];
    for(const cat of cats){
      const normalized=normalizeCategoryScore(payload?.categories?.[cat.key]);
      if(!Number.isFinite(normalized)){
        issues.push(`missing or invalid category "${cat.n||cat.key}"`);
        haveAllCategories=false;
      }else{
        categories[cat.key]=normalized;
        computedSum+=normalized*(cat.w*10);
      }
    }

    const normalizedTotal=normalizeHundredScore(payload?.total);
    if(normalizedTotal===null){
      issues.push('missing or invalid total score');
    }

    const boundedComputed=haveAllCategories
      ? Number(Math.max(0,Math.min(100,computedSum)).toFixed(1))
      : null;
    let categoryAligned=true;
    let categoryDelta=null;
    if(normalizedTotal!==null && boundedComputed!==null){
      const delta=Number((boundedComputed-normalizedTotal).toFixed(1));
      if(Number.isFinite(delta) && Math.abs(delta)>0.6){
        categoryAligned=false;
        categoryDelta=delta;
      }
    }

    const commentCount=payload && payload.comments && typeof payload.comments==='object'
      ? Object.values(payload.comments).filter(v=>typeof v==='string'&&v.trim()).length
      : 0;
    const catValues=Object.values(categories);
    const catUniform=catValues.length>0 && catValues.every(v=>Math.abs(v-catValues[0])<0.01);
    const suspiciousTotals=new Set([88.2,88.3]);
    if(normalizedTotal!==null && suspiciousTotals.has(Number(normalizedTotal)) && (commentCount===0 || catUniform)){
      issues.push('placeholder-style 88-point total without supporting detail');
    }

    return {
      issues,
      categories,
      total: normalizedTotal,
      computed: boundedComputed,
      commentCount,
      catUniform,
      categoryAligned,
      categoryDelta
    };
  }

  // Retry wrapper: chat first (JSON), then chat (plain), then /responses
  async function robustLLMScore({model, maxTokens, transcript, buildPromptJSON, buildPromptText}) {
    try {
      const raw = await callOpenAIChat({
        messages: [{role: "user", content: buildPromptJSON()}],
        model, maxTokens, json: true
      });
      return { raw, mode: 'chat-json' };
    } catch (e1) {
      try {
        const raw = await callOpenAIChat({
          messages: [{role: "user", content: buildPromptText()}],
          model, maxTokens, json: false
        });
        return { raw, mode: 'chat-text' };
      } catch (e2) {
        try {
          const raw = await callOpenAIResponse({
            model,
            input: [{ role:'user', content: [
              { type:'input_text', text: buildPromptJSON() }
            ]}],
            maxOutputTokens: maxTokens,
            temperature: 0.2
          });
          return { raw, mode: 'responses' };
        } catch (e3) {
          const err = new Error(e3?.message || e2?.message || e1?.message || 'LLM error');
          err.stack = (e3?.stack || e2?.stack || e1?.stack);
          throw err;
        }
      }
    }
  }

  // Hardened: timeout + retry + JSON-safe parsing + logs
  async function scoreViaChatGPT(type, transcript){
    if(!EngineState.openaiKey) throw new Error("no_key");
    const model = EngineState.openaiModel || "gpt-4o";
    const maxTokens = Math.max(200, Math.min(2000, Number(EngineState.openaiMaxTokens)||600));
    const conf = RUBRICS[type] || { cats: [] };

    const eff = effectiveWordCount(transcript);
    if(eff < 8){
      const cats = {}; conf.cats.forEach(c=>{ cats[c.key]=0; });
      return { total:0, explanation:'Transcript too short to score (minimum 8 words).', notes:'', categories: cats, comments:{}, qa:[], raw:'' };
    }

    let rawText='';
    let payload=null;
    let scorerMode=null;
    let typeAudit=null;
    let detectedType=null;
    let mismatch=false;

    try {
      const CONF_STRONG = 0.55;
      typeAudit = detectSpeechType(transcript);
      detectedType = typeAudit?.type || null;
      mismatch = !!(detectedType && detectedType !== type);

      const scorer = await robustLLMScore({
        model,
        maxTokens,
        transcript,
        buildPromptJSON: ()=>buildChatGPTPrompt(type, transcript),
        buildPromptText: ()=>buildChatGPTPrompt(type, transcript)
      });
      rawText = scorer.raw;
      scorerMode = scorer.mode || null;

      function parsePayload(raw){
        let parsed = null;
        try { parsed = parseChatGPTScoreResponse(raw); } catch (parseErr) {}
        if (!parsed) {
          const tParsed = ChatGPTScoring.parseScoreResponse(raw);
          let avg = tParsed.scoreLow || 0, rangeStr = '', lowPct=null, highPct=null;
          if (typeof tParsed.scoreHigh === 'number') {
            avg = (tParsed.scoreLow + tParsed.scoreHigh) / 2;
            lowPct  = Number((tParsed.scoreLow  * 10).toFixed(1));
            highPct = Number((tParsed.scoreHigh * 10).toFixed(1));
            rangeStr = `${lowPct.toFixed(1)}-${highPct.toFixed(1)}`;
          }
          parsed = {
            total: Number((avg * 10).toFixed(1)),
            range: rangeStr, scoreLow: lowPct, scoreHigh: highPct,
            explanation: tParsed.explanation || "", notes: tParsed.improvement || "",
            categories: {}, comments:{}, qa:[]
          };
        }
        if (parsed && !parsed.range && typeof parsed.total_low === 'number' && typeof parsed.total_high === 'number') {
          const low = Number(parsed.total_low);
          const high = Number(parsed.total_high);
          if (Number.isFinite(low) && Number.isFinite(high)) {
            parsed.range = `${low.toFixed(1)}-${high.toFixed(1)}`;
            parsed.scoreLow = Number(low.toFixed(1));
            parsed.scoreHigh = Number(high.toFixed(1));
            if (!Number.isFinite(Number(parsed.total))) {
              parsed.total = Number(((low + high) / 2).toFixed(1));
            }
          }
        }
        if (parsed && !parsed.range) {
          const low = Number(parsed.score_low ?? parsed.low ?? parsed.range_low ?? parsed.scoreLow);
          const high = Number(parsed.score_high ?? parsed.high ?? parsed.range_high ?? parsed.scoreHigh);
          if (Number.isFinite(low) && Number.isFinite(high)) {
            let lowVal = low;
            let highVal = high;
            if (highVal < lowVal) [lowVal, highVal] = [highVal, lowVal];
            const unitScale = highVal <= 10 && lowVal <= 10;
            if (unitScale) {
              lowVal *= 10;
              highVal *= 10;
            }
            const lowFixed = Number(lowVal.toFixed(1));
            const highFixed = Number(highVal.toFixed(1));
            parsed.scoreLow = lowFixed;
            parsed.scoreHigh = highFixed;
            parsed.range = `${lowFixed.toFixed(1)}-${highFixed.toFixed(1)}`;
            if (!Number.isFinite(Number(parsed.total))) {
              parsed.total = Number(((lowVal + highVal) / 2).toFixed(1));
            }
          }
        }
        if (parsed && parsed.range) {
          const normalizedRange = String(parsed.range).replace(/[–—]/g,'-').replace(/\bto\b/gi,'-');
          const parts = normalizedRange.split('-').map(p=>Number(p.trim()));
          if (parts.length === 2 && parts.every(n=>Number.isFinite(n))) {
            let [low, high] = parts;
            if (high < low) [low, high] = [high, low];
            const unitScale = high <= 10 && low <= 10;
            if (unitScale) {
              low *= 10;
              high *= 10;
            }
            const lowFixed = Number(low.toFixed(1));
            const highFixed = Number(high.toFixed(1));
            parsed.scoreLow = lowFixed;
            parsed.scoreHigh = highFixed;
            if (!Number.isFinite(Number(parsed.total))) {
              parsed.total = Number(((low + high) / 2).toFixed(1));
            }
            parsed.range = `${lowFixed.toFixed(1)}-${highFixed.toFixed(1)}`;
          }
        }
        normalizeScorePayload(parsed);
        return parsed;
      }

      payload = parsePayload(rawText);
      if (!payload) throw new Error('empty_payload');

      normalizeScorePayload(payload);

      const categories = {};
      const comments = {};
      conf.cats.forEach(cat=>{
        const normalized = normalizeCategoryScore(payload?.categories?.[cat.key], null);
        categories[cat.key] = Number.isFinite(normalized) ? normalized : null;
        if (typeof payload?.comments?.[cat.key] === 'string') {
          comments[cat.key] = payload.comments[cat.key];
        }
      });

      const total = normalizeHundredScore(payload.total);
      if(!Number.isFinite(total)){
        const err = new Error('score_validation_failed');
        err.code = 'score_validation_failed';
        err.issues = ['missing or invalid total score'];
        err.raw = rawText;
        throw err;
      }

      const low = normalizeHundredScore(payload.scoreLow);
      const high = normalizeHundredScore(payload.scoreHigh);
      const resolvedLow = Number.isFinite(low) ? low : total;
      const resolvedHigh = Number.isFinite(high) ? high : total;

      let range = '';
      if(typeof payload.range === 'string' && payload.range.trim()){
        range = payload.range.trim();
      } else {
        const lowFixed = resolvedLow.toFixed(1);
        const highFixed = resolvedHigh.toFixed(1);
        range = `${lowFixed}-${highFixed}`;
      }

      const result = {
        total: Number(total.toFixed(1)),
        range,
        rating: typeof payload.rating === 'string' && payload.rating.trim()
          ? payload.rating.trim()
          : scoreToRating(total),
        scoreLow: Number(resolvedLow.toFixed(1)),
        scoreHigh: Number(resolvedHigh.toFixed(1)),
        explanation: typeof payload.explanation === 'string' ? payload.explanation : '',
        notes: typeof payload.notes === 'string' ? payload.notes : '',
        categories,
        comments,
        qa: Array.isArray(payload.qa) ? payload.qa : [],
        midband_justification: Array.isArray(payload.midband_justification)
          ? payload.midband_justification.map(v=>typeof v === 'string' ? v.trim() : String(v ?? '')).filter(Boolean)
          : [],
        decimals_used: typeof payload.decimals_used === 'string' ? payload.decimals_used.trim() : '',
        raw: rawText,
        midbandMeta: null,
        audit: {
          selectedType: type,
          usedType: type,
          detectedType,
          mismatchDetected: mismatch,
          detector: typeAudit,
          secondPassUsed: false,
          llmMode: scorerMode,
          detectorVector: typeAudit?.vector || null,
          detectorConfidence: typeAudit?.confidence ?? null
        }
      };

      return result;
    } catch (err) {
      console.error('[scoreViaChatGPT]', err);
      const error = err instanceof Error ? err : new Error(err?.message || 'scoreViaChatGPT failed');
      if (err && typeof err === 'object' && 'raw' in err && err.raw && typeof err.raw === 'string' && !('raw' in error)) {
        error.raw = err.raw;
      } else if (rawText && typeof rawText === 'string' && !('raw' in error)) {
        error.raw = rawText;
      }
      throw error;
    }
  }
  function scoreWithBuiltin(type, raw, audio, reason){
    resetVideoFollowup();

    const transcript = (type==='direct'||type==='cross') ? formatTranscriptQA(raw) : raw;
    const eff = effectiveWordCount(transcript);
    const tooShort = eff < 8;

    const bm  = baseMetrics(transcript);
    const cmp = compareToExemplar(type, transcript);
    const qM  = questionMetrics(transcript, sec);

    const statusEl=$('videoStatus');
    const reasonText=(reason||'').trim();
    let statusMessage='Scoring unavailable until ChatGPT scoring is enabled.';
    let statusColor='#f97316';
    let explanation='Add your ChatGPT (OpenAI) API key under “API Key / Engine” to unlock rubric-based scoring and narrative feedback.';

    if(tooShort){
      const suffix=reasonText?(/[.!?]$/.test(reasonText)?reasonText:`${reasonText}.`):'Transcript too short to score.';
      statusMessage=reasonText || 'Transcript too short to score. Record a longer performance and try again.';
      statusColor='#ef4444';
      explanation=`${suffix} Add more material and re-score to receive full feedback.`;
    } else if(reasonText){
      const suffix=/[.!?]$/.test(reasonText)?reasonText:`${reasonText}.`;
      explanation=`${suffix} Add your ChatGPT (OpenAI) API key under “API Key / Engine” to unlock rubric-based scoring and narrative feedback.`;
    }

    if(statusEl){
      statusEl.innerHTML=`<strong>${escHTML(statusMessage)}</strong>`;
      statusEl.style.color=statusColor;
    }

    const metricsRows=[
      ['Words', bm.wordCount],
      ['WPM', bm.wpm || 'N/A'],
      ['Fillers', bm.fillers],
      ['Signposts', bm.signposts],
      ['Vocab Richness', `${bm.vocabRich.toFixed(1)}/10`],
      ['Exemplar Similarity (lex)', `${Math.round(cmp.lexCos*100)}%`],
      ['Exemplar Similarity (bigrams)', `${Math.round(cmp.biCos*100)}%`]
    ];

    if(type==='direct' || type==='cross'){
      metricsRows.push(['Question Count', qM.qCount]);
      metricsRows.push(['Open Question %', qM.qCount?`${Math.round(qM.openRatio*100)}%`:'N/A']);
      metricsRows.push(['Leading Question %', qM.qCount?`${Math.round(qM.leadRatio*100)}%`:'N/A']);
      metricsRows.push(['Average Question Length', qM.avgTokens ? `${qM.avgTokens.toFixed(1)} words` : 'N/A']);
    }

    const metricsHTML = metricsRows.map(([label,value])=>`<div>${escHTML(label)}</div><div>${escHTML(String(value))}</div>`).join('');

    let voiceHTML='';
    if(audio){
      voiceHTML=`<div class="kv" style="margin-top:8px">
        <div>Volume</div><div>${escHTML(audio.volRating)}${Number.isFinite(audio.avgVolume)?` (${audio.avgVolume} dB)`:''}</div>
        <div>Tone</div><div>${escHTML(audio.toneRating)}${Number.isFinite(audio.pitchVar)?` (${audio.pitchVar} Hz)`:''}</div>
        <div>Clarity</div><div>${escHTML(audio.clarityRating)}</div>
        <div>Speed</div><div>${escHTML(audio.speedRating)}${Number.isFinite(audio.wpm)?` (${audio.wpm} WPM)`:''}</div>
      </div>`;
      if(audio.tips){
        voiceHTML+=`<div class="small" style="margin-top:4px"><strong>Voice Tips:</strong> ${escHTML(audio.tips)}</div>`;
      }
    }

    const warnText = tooShort ? 'No score generated.' : 'Scoring unavailable without ChatGPT.';

    const bodyParts=[
      `<div class="warn" style="margin-bottom:8px">${escHTML(warnText)}</div>`,
      `<div class="small" style="margin-bottom:8px"><strong>Explanation:</strong> ${escHTML(explanation)}</div>`,
      `<div class="kv">${metricsHTML}</div>`
    ];

    if(voiceHTML){
      bodyParts.push(voiceHTML);
    }

    $('videoFeedback').innerHTML=bodyParts.join('');
    $('videoFeedback').style.display='block';

    return null;
  }
  let _scoreLock = false;
  async function scoreNow(){
    if(_scoreLock) return;
    _scoreLock = true;
    const type=$('videoType').value||'opening';
    const raw=$('videoTranscript').value||'';
    const transcript=(type==='direct'||type==='cross')?formatTranscriptQA(raw):raw;
    let audio=null;
    if(lastVideoBlob){ try{ audio=await analyzeVoice(lastVideoBlob); }catch(_){} }

    resetVideoFollowup();

    const eff = effectiveWordCount(transcript);
    if(eff < 8){
      $('videoStatus').textContent='Transcript too short to score (minimum 8 words).';
      scoreWithBuiltin(type, raw, audio, 'Transcript too short to score (minimum 8 words)');
      showProvenance('Transcript too short; no score generated.', true);
      _scoreLock = false;
      return;
    }

    if(EngineState.mode==='chatgpt' && EngineState.openaiKey){
      $('videoStatus').textContent='Scoring via ChatGPT…';
      $('videoFeedback').innerHTML='<div class="small">Contacting ChatGPT…</div>';
      $('videoFeedback').style.display='block';
      scoreViaChatGPT(type, transcript).then(scoreData=>{
  // Use the LLM output AS-IS (no local blending, no WPM/length nudges)
  const usedType = scoreData?.audit?.usedType || type;
  const conf = RUBRICS[usedType] || RUBRICS[type];

  const cats = {};
  const commentsByCat = {};
  if(scoreData.comments && typeof scoreData.comments === 'object'){
    Object.entries(scoreData.comments).forEach(([key,val])=>{
      if(typeof val === 'string') commentsByCat[key] = val;
    });
  }
  conf.cats.forEach(c=>{
    const normalized = normalizeCategoryScore(scoreData.categories?.[c.key], null);
    cats[c.key] = Number.isFinite(normalized) ? normalized : null;
  });

  const m = baseMetrics(transcript);
  if(audio){
    if(!audio.wpm && m.wpm) audio.wpm=m.wpm;
    if(audio.wpm){
      audio.speedRating=audio.wpm<100?'Too slow':audio.wpm>135?'Too fast':'Good';
      audio.tips+=(audio.tips?' ':'')+(audio.speedRating==='Too slow'?'Increase your pace.':audio.speedRating==='Too fast'?'Slow down your delivery.':'Speaking pace is good.');
    }
  }

  const total = normalizeHundredScore(scoreData.total);
  const low = normalizeHundredScore(scoreData.scoreLow);
  const high = normalizeHundredScore(scoreData.scoreHigh);
  const resolvedLow = Number.isFinite(low) ? low : (Number.isFinite(total) ? total : null);
  const resolvedHigh = Number.isFinite(high) ? high : (Number.isFinite(total) ? total : null);
  const finalTotal = Number.isFinite(total) ? Number(total.toFixed(1)) : 0;

  let finalRange = typeof scoreData.range === 'string' ? scoreData.range.trim() : '';
  if(!finalRange){
    if(Number.isFinite(resolvedLow) && Number.isFinite(resolvedHigh)){
      finalRange = `${resolvedLow.toFixed(1)}-${resolvedHigh.toFixed(1)}`;
    } else {
      const fixed = finalTotal.toFixed(1);
      finalRange = `${fixed}-${fixed}`;
    }
  }

  const result = {
    cats,
    comments: commentsByCat,
    explanation: scoreData.explanation || '',
    notes: scoreData.notes || '',
    qa: scoreData.qa || [],
    metrics: m,
    compare: {lexCos:0,biCos:0,mustHits:0,niceHits:0,mustTotal:0,niceTotal:0,struct:0,score:0},
    qm: {qCount:0,qPerMin:0,avgTokens:0,openCount:0,leadCount:0,compoundCount:0,foundationCount:0,impeachCount:0,followupCount:0,openRatio:0,leadRatio:0,compoundRate:0},
    effWords: (transcript.trim().match(/\S+/g)||[]).length,
    audio,
    range: finalRange,
    midband_justification: Array.isArray(scoreData.midband_justification) ? scoreData.midband_justification.map(j => typeof j === 'string' ? j.trim() : String(j || '')).filter(Boolean) : [],
    decimals_used: typeof scoreData.decimals_used === 'string' ? scoreData.decimals_used.trim() : '',
    midbandMeta: scoreData.midbandMeta || null,
    audit: scoreData.audit || null,
    raw: scoreData.raw || ''
  };

  result.scoreLow = Number.isFinite(resolvedLow) ? Number(resolvedLow.toFixed(1)) : finalTotal;
  result.scoreHigh = Number.isFinite(resolvedHigh) ? Number(resolvedHigh.toFixed(1)) : finalTotal;
  result.total = finalTotal;
  const ratingFromData = typeof scoreData.rating === 'string' && scoreData.rating.trim() ? scoreData.rating.trim() : null;
  result.rating = ratingFromData || scoreToRating(result.total);

  renderReport(usedType, result);
  const provenanceMessages=['ChatGPT provided this rubric score.'];
  const statusEl=$('videoStatus');
  if(statusEl){
    statusEl.textContent='Scored by ChatGPT.';
    statusEl.style.color='#9aa4b2';
  }
  const justifications=Array.isArray(result.midband_justification)?result.midband_justification:[];
  if(result.total >= 75 && result.total <= 80){
    const count = justifications.length;
    if(count > 0){
      provenanceMessages.push(`Score landed in the 75–80 band with ${count} checklist observation${count===1?'':'s'}.`);
    } else {
      provenanceMessages.push('Score landed in the 75–80 band.');
    }
  }
  showProvenance(provenanceMessages.join('<br>'), false);
  const summaryText = summarizeVideoResult(usedType, result);
  prepareVideoFollowup({transcript, type: usedType, summaryText, rawText: scoreData.raw || ''});
}).catch(err => {
  // Surface precise error info
  let msg = 'ChatGPT scoring unavailable \u2014 scoring skipped.';
  let provenanceMsg = 'Scoring unavailable due to a ChatGPT error (fallback disabled).';
  let fallbackReason = 'ChatGPT error prevented scoring';
  if (err?.code === 'score_validation_failed') {
    msg = 'ChatGPT returned incomplete scoring data. Please Re-score after a moment.';
    provenanceMsg = 'ChatGPT scoring failed validation (fallback disabled).';
    fallbackReason = 'ChatGPT returned incomplete scoring data';
  } else if (err?.status === 401) msg = 'OpenAI API key invalid/expired (401). Update your key in \u201cAPI Key / Engine\u201d.';
  else if (err?.status === 429 || err?.code === 'rate_limit') msg = 'Rate limit on your OpenAI account (429). Try again or switch model.';
  else if (err?.status === 403) msg = 'OpenAI request forbidden (403). Check org/project access for this key.';
  else if (err?.code === 'insufficient_quota') msg = 'OpenAI quota exhausted. Add billing or change organization.';
  else if ((err?.message || '').toLowerCase().includes('network'))
    msg = 'Network error reaching OpenAI. Check ad blockers / CORS / HTTPS.';
  else if (err?.message) msg = `OpenAI error: ${err.message}`;

  const issueText = Array.isArray(err?.issues) && err.issues.length ? err.issues.join(' | ') : '';
  const rawDetail = err?.raw ? (typeof err.raw === 'string' ? err.raw.slice(0, 300) : JSON.stringify(err.raw).slice(0, 300)) : '';
  const detailParts = [];
  if(issueText) detailParts.push(issueText);
  if(rawDetail) detailParts.push(rawDetail);
  const detail = detailParts.join(' ');

  $('videoStatus').innerHTML = `<strong>${escHTML(msg)}</strong>${detail ? `<div class="small">${escHTML(detail)}</div>` : ''}`;
  $('videoStatus').style.color = '#ef9a9a';

  // Do NOT flip engine mode; just show that scoring is unavailable for this run
  const reasonDetail = issueText ? `${fallbackReason} (${issueText})` : fallbackReason;
  scoreWithBuiltin(type, raw, audio, reasonDetail);
  showProvenance(provenanceMsg, true);

  const badge = $('modeBadge');
  if (badge && /ChatGPT/i.test(badge.textContent)) {
    badge.textContent = err?.code === 'score_validation_failed'
      ? 'Mode: ChatGPT (validation failed)'
      : 'Mode: ChatGPT (scoring unavailable)';
  }
}).finally(()=>{ _scoreLock = false; });
      return;
    }
    scoreWithBuiltin(type, raw, audio, 'ChatGPT scoring not configured');
    showProvenance('Scoring unavailable until ChatGPT scoring is configured.', true);
    _scoreLock = false;
  }

  async function testChatGPT(){
    if (!(EngineState.mode==='chatgpt' && EngineState.openaiKey)) {
      alert('ChatGPT mode not enabled or API key missing. Click \u201cAPI Key / Engine\u201d.');
      return;
    }
    showProvenance('Testing ChatGPT\u2026');
    const model = EngineState.openaiModel || 'gpt-4o';
    try {
      const txt = await callOpenAIChat({
        messages: [
          { role: 'system', content: 'Return exactly {"ok":true} as plain text.' },
          { role: 'user', content: 'Give me {"ok":true} only.' }
        ],
        model,
        maxTokens: 20,
        json: false
      });
      let ok = false; try { ok = JSON.parse(txt)?.ok === true; } catch (_){ }
      showProvenance(ok ? 'ChatGPT reachable \u2705' : `ChatGPT responded but not as expected: ${txt.slice(0,120)}`, !ok);
    } catch (e) {
      const detail = e?.raw ? (typeof e.raw === 'string' ? e.raw.slice(0, 200) : JSON.stringify(e.raw).slice(0, 200)) : '';
      showProvenance(`ChatGPT test failed: ${e?.message || 'error'} ${detail ? `| ${detail}` : ''}`, true);
    }
  }

  async function callOpenAIResponse({ model, input, maxOutputTokens = 600, temperature = 0.2, signal }) {
    if (!EngineState.openaiKey || !/^sk-[A-Za-z0-9_-]{10,}/.test(EngineState.openaiKey)) {
      const err = new Error('Missing or malformed OpenAI API key.');
      err.type = 'config';
      throw err;
    }
    const body = {
      model,
      input,
      temperature,
      max_output_tokens: Math.max(50, Math.min(4096, Number(maxOutputTokens) || 600))
    };
    const bodyJSON = JSON.stringify(body);
    const fetchOpts = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${EngineState.openaiKey}`
      },
      body: bodyJSON,
      signal,
      cache: 'no-store'
    };
    // Chrome limits keepalive requests to ~64 KB. Large video payloads triggered a
    // "TypeError: Load failed" network error when keepalive was always enabled,
    // preventing movement analysis from reaching the OpenAI Responses endpoint.
    // Only enable keepalive for small payloads so video uploads succeed.
    if (bodyJSON.length < 60000) {
      fetchOpts.keepalive = true;
    }
    let resp;
    try {
      resp = await fetch('https://api.openai.com/v1/responses', fetchOpts);
    } catch (networkErr) {
      const err = new Error(networkErr?.message || 'Network error calling OpenAI.');
      err.type = 'network';
      throw err;
    }
    const rawText = await resp.text();
    let data = null;
    try { data = JSON.parse(rawText); } catch (parseErr) {}
    if (!resp.ok) {
      const e = new Error(
        data?.error?.message ||
        `OpenAI HTTP ${resp.status}${rawText ? ` — ${rawText.slice(0, 160)}` : ''}`
      );
      e.status = resp.status;
      e.code = data?.error?.code;
      e.type = data?.error?.type;
      e.raw = data || rawText;
      throw e;
    }
    const segments = [];
    const pushContent = (value) => {
      if (!value) return;
      if (Array.isArray(value)) { value.forEach(pushContent); return; }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (trimmed) segments.push(trimmed);
        return;
      }
      if (typeof value !== 'object') return;
      if (typeof value.text === 'string') {
        const trimmed = value.text.trim();
        if (trimmed) segments.push(trimmed);
      }
      if (typeof value.output_text === 'string') {
        const trimmed = value.output_text.trim();
        if (trimmed) segments.push(trimmed);
      }
      if (Array.isArray(value.content)) {
        value.content.forEach(pushContent);
      }
      if (Array.isArray(value.messages)) {
        value.messages.forEach(pushContent);
      }
      if (Array.isArray(value.output)) {
        value.output.forEach(pushContent);
      }
    };
    pushContent(data?.output);
    pushContent(data?.content);
    pushContent(data?.output_text);
    pushContent(data?.result);
    const joined = segments.join('\n').trim();
    return joined || rawText.trim();
  }

  async function analyzeMovement(){
    if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
      alert('Enable ChatGPT mode and add your OpenAI API key first.');
      return;
    }
    const transcript = $('videoTranscript').value.trim();
    if(!transcript){
      alert('Transcript required for movement analysis.');
      return;
    }
    setStatus('Analyzing movement with ChatGPT…');
    try{
      const model = EngineState.openaiModel || 'gpt-4o';
      const prompt = 'You are a mock trial performance coach. Read the transcript carefully and infer where purposeful movement, gestures, or positioning will reinforce the spoken content. Provide a concise bullet list of improvements. Keep guidance professional, lawful, and competition-safe. Tie each suggestion to specific transcript cues (quoted phrases, sentence numbers, or structural signals like lists) and explain how, where, and when to move or gesture differently. When the transcript enumerates points, recommend gestures that visibly count or differentiate each item (e.g., holding up fingers or shifting position). Include precise guidance on where to stand or move relative to courtroom landmarks (judge, jury, witness stand, counsel tables, podium).';

      const text = await callOpenAIResponse({
        model,
        temperature:0.25,
        maxOutputTokens:600,
        input:[
          {
            role:'user',
            content:[
              {type:'input_text', text: prompt},
              {type:'input_text', text: 'Transcript (use this to infer movement—no video available):\n' + transcript}
            ]
          }
        ]
      });

      const cleaned=text||'No feedback returned.';
      const note = ' (transcript-based guidance)';
      $('movementFeedback').innerHTML = `<div><strong>Movement Feedback${note}</strong></div><div>${escHTML(cleaned).replace(/\n/g,'<br>')}</div>`;
      if(cleaned==='No feedback returned.'){
        setStatus('ChatGPT returned no movement feedback.', true);
      }else{
        setStatus('Movement analyzed by ChatGPT (transcript-based).');
      }
    }catch(e){
      console.error(e);
      const message = e?.message || 'error';
      setStatus('ChatGPT movement analysis failed: '+message, true);
    }
  }

  function updateWriteStatus(message, isError = false){
    const status = $('gptWriteStatus');
    if(!status) return;
    status.textContent = message || '';
    status.style.color = isError ? '#ef4444' : 'inherit';
    if(!status.hasAttribute('aria-live')){
      status.setAttribute('aria-live','polite');
    }
  }

  function enableWriteFollowup(enabled){
    const follow = $('gptWriteFollowup');
    if(!follow) return;
    follow.disabled = !enabled;
    follow.setAttribute('aria-disabled', (!enabled).toString());
    follow.classList.toggle('disabled', !enabled);
  }

  async function gptWrite(){
    if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
      alert('ChatGPT mode not enabled or API key missing. Click “API Key / Engine”.');
      return;
    }
    const type=$('writeType').value;
    const notes=$('gptWriteInput').value.trim();
    const goal=$('gptWriteGoal').value.trim();
    const out=$('gptWriteOutput');
    const follow=$('gptWriteFollowup');
    const maxTokens=Math.max(200,Math.min(2000,Number(EngineState.openaiMaxTokens)||600));

    writeContext={type,notes,goal};
    writeChat=[
      {role:'system',content:'You are an expert high school mock trial coach. Help students draft and refine persuasive materials. Keep feedback specific, encouraging, and grounded in competition norms.'}
    ];
    const intro=[
      `I am working on a ${type}.`,
      `Notes or draft material:\n${notes || '(none provided)'}`,
      `Goal:\n${goal || '(none provided)'}`,
      'Please write a polished ${type} for me. After you share it, be ready for follow-up questions or revision requests.'
    ].join('\n\n');
    writeChat.push({role:'user',content:intro});
    writeFollowupCount=0;
    writeFollowupSending=false;

    if(out) out.value='(ChatGPT thinking...)';
    updateWriteStatus('Requesting draft from ChatGPT…');
    enableWriteFollowup(false);

    try{
      const model=EngineState.openaiModel||'gpt-4o';
      const raw=await callOpenAIChat({messages:writeChat,model,maxTokens,json:false});
      const text=(raw||'').trim();
      if(!text){
        if(out) out.value='';
        updateWriteStatus('ChatGPT returned an empty draft.',true);
        writeChat=[];
        writeContext=null;
        return;
      }
      writeChat.push({role:'assistant',content:text});
      if(out) out.value=text;
      updateWriteStatus('Draft ready. Use the follow-up box to clarify or request edits.');
      enableWriteFollowup(true);
      if(follow) follow.focus();
    }catch(e){
      console.error('[GPT Write]',e);
      if(out) out.value='ChatGPT error.';
      updateWriteStatus(`Draft request failed: ${e?.message||'error'}`,true);
      writeChat=[];
      writeContext=null;
      enableWriteFollowup(false);
    }
  }

  async function gptWriteFollowup(){
    if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
      alert('ChatGPT mode not enabled or API key missing. Click “API Key / Engine”.');
      return;
    }
    if(!writeChat.length||!writeContext){
      alert('Ask ChatGPT to draft something first.');
      return;
    }
    const follow=$('gptWriteFollowup');
    if(!follow) return;
    const question=follow.value.trim();
    if(writeFollowupSending) return;
    if(!question){
      updateWriteStatus('Type a follow-up question before sending.', true);
      return;
    }
    const maxTokens=Math.max(200,Math.min(2000,Number(EngineState.openaiMaxTokens)||600));

    writeFollowupSending=true;
    enableWriteFollowup(false);
    updateWriteStatus('Sending follow-up…');

    const followPrompt=[
      `Follow-up question about the ${writeContext.type} draft you provided earlier.`,
      `Original notes:\n${writeContext.notes || '(none provided)'}`,
      `Original goal:\n${writeContext.goal || '(none provided)'}`,
      `Follow-up request:\n${question}`,
      'If you revise the draft, explain the changes or share the updated wording clearly.'
    ].join('\n\n');
    writeChat.push({role:'user',content:followPrompt});
    const userIndex=writeChat.length-1;

    try{
      const model=EngineState.openaiModel||'gpt-4o';
      const raw=await callOpenAIChat({messages:writeChat,model,maxTokens,json:false});
      const text=(raw||'').trim();
      if(!text){
        writeChat.splice(userIndex,1);
        updateWriteStatus('ChatGPT returned an empty reply.',true);
      }else{
        writeChat.push({role:'assistant',content:text});
        writeFollowupCount+=1;
        const out=$('gptWriteOutput');
        const label=`Follow-up ${writeFollowupCount} response:`;
        if(out){
          const existing=out.value.trim();
          out.value=existing?`${existing}\n\n---\n${label}\n${text}`:`${label}\n${text}`;
        }
        updateWriteStatus('Follow-up answered.');
      }
    }catch(e){
      console.error('[GPT Write Follow-up]',e);
      writeChat.splice(userIndex,1);
      updateWriteStatus(`Follow-up failed: ${e?.message||'error'}`,true);
    }finally{
      writeFollowupSending=false;
      enableWriteFollowup(true);
      follow.value='';
      follow.focus();
    }
  }

  function resetVideoFollowup(){
    videoJudgeContext=null;
    videoFollowupChat=[];
    videoFollowupSending=false;
    const wrap=$('videoFollowupWrap');
    const input=$('videoFollowup');
    const status=$('videoFollowupStatus');
    const replies=$('videoFollowupReplies');
    if(wrap) wrap.style.display='none';
    if(input){ input.value=''; input.disabled=true; }
    if(status){ status.textContent=''; status.style.color='inherit'; }
    if(replies) replies.textContent='';
  }

  function updateVideoFollowupStatus(msg,isError=false){
    const el=$('videoFollowupStatus');
    if(!el) return;
    el.textContent=msg||'';
    el.style.color=isError?'#ef4444':'inherit';
  }

  function appendVideoFollowup(role,text){
    const box=$('videoFollowupReplies');
    if(!box) return;
    const who=role==='user'?'You':'Judge';
    const snippet=`${who}: ${text}`;
    box.textContent=box.textContent?`${box.textContent}\n\n${snippet}`:snippet;
  }

  function summarizeVideoResult(type,result){
    const conf=RUBRICS[type]||{name:type,cats:[]};
    const ratingText=result.rating || scoreToRating(result.total);
    const lines=[`${conf.name} evaluation:`, `Final Rating: ${ratingText}`, `Total Score: ${result.total}`];
    (conf.cats||[]).forEach(c=>{
      const val=result.cats?.[c.key];
      const comment=result.comments?.[c.key];
      let line=`${c.n||c.key}: ${val??'N/A'}`;
      if(comment) line+=` — Comment: ${comment}`;
      lines.push(line);
    });
    if(result.explanation) lines.push(`Explanation: ${result.explanation}`);
    if(result.notes) lines.push(`Notes: ${result.notes}`);
    if(result.qa && result.qa.length){
      lines.push('Question/Answer Highlights:');
      result.qa.slice(0,3).forEach((qa,i)=>{
        lines.push(`Q${i+1}: ${qa.q||''} | ${qa.qScore??''} - ${qa.qReason||''}`);
        lines.push(`A${i+1}: ${qa.a||''} | ${qa.aScore??''} - ${qa.aReason||''}`);
      });
    }
    if(result.audio){
      const a=result.audio;
      const voice=[];
      if(a.volRating) voice.push(`Volume ${a.volRating}${Number.isFinite(a.avgVolume)?` (${a.avgVolume} dB)`:''}`);
      if(a.toneRating) voice.push(`Tone ${a.toneRating}${Number.isFinite(a.pitchVar)?` (${a.pitchVar} Hz)`:''}`);
      if(a.clarityRating) voice.push(`Clarity ${a.clarityRating}`);
      if(a.speedRating) voice.push(`Speed ${a.speedRating}${Number.isFinite(a.wpm)?` (${a.wpm} WPM)`:''}`);
      if(voice.length) lines.push(`Voice Metrics: ${voice.join('; ')}`);
      if(a.tips) lines.push(`Voice Tips: ${a.tips}`);
    }
    return lines.join('\n');
  }

  function prepareVideoFollowup(context){
    videoJudgeContext=context;
    videoFollowupChat=[
      {role:'system',content:'You are the same mock trial judge who just evaluated the competitor. Provide clarifications referencing your prior scoring and the transcript. Only adjust the score if explicitly requested.'}
    ];
    if(context.summaryText){
      videoFollowupChat.push({role:'assistant',content:context.summaryText});
    }
    if(context.rawText && context.rawText!==context.summaryText){
      videoFollowupChat.push({role:'assistant',content:context.rawText});
    }
    const wrap=$('videoFollowupWrap');
    const input=$('videoFollowup');
    const replies=$('videoFollowupReplies');
    const ready=EngineState.mode==='chatgpt' && !!EngineState.openaiKey;
    if(wrap) wrap.style.display='flex';
    if(replies) replies.textContent='';
    if(input){
      input.value='';
      input.disabled=!ready;
      if(ready) input.focus();
    }
    updateVideoFollowupStatus(ready?
      'Follow-up ready. Ask the judge for clarification or coaching tips.' :
      'Enter a ChatGPT API key and enable ChatGPT mode to send follow-up questions.',
      !ready
    );
  }

  async function sendVideoFollowup(){
    if(!(EngineState.mode==='chatgpt' && EngineState.openaiKey)){
      alert('ChatGPT mode not enabled or API key missing. Click “API Key / Engine”.');
      return;
    }
    if(!videoJudgeContext || !videoFollowupChat.length){
      updateVideoFollowupStatus('Run ChatGPT scoring before sending a follow-up.', true);
      return;
    }
    const input=$('videoFollowup');
    if(!input) return;
    const question=input.value.trim();
    if(videoFollowupSending) return;
    if(!question){
      updateVideoFollowupStatus('Type a follow-up question before sending.', true);
      return;
    }
    const maxTokens=Math.max(200,Math.min(2000,Number(EngineState.openaiMaxTokens)||600));

    videoFollowupSending=true;
    input.disabled=true;
    appendVideoFollowup('user',question);

    const contextParts=[];
    if(videoJudgeContext.summaryText){
      contextParts.push(`Your previous evaluation (structured summary):\n${videoJudgeContext.summaryText}`);
    }
    if(videoJudgeContext.rawText){
      contextParts.push(`Your original evaluation text:\n${videoJudgeContext.rawText}`);
    }
    contextParts.push(`Transcript (${videoJudgeContext.type}):\n${videoJudgeContext.transcript}`);
    contextParts.push(`Competitor follow-up question:\n${question}`);
    contextParts.push('Respond as the same judge. Clarify rubric feedback, share actionable improvements, and adjust the score only if explicitly asked.');
    videoFollowupChat.push({role:'user',content:contextParts.join('\n\n')});
    const userIndex=videoFollowupChat.length-1;
    updateVideoFollowupStatus('Sending follow-up…');

    try{
      const model=EngineState.openaiModel||'gpt-4o';
      const raw=await callOpenAIChat({messages:videoFollowupChat,model,maxTokens,json:false});
      const text=(raw||'').trim();
      if(!text){
        videoFollowupChat.splice(userIndex,1);
        updateVideoFollowupStatus('Judge returned an empty reply.',true);
      }else{
        videoFollowupChat.push({role:'assistant',content:text});
        appendVideoFollowup('judge',text);
        updateVideoFollowupStatus('Judge replied.');
      }
    }catch(e){
      console.error('[Video Follow-up]',e);
      videoFollowupChat.splice(userIndex,1);
      updateVideoFollowupStatus(`Follow-up failed: ${e?.message||'error'}`,true);
    }finally{
      videoFollowupSending=false;
      input.disabled=false;
      input.value='';
      input.focus();
    }
  }

  function updateWriteExemplar(){
    const type=$('writeType').value;
    const guide=EXEMPLARS[type]?.guide;
    const div=$('writeExemplar');
    if(div) div.textContent=guide||'';
  }

  function wire(){
    $('btnVideoStart').addEventListener('click',startCamera);
    $('btnFlipCamera')?.addEventListener('click',flipCamera);
    $('btnStopRecording').addEventListener('click',stop);
    $('btnScoreVideo').addEventListener('click', ()=>scoreNow());
    $('btnAnalyzeMovement')?.addEventListener('click', analyzeMovement);
    $('btnShowVoice')?.addEventListener('click',()=>{
      const v=$('voiceFeedback');
      if(!v) return;
      const show=v.style.display==='none';
      v.style.display=show?'block':'none';
      $('btnShowVoice').textContent=show?'Hide Voice':'Show Voice';
    });
    $('btnStopRecording').disabled=true;
    $('btnChangeEngine').addEventListener('click', openVideoGate);
    $('btnTestChatGPT').addEventListener('click', testChatGPT);
    $('btnGPTWrite').addEventListener('click', gptWrite);
    $('btnWriteChangeEngine')?.addEventListener('click', openVideoGate);
    $('writeType').addEventListener('change', updateWriteExemplar);
    attachFollowupSender('gptWriteFollowup', gptWriteFollowup);
    enableWriteFollowup(false);
    updateWriteStatus('');
    attachFollowupSender('videoFollowup', sendVideoFollowup);
    resetVideoFollowup();
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ $('btnFlipCamera')?.setAttribute('disabled','true'); }
    updateWriteExemplar();
    renderModeBadge();
    tUpd();
    updateRecordingIndicator(false);
    setStatus('Tip: some browsers block camera in embedded previews.');
  }

  return{wire}
})();

/* ================= AZ Rules (expanded summaries) ================= */
const AZ_RULES=[
 {article:'Article I \u2014 General',rules:[
 {id:'101',title:'Scope',text:'Rules govern mock trial proceedings (AZ conversion).'},
 {id:'102',title:'Purpose',text:'Fairness, efficiency, ascertain truth.'},
  {id:'103',title:'Rulings on Evidence',subs:['Timely object or offer proof to preserve issue.','Court may take notice of plain error.']},
  {id:'104',title:'Preliminary Questions',subs:['Court decides admissibility and witness qualification.','Conditional relevance requires supporting evidence.']},
  {id:'105',title:'Limiting Evidence',subs:['Court restricts to proper scope; instructs jury.']},
  {id:'106',title:'Rule of Completeness',subs:['Adverse party may require related parts at same time.']}
]},
{article:'Article II \u2014 Judicial Notice',rules:[
  {id:'201',title:'Adjudicative Facts',subs:['Facts not subject to reasonable dispute; civil jury must accept; criminal jury may or may not.']}
]},
 {article:'Article III \u2014 Presumptions in Civil Cases',rules:[
  {id:'301',title:'Presumptions in Civil Cases Generally',text:'Burden shifts to party against whom presumption is directed.'},
  {id:'302',title:'Applying State Law',text:'State law governs presumptions for state-law claims.'}
 ]},
{article:'Article IV \u2014 Relevancy',rules:[
  {id:'401',title:'Relevance Test',text:'Any tendency to make consequential fact more/less probable.'},
  {id:'402',title:'Admissibility',text:'Relevant admissible unless excluded; irrelevant inadmissible.'},
  {id:'403',title:'Excluding Relevant',subs:['Exclude if probative value substantially outweighed by prejudice/confusion/waste/cumulative.']},
  {id:'404',title:'Character',subs:['(a)(1) No propensity.','(a)(2) Criminal exceptions (defendant/victim traits; homicide peacefulness).','(a)(3) Witness character (607\u2013609).','(b)(1) Other-acts not for propensity.','(b)(2) Permitted uses: motive, intent, plan, knowledge, identity, etc.']},
  {id:'405',title:'Proving Character',subs:['(a) Reputation/opinion; on cross specific instances.','(b) Specific instances if character is essential element.']},
  {id:'406',title:'Habit',text:'Habit/routine to show conduct; corroboration not required.'},
  {id:'407',title:'Subsequent Remedial Measures',text:'Not to prove negligence/defect; allowed for ownership/control/feasibility/impeachment.'},
  {id:'408',title:'Compromise Offers',subs:['(a) Not to prove claim/amount.','(b) Other purposes: bias, negating undue delay, obstruction.']},
  {id:'409',title:'Medical Payments',text:'Not to prove liability.'},
  {id:'410',title:'Pleas & Discussions',subs:['(a) Withdrawn plea/nolo/statements inadmissible against defendant.','(b) Exceptions: completeness; perjury/false statement under oath.']},
  {id:'411',title:'Liability Insurance',text:'Not to prove negligence; may show bias/agency/ownership/control.'},
  {id:'412',title:'Sex-Offense Cases: Victim\'s Sexual Behavior',subs:['(a) Propensity evidence prohibited.','(b) Limited exceptions.','(c) Procedure: written motion and in camera hearing.']},
  {id:'413',title:'Similar Crimes in Sexual-Assault Cases',text:'In criminal sexual-assault cases, prior assaults may be admitted.'},
  {id:'414',title:'Similar Crimes in Child-Molestation Cases',text:'Allows evidence of prior child molestation in criminal cases.'},
  {id:'415',title:'Similar Acts in Civil Cases of Sexual Assault or Child Molestation',text:'Permits prior similar acts in civil sexual-assault or child-molestation cases.'}
]},
 {article:'Article V \u2014 Privileges',rules:[
  {id:'501',title:'General Rule',subs:['Spousal, attorney\u2013client, medical/mental-health.']},
  {id:'502',title:'Attorney\u2013Client Privilege',text:'Protects confidential communications between lawyer and client.'},
  {id:'503',title:'Psychotherapist\u2013Patient Privilege',text:'Confidential mental health communications protected.'},
  {id:'504',title:'Clergy\u2013Penitent Privilege',text:'Confidential spiritual communications protected.'},
  {id:'505',title:'Spousal Privilege',text:'Spouse may refuse to testify to confidential marital communications.'},
  {id:'506',title:'Identity of Informer',text:'Government may withhold informer identity under limited conditions.'}
 ]},
{article:'Article VI \u2014 Witnesses',rules:[
  {id:'601',title:'Competency',text:'Everyone competent.'},
  {id:'602',title:'Personal Knowledge',text:'Testimony needs support for PK (not experts under 703).'},
  {id:'607',title:'Who May Impeach',text:'Any party may attack credibility.'},
  {id:'608',title:'Truthfulness Character',subs:['(a) Reputation/opinion for truthfulness.','(b) Specific instances on cross if probative.']},
  {id:'609',title:'Convictions',subs:['(a)(1)(A) Felony (non-defendant) \u2014 Rule 403.','(a)(1)(B) Defendant \u2014 probative value outweighs prejudice.','(a)(2) Crimes of dishonesty \u2014 must be admitted.']},
  {id:'610',title:'Religious Beliefs',text:'Not to attack/support credibility.'},
  {id:'611',title:'Mode & Order',subs:['(a) Court controls exam.','(b) Cross can cover any relevant matter and credibility.','(c) Leading allowed on cross/hostile; not on direct.','(d) Redirect and recross allowed at judge\'s discretion.']},
  {id:'612',title:'Refresh Memory',text:'Adverse party may inspect/cross/introduce relevant portions.'},
  {id:'613',title:'Prior Statement',text:'Show to counsel on request; extrinsic evidence subject to conditions.'},
  {id:'614',title:'Court\'s Witnesses',text:'Court may call or examine witnesses.'},
  {id:'615',title:'Sequestering Witnesses',text:'Court may exclude witnesses to prevent hearing others\' testimony.'}
]},
{article:'Article VII \u2014 Opinions/Experts',rules:[
  {id:'701',title:'Lay Opinion',subs:['(a) Rational perception.','(b) Helpful.','(c) Not specialized (that is 702).']},
  {id:'702',title:'Experts',subs:['(a) Helps trier of fact.','(b) Sufficient facts/data.']},
  {id:'703',title:'Expert Bases',text:'May rely on reasonably relied-upon facts; disclosure if probative value outweighs prejudice.'},
  {id:'704',title:'Ultimate Issue',subs:['(a) Not automatically objectionable.','(b) Criminal: no opinion on defendant\u2019s mental state element.']},
  {id:'705',title:'Facts/Data',text:'Expert may state opinion first; disclose on cross.'},
  {id:'706',title:'Court-Appointed Expert',text:'Court may appoint expert; parties may cross-examine.'}
]},
{article:'Article VIII \u2014 Hearsay',rules:[
  {id:'801',title:'Definitions',subs:['(a) Statement','(b) Declarant','(c) Hearsay','(d) Not Hearsay: certain prior statements; opposing-party statements (admissions, adoptive, authorized, agent/employee, co-conspirator).']},
  {id:'802',title:'Hearsay Rule',text:'Hearsay inadmissible unless exception.'},
  {id:'803',title:'Exceptions (availability immaterial)',subs:['(1) Present Sense Impression.','(2) Excited Utterance.','(3) Then-Existing Mental/Emotional/Physical Condition.','(4) For Medical Diagnosis/Treatment.','(5) Recorded Recollection.','(6) Business Records.','(7) Absence of Business Record.','(8) Public Records.','(10) Absence of Public Record.','(16) Ancient Documents.','(18) Learned Treatises (read into evidence).','(21) Reputation Concerning Character.','(22) Judgment of Prior Conviction.']},
  {id:'804',title:'Exceptions (declarant unavailable)',subs:['(a) Unavailability: privilege/refusal/no memory/death or illness/absence not procured by proponent.','(b)(1) Former Testimony.','(b)(2) Dying Declaration (homicide/civil).','(b)(3) Statement Against Interest (with corroboration in criminal).','(b)(4) Personal/Family History.','(b)(6) Statement Against Party That Wrongfully Caused Unavailability.']},
  {id:'805',title:'Hearsay within Hearsay',text:'Each layer must fit an exception.'},
  {id:'806',title:'Declarant\u2019s Credibility',text:'May attack/support as if testifying.'},
  {id:'807',title:'Residual Exception',text:'Trustworthy, more probative than alternatives.'}
 ]},
 {article:'Article IX \u2014 Authentication and Identification',rules:[
  {id:'901',title:'Authentication Required',subs:['(a) Proponent must produce evidence to support authenticity.','(b) Examples: witness with knowledge, handwriting, distinctive characteristics, voice, phone conversations, public records, ancient documents, process/system, statutory methods.']},
  {id:'902',title:'Self-Authenticating',subs:['(1) Domestic public documents under seal.','(2) Domestic public documents not under seal but certified.','(3) Foreign public documents.','(4) Certified copies of public records.','(5) Official publications.','(6) Newspapers and periodicals.','(7) Trade inscriptions.','(8) Acknowledged documents.','(9) Commercial paper.','(10) Presumptions under Act of Congress.','(11) Certified domestic records of regularly conducted activity.','(12) Certified foreign records of regularly conducted activity.']},
  {id:'903',title:'Subscribing Witness',text:'Testimony of subscribing witness unnecessary unless statute requires.'}
 ]},
 {article:'Article X \u2014 Contents of Writings, Recordings, and Photographs',rules:[
  {id:'1001',title:'Definitions',text:'Defines writings, recordings, photographs, originals, and duplicates.'},
  {id:'1002',title:'Requirement of the Original',text:'Original required to prove content unless otherwise allowed.'},
  {id:'1003',title:'Admissibility of Duplicates',text:'Duplicate admissible unless genuine question or unfairness.'},
  {id:'1004',title:'Other Evidence of Content',subs:['Original lost or destroyed.','Original not obtainable.','Original in opponent\'s control.','Collateral matters.']},
  {id:'1005',title:'Copies of Public Records',text:'Certified copies may prove content of public records.'},
  {id:'1006',title:'Summaries to Prove Content',text:'Summaries admissible when originals voluminous and available.'},
  {id:'1007',title:'Testimony or Statement of a Party',text:'Party testimony can prove content without original.'},
  {id:'1008',title:'Functions of Court and Jury',text:'Court decides admissibility; jury decides questions about originals.'}
 ]},
 {article:'Article XI \u2014 Miscellaneous',rules:[
  {id:'1101',title:'Applicability',text:'Rules apply to courts unless exceptions for preliminary questions, grand jury, etc.'},
  {id:'1102',title:'Title',text:'These rules may be cited as the Rules of Evidence.'},
  {id:'1103',title:'Rule Revocation',text:'Existing privileges or statutes are not repealed by these rules.'}
 ]}
];

/* Additional state rules (simplified) */
const CA_RULES=[
 {article:'Article I \u2014 General',rules:[
  {id:'101',title:'Scope',text:'Rules govern California mock trial proceedings.'},
  {id:'102',title:'Purpose',text:'Fairness, efficiency, ascertain truth.'}
 ]}
];

/* State configuration */
const STATES={
  AZ:{name:'Arizona',abbr:'AZ',rules:AZ_RULES,judgePrompt:'You are an impartial Arizona High School Mock Trial judge. Speak formally, cite relevant rules, and state any assumptions. Make your ruling precise and accurate.',rubricMap:makeRubricMap('Arizona','AZ')},
  CA:{name:'California',abbr:'CA',rules:CA_RULES,judgePrompt:'You are an impartial California High School Mock Trial judge. Speak formally, cite relevant rules, and state any assumptions. Make your ruling precise and accurate.',rubricMap:makeRubricMap('California','CA')}
};

/* Rules Explorer (full) */
const RulesExplorer=(function(){
  function item(r){
    // `rule-full` and `meaning-text` are populated on demand when the title is
    // clicked so that the exact rule text is shown word for word. This avoids
    // embedding large rule content in the initial HTML while still allowing
    // instant display when requested.
    const usage=r.subs?`<ul>${r.subs.map(s=>`<li>${escHTML(s)}</li>`).join('')}</ul>`:(r.text?`<div>${escHTML(r.text)}</div>`:'');
    return `<div class="rule-item"><div class="rule-title" data-id="${r.id}">Rule ${r.id}: ${escHTML(r.title)}</div><div class="rule-body" style="display:none"><div class="rule-full"></div><button class="btn secondary meaning-toggle" style="margin:6px 0">What it means and how to use it</button><div class="rule-meaning" style="display:none"><div class="meaning-text"></div>${usage}</div></div></div>`;
  }
  function render(){
    const q=($('rulesSearch').value||'').toLowerCase();
    const out=[];
    for(const g of STATES[CURRENT_STATE].rules){
      const list=g.rules.filter(r=>{
        const hay=`${r.id} ${r.title} ${(r.text||'')} ${(r.subs||[]).join(' ')}`.toLowerCase();
        return !q||hay.includes(q)
      });
      if(q&&list.length===0) continue;
      out.push(`<div class="small" style="margin-top:6px"><span class="badge">${g.article}</span></div>`);
      out.push(list.length?list.map(item).join(''):'<div class="small">(No specific rules in this article)</div>');
    }
    $('rulesList').innerHTML=out.join('');
    document.querySelectorAll('.rule-title').forEach(t=>{
      t.addEventListener('click',()=>{
        const b=t.nextElementSibling;
        // Populate the rule text and plain-language meaning only once.
        const id=t.dataset.id;
        const fullEl=b.querySelector('.rule-full');
        if(!fullEl.dataset.loaded){
          const detail=(globalThis.AZ_RULES_DETAIL && globalThis.AZ_RULES_DETAIL[id])||null;
          fullEl.innerHTML=detail&&detail.full?escHTML(detail.full).replace(/\n/g,'<br>'):'<div class="small">(Full text not available)</div>';
          b.querySelector('.meaning-text').innerHTML=detail&&detail.meaning?escHTML(detail.meaning).replace(/\n/g,'<br>'):'';
          fullEl.dataset.loaded='1';
        }
        b.style.display=b.style.display==='none'?'block':'none';
      });
    });
    document.querySelectorAll('.meaning-toggle').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const m=btn.nextElementSibling; m.style.display=m.style.display==='none'?'block':'none';
      });
    });
  }
  function wire(){
    const s=$('rulesSearch');
    s.addEventListener('input',()=>{render();save('mtpl.rulesSearch',s.value)});
    $('btnClearSearch').addEventListener('click',()=>{s.value='';save('mtpl.rulesSearch','');render()});
    s.value=load('mtpl.rulesSearch','');render();
  }
  return{wire,render}
})();

/* Rules Quiz (full with subsections option) */
const RulesQuiz=(function(){
 let idx=0,score=0,total=0,current=null,mode='mix',difficulty=1,queue=[],section='all';
 let ALL=[],HEAR=[],CHAR=[],WIT=[],ALLS=[],HEARS=[],CHARS=[],WITS=[];
 function sh(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}
 function rn(n){return Math.floor(Math.random()*(n))}
 function pick(a,n){return sh(a).slice(0,n)}
 function uniqOpts(correct, pool, fallback){
   const seen=new Set([correct]);
   const out=[correct];
   function fill(arr){
     for(const opt of sh(arr)){
       if(out.length>=4) break;
       if(!seen.has(opt)){ out.push(opt); seen.add(opt); }
     }
   }
   fill(pool);
   if(out.length<4 && fallback) fill(fallback);
   return sh(out)
 }
 function subsOf(r){
   const out=[];
   (r.subs||[]).forEach(s=>{
     const m=String(s).match(/^\s*((\([^)]*\))+?)\s*(.*)$/);
     if(m){
       const code=`${r.id}${m[1].replace(/\s+/g,'')}`;
       const title=(m[3]||'').replace(/^[\u2013\-:\s]+/,'')||String(s).replace(/^\s*\([^)]*\)\s*/,'');
       out.push({code,title,parentId:r.id,parentTitle:r.title})
     }
   });
   return out
 }
 function refresh(){
   function flat(){const out=[];for(const g of STATES[CURRENT_STATE].rules){for(const r of g.rules){out.push({id:r.id,title:r.title,article:g.article,subs:r.subs||[],text:r.text||''})}}return out}
  ALL=flat();
  HEAR=ALL.filter(r=>+r.id>=801&&+r.id<=807);
  CHAR=ALL.filter(r=>+r.id>=404&&+r.id<=406);
  WIT=ALL.filter(r=>+r.id>=601&&+r.id<=613);
  ALLS=ALL.flatMap(subsOf);
  HEARS=ALLS.filter(x=>+x.parentId>=801&&+x.parentId<=807);
  CHARS=ALLS.filter(x=>+x.parentId>=404&&+x.parentId<=406);
  WITS=ALLS.filter(x=>+x.parentId>=601&&+x.parentId<=613);
}
refresh();

function qBasic(){
  const set=(section==='hearsay')?HEAR:(section==='character')?CHAR:(section==='witness')?WIT:ALL;
  const base=set[rn(set.length)];
  const types=(mode==='mix')?['titleFromNumber','numberFromTitle']:[mode];
  const type=types[rn(types.length)];
  if(type==='titleFromNumber'){
    const wrongPool=set.filter(x=>x.id!==base.id);
    const wrong=(wrongPool.length>=3?wrongPool:ALL.filter(x=>x.id!==base.id));
    const opts=uniqOpts(base.title, wrong.map(x=>x.title), ALL.map(x=>x.title));
    return{type,q:`Rule ${base.id} is titled:`,options:opts,answer:base.title,explain:`Rule ${base.id}: ${base.title}. ${base.text||''}`}
  }
  const wrongPool=set.filter(x=>x.id!==base.id);
  const wrong=(wrongPool.length>=3?wrongPool:ALL.filter(x=>x.id!==base.id));
  const opts=uniqOpts(base.id, wrong.map(x=>x.id), ALL.map(x=>x.id));
  return{type:'numberFromTitle',q:`Which rule number covers \u201c${base.title}\u201d?`,options:opts,answer:base.id,explain:`\u201c${base.title}\u201d is Rule ${base.id}.`}
}

function qSub(){
  const set=(section==='hearsay')?HEARS:(section==='character')?CHARS:(section==='witness')?WITS:ALLS;
  const base=set[rn(set.length)];
  if(rn(2)===0){
    const pool=set.filter(x=>x.parentId===base.parentId&&x.code!==base.code);
    const wrong=(pool.length>=3?pool:set.filter(x=>x.code!==base.code));
    const opts=uniqOpts(base.title, wrong.map(x=>x.title), ALLS.map(x=>x.title));
     return{type:'subTitleFromCode',q:`What does Rule ${base.code} cover?`,options:opts,answer:base.title,explain:`Rule ${base.code}: ${base.title} (under ${base.parentTitle}).`}
   }
   const pool=set.filter(x=>x.parentId===base.parentId&&x.code!==base.code);
   const wrong=(pool.length>=3?pool:set.filter(x=>x.code!==base.code));
   const opts=uniqOpts(base.code, wrong.map(x=>x.code), ALLS.map(x=>x.code));
   return{type:'subCodeFromTitle',q:`Which subsection covers \u201c${base.title}\u201d?`,options:opts,answer:base.code,explain:`\u201c${base.title}\u201d is at Rule ${base.code}.`}
}

function show(){
 $('quizBody').innerHTML=''; $('quizExplain').textContent='';
  mode='mix'; section=$('quizScope')?$('quizScope').value:'all'; difficulty=parseInt(($('quizDifficulty')?.value||'1'),10);
  current=(difficulty===2)?qSub():qBasic();
  const wrap=document.createElement('div');
   const q=document.createElement('div'); q.className='quiz-q'; q.textContent=current.q; wrap.appendChild(q);
   const form=document.createElement('div');
   current.options.forEach(opt=>{
     const b=document.createElement('button'); b.className='quiz-opt'; b.textContent=opt; b.type='button';
     b.addEventListener('click',()=>grade(opt,b)); form.appendChild(b)
   });
   wrap.appendChild(form); $('quizBody').appendChild(wrap)
 }

 function grade(choice,btn){
   if(!current)return; total++;
   if(choice===current.answer){score++;btn.classList.add('quiz-correct')}
   else{btn.classList.add('quiz-wrong')}
   $('quizScore').textContent=String(score); $('quizTotal').textContent=String(total);
   $('quizExplain').innerHTML=`<strong>Explanation:</strong> ${current.explain}`;
   const best=load('mtpl.quizBest',0); if(score>best){save('mtpl.quizBest',score);$('quizBest').textContent=String(score)}
   $('btnNextQ').disabled=false
 }

 function start(){
   score=0;total=0;$('quizScore').textContent='0';$('quizTotal').textContent='0';
   $('quizExplain').textContent='';$('btnNextQ').disabled=true;
   const count=parseInt(($('quizCount')?.value||'5'),10); queue=Array.from({length:count},()=>null); idx=0; show()
 }
 function next(){ if(idx<queue.length-1){ idx++; $('btnNextQ').disabled=true; show() } else { $('quizExplain').innerHTML+='<br><strong>Quiz complete.</strong>' } }
function wire(){ $('btnStartQuiz').addEventListener('click',start); $('btnNextQ').addEventListener('click',next); $('quizBest').textContent=String(load('mtpl.quizBest',0)||0) }
return{wire,refresh}
})();

/* Init + environment warnings */
function envWarnInit(){envWarn();}

function safe(fn){
  try{ fn(); }
  catch(e){ console.error(e); }
}

document.addEventListener('DOMContentLoaded',()=>{
  safe(()=>Objections.wire());
  safe(()=>VideoCoach.wire());
  safe(()=>{ RulesExplorer.wire(); RulesExplorer.render(); });
  safe(()=>{ RulesQuiz.wire(); RulesQuiz.refresh(); });
  safe(()=>{
    envWarnInit();
    renderModeBadge();
    $('rulesTab').textContent=`${STATES[CURRENT_STATE].abbr} Rules`;
    $('rulesHeading').textContent=`${STATES[CURRENT_STATE].abbr} HS Mock Trial Rules of Evidence \u2014 Explorer`;
  });

  const sections=Array.from(document.querySelectorAll('.app > section.card'));
  function showSection(id){
    sections.forEach(sec=>sec.style.display=sec.id===id?'block':'none');
    document.querySelectorAll('#navMenu .tab').forEach(link=>{
      if(link.getAttribute('href')===`#${id}`){link.classList.add('active');}
      else{link.classList.remove('active');}
    });
    location.hash=id;
    const usesMode = id==='objections' || id==='video' || id==='writing';
    const badge=$('modeBadge');
    if(badge){
      badge.style.display = usesMode ? 'inline-block' : 'none';
      if(usesMode) renderModeBadge();
    }
    if(id==='video'){ maybeShowVideoGate(); }
  }

  function initHowTo(initialHash){
    const howto=$('howto');
    if(!howto) return;
    const navLinks=Array.from(howto.querySelectorAll('.anchor-nav a'));
    const chipLinks=Array.from(howto.querySelectorAll('.section-chips a'));
    const observeSections=navLinks
      .map(link=>{
        const href=link.getAttribute('href');
        if(!href || !href.startsWith('#')) return null;
        return howto.querySelector(href);
      })
      .filter(Boolean);

    const activate=id=>{
      navLinks.forEach(link=>{
        const match=link.getAttribute('href')===`#${id}`;
        link.classList.toggle('active',match);
        if(match){link.setAttribute('aria-current','location');}
        else{link.removeAttribute('aria-current');}
      });
      chipLinks.forEach(link=>{
        const match=link.getAttribute('href')===`#${id}`;
        link.classList.toggle('active',match);
      });
    };

    if(observeSections.length){
      activate(observeSections[0].id);
      const observer=new IntersectionObserver(entries=>{
        entries.filter(entry=>entry.isIntersecting).forEach(entry=>activate(entry.target.id));
      },{rootMargin:'-45% 0px -45% 0px',threshold:.1});
      observeSections.forEach(section=>observer.observe(section));
    }

    howto.querySelectorAll('a[href^="#howto-"]').forEach(link=>{
      link.addEventListener('click',evt=>{
        const href=link.getAttribute('href');
        if(!href) return;
        const target=howto.querySelector(href);
        if(target){
          evt.preventDefault();
          target.scrollIntoView({behavior:'smooth',block:'start'});
          activate(target.id);
        }
      });
    });

    howto.querySelectorAll('a[data-section]').forEach(link=>{
      link.addEventListener('click',evt=>{
        const target=link.getAttribute('data-section');
        if(target){
          evt.preventDefault();
          showSection(target);
        }
      });
    });

    if(initialHash && initialHash.startsWith('howto-')){
      const target=howto.querySelector(`#${initialHash}`);
      if(target){
        target.scrollIntoView({behavior:'auto',block:'start'});
        activate(initialHash);
        if(history.replaceState){history.replaceState(null,'',`#${initialHash}`);}
      }
    }
  }

  document.querySelectorAll('#navMenu .tab').forEach(link=>{
    link.addEventListener('click',e=>{
      e.preventDefault();
      showSection(link.getAttribute('href').slice(1));
      const nav=$('navMenu');
      nav.classList.remove('open');
      $('menuToggle').setAttribute('aria-expanded','false');
    });
  });

  const topLevelIds=sections.map(sec=>sec.id);
  const rawHash=location.hash.slice(1);
  const initialHash=topLevelIds.includes(rawHash)?rawHash:'howto';
  showSection(initialHash);
  initHowTo(rawHash);

  document.querySelectorAll('a.hidden-link').forEach(link=>{
    link.addEventListener('click',e=>{
      e.preventDefault();
      showSection(link.getAttribute('href').slice(1));
    });
  });

  $('menuToggle').addEventListener('click',()=>{
    const nav=$('navMenu');
    const isOpen=nav.classList.toggle('open');
    $('menuToggle').setAttribute('aria-expanded',isOpen);
  });
  document.addEventListener('click',e=>{
    const nav=$('navMenu');
    const toggle=$('menuToggle');
    if(nav.classList.contains('open') && !nav.contains(e.target) && !toggle.contains(e.target)){
      nav.classList.remove('open');
      toggle.setAttribute('aria-expanded','false');
    }
  });
});
} // end browser check
</script>

</body>
</html>
