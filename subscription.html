<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Subscription Demo</title>
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>
</head>
<body>
  <h1>Subscription Demo</h1>
  <section id="signup">
    <h2>Sign Up</h2>
    <input id="signupEmail" placeholder="Email">
    <input id="signupPassword" placeholder="Password" type="password">
    <button onclick="signup()">Sign Up</button>
  </section>
  <section id="login">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" placeholder="Password" type="password">
    <button onclick="login()">Login</button>
    <p>Free accounts receive 5 prompts each month.</p>
  </section>
  <section id="prompt" style="display:none;">
    <h2>Send Prompt</h2>
    <textarea id="promptText"></textarea>
    <button onclick="sendPrompt()">Send</button>
    <pre id="promptResponse"></pre>
  </section>
  <section id="geminiPrompt" style="display:none;">
    <h2>Send Gemini Prompt</h2>
    <textarea id="geminiPromptText"></textarea>
    <button onclick="sendGemini()">Send</button>
    <pre id="geminiPromptResponse"></pre>
  </section>
  <section id="subscribe" style="display:none;">
    <h2>Subscribe</h2>
    <stripe-buy-button
      buy-button-id="buy_btn_1S5IkRGjcFtLGwutsPk8XnpU"
      publishable-key="pk_live_51S5Ea6GjcFtLGwutrmUh3W6qKpvIhv0pqpEmnZXyrsIkmSOqszyxyClM7WQCRdvVotLQI6RMtbHjrxIy2kgG0Gc900ElUoV6yb"
    ></stripe-buy-button>
  </section>
<script>
let userId=localStorage.getItem('userId');
let plan=localStorage.getItem('plan');
// Default to the local API when developing on localhost or from the file system.
// Otherwise, talk to the same origin that served this page so hosted setups work
// without hitting the user's machine (which causes "Failed to fetch" errors).
const API_BASE=(location.hostname==='localhost'||location.hostname==='')
  ?'http://localhost:3000'
  :location.origin;

const params=new URLSearchParams(location.search);
const sessionId=params.get('session_id');
if(sessionId){
  confirmSubscription(sessionId);
}

if(userId){
  document.getElementById('prompt').style.display='block';
  document.getElementById('geminiPrompt').style.display='block';
  refreshPlan();
}

async function refreshPlan(){
  if(!userId)return;
  try{
    const res=await fetch(`${API_BASE}/plan/${userId}`);
    const data=await res.json();
    plan=data.plan;
    localStorage.setItem('plan',plan);
    if(plan==='unlimited'){
      document.getElementById('subscribe').style.display='none';
    }else{
      document.getElementById('subscribe').style.display='block';
    }
  }catch(e){
    // ignore
  }
}

async function confirmSubscription(id){
  try{
    const res=await fetch(`${API_BASE}/confirm`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({sessionId:id})
    });
    const data=await res.json();
    if(res.ok){
      userId=data.userId;
      plan=data.plan;
      localStorage.setItem('userId',userId);
      localStorage.setItem('plan',plan);
      document.getElementById('prompt').style.display='block';
      document.getElementById('geminiPrompt').style.display='block';
      await refreshPlan();
      alert('Subscription activated!');
      history.replaceState(null,'',location.pathname);
    }else{
      alert(data.error||'Subscription confirmation failed');
    }
  }catch(e){
    alert('Subscription confirmation failed: '+e.message);
  }
}
async function signup(){
  const email=document.getElementById('signupEmail').value;
  const password=document.getElementById('signupPassword').value;
  try{
    const res=await fetch(`${API_BASE}/signup`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    });
    const data=await res.json();
    if(res.ok){
      alert('Signup successful! Check your email for the payment link.');
      if(data.paymentLink){
        window.open(data.paymentLink,'_blank');
      }
    }else{
      alert(data.error||'Signup failed');
    }
  }catch(e){
    alert('Signup failed: '+e.message);
  }
}
async function login(){
  const email=document.getElementById('loginEmail').value;
  const password=document.getElementById('loginPassword').value;
  try{
    const res=await fetch(`${API_BASE}/login`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    });
    const data=await res.json();
    if(res.ok&&data.id){
      userId=data.id;
      plan=data.plan;
      localStorage.setItem('userId',userId);
      localStorage.setItem('plan',plan);
      document.getElementById('prompt').style.display='block';
      document.getElementById('geminiPrompt').style.display='block';
      await refreshPlan();
      alert(`Logged in as ${data.plan} user.`);
    }else{
      alert(data.error||'Login failed');
    }
  }catch(e){
    alert('Login failed: '+e.message);
  }
}
async function sendPrompt(){
  const prompt=document.getElementById('promptText').value;
  const res=await fetch(`${API_BASE}/prompt`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({userId,prompt})
  });
  const data=await res.json();
  document.getElementById('promptResponse').textContent=JSON.stringify(data);
}
async function sendGemini(){
  const prompt=document.getElementById('geminiPromptText').value;
  const res=await fetch(`${API_BASE}/gemini`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({userId,prompt})
  });
  const data=await res.json();
  document.getElementById('geminiPromptResponse').textContent=JSON.stringify(data);
}
</script>
</body>
</html>
